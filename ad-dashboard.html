<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å‘Šç›‘æ§ä»ªè¡¨æ¿</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric { text-align: center; }
        .metric-value { font-size: 2em; font-weight: bold; color: #2563eb; margin-bottom: 5px; }
        .metric-label { color: #6b7280; font-size: 0.9em; }
        .chart { height: 200px; background: #f9fafb; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #6b7280; }
        .btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .status-good { color: #059669; }
        .status-warning { color: #d97706; }
        .status-error { color: #dc2626; }
        .recommendations { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 4px; padding: 15px; margin: 10px 0; }
        .recommendation { margin: 5px 0; padding: 5px 0; border-bottom: 1px solid #fbbf24; }
        .recommendation:last-child { border-bottom: none; }
        .priority-high { border-left: 4px solid #dc2626; padding-left: 10px; }
        .priority-medium { border-left: 4px solid #d97706; padding-left: 10px; }
        .priority-low { border-left: 4px solid #059669; padding-left: 10px; }
        .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .table th, .table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; }
        .refresh-btn { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å¹¿å‘Šç›‘æ§ä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ç›‘æ§å¹¿å‘Šè¡¨ç°å’Œæ”¶ç›Šæ•°æ®</p>
            <button class="btn refresh-btn" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>

        <div class="grid">
            <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
            <div class="card metric">
                <div class="metric-value" id="totalImpressions">0</div>
                <div class="metric-label">æ€»å±•ç¤ºæ¬¡æ•°</div>
            </div>
            <div class="card metric">
                <div class="metric-value" id="totalClicks">0</div>
                <div class="metric-label">æ€»ç‚¹å‡»æ¬¡æ•°</div>
            </div>
            <div class="card metric">
                <div class="metric-value" id="clickRate">0%</div>
                <div class="metric-label">ç‚¹å‡»ç‡</div>
            </div>
            <div class="card metric">
                <div class="metric-value" id="totalRevenue">$0.00</div>
                <div class="metric-label">æ€»æ”¶ç›Š</div>
            </div>
        </div>

        <div class="grid">
            <!-- å¹¿å‘Šç±»å‹åˆ†å¸ƒ -->
            <div class="card">
                <h3>ğŸ“ˆ å¹¿å‘Šç±»å‹åˆ†å¸ƒ</h3>
                <div class="chart" id="adTypeChart">
                    <div>åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æ€§èƒ½æŒ‡æ ‡ -->
            <div class="card">
                <h3>âš¡ æ€§èƒ½æŒ‡æ ‡</h3>
                <div class="table">
                    <tr>
                        <td>å¹³å‡åŠ è½½æ—¶é—´</td>
                        <td id="avgLoadTime">-</td>
                    </tr>
                    <tr>
                        <td>å¡«å……ç‡</td>
                        <td id="fillRate">-</td>
                    </tr>
                    <tr>
                        <td>é”™è¯¯ç‡</td>
                        <td id="errorRate">-</td>
                    </tr>
                </div>
            </div>
        </div>

        <!-- ä¼˜åŒ–å»ºè®® -->
        <div class="card">
            <h3>ğŸ¯ ä¼˜åŒ–å»ºè®®</h3>
            <div id="recommendations">
                <div class="recommendations">
                    <p>æ­£åœ¨åˆ†ææ•°æ®...</p>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="card">
            <h3>ğŸ“‹ è¯¦ç»†æ•°æ®</h3>
            <div style="margin-bottom: 10px;">
                <button class="btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-secondary" onclick="resetData()">ğŸ—‘ï¸ é‡ç½®æ•°æ®</button>
                <button class="btn btn-secondary" onclick="autoOptimize()">ğŸš€ è‡ªåŠ¨ä¼˜åŒ–</button>
            </div>
            <table class="table" id="dataTable">
                <thead>
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th>æ•°å€¼</th>
                        <th>çŠ¶æ€</th>
                        <th>å»ºè®®</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr><td colspan="4">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="ad-config.js"></script>
    <script src="ad-analytics.js"></script>
    <script src="ad-optimizer.js"></script>
    
    <script>
        // åˆ·æ–°ä»ªè¡¨æ¿
        function refreshDashboard() {
            if (!window.adAnalytics) {
                console.error('AdAnalytics not loaded');
                return;
            }

            const report = window.adAnalytics.getReport();
            updateMetrics(report);
            updateRecommendations();
            updateDataTable();
        }

        // æ›´æ–°æŒ‡æ ‡
        function updateMetrics(report) {
            document.getElementById('totalImpressions').textContent = report.summary.totalImpressions;
            document.getElementById('totalClicks').textContent = report.summary.totalClicks;
            document.getElementById('clickRate').textContent = report.summary.clickRate;
            document.getElementById('totalRevenue').textContent = `$${report.summary.totalRevenue.toFixed(2)}`;
            
            // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
            document.getElementById('avgLoadTime').textContent = `${report.summary.avgLoadTime}ms`;
            
            const fillRate = 100 - parseFloat(report.summary.fallbackRate);
            document.getElementById('fillRate').textContent = `${fillRate.toFixed(1)}%`;
            
            const errorRate = report.breakdown.errors / report.summary.totalImpressions * 100;
            document.getElementById('errorRate').textContent = `${errorRate.toFixed(1)}%`;
            
            // æ›´æ–°å¹¿å‘Šç±»å‹å›¾è¡¨
            updateAdTypeChart(report.breakdown.adTypes);
        }

        // æ›´æ–°å¹¿å‘Šç±»å‹å›¾è¡¨
        function updateAdTypeChart(adTypes) {
            const chart = document.getElementById('adTypeChart');
            const total = adTypes.adsense + adTypes.fallback;
            
            if (total === 0) {
                chart.innerHTML = '<div>æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const adsensePercent = (adTypes.adsense / total * 100).toFixed(1);
            const fallbackPercent = (adTypes.fallback / total * 100).toFixed(1);
            
            chart.innerHTML = `
                <div style="width: 100%; text-align: center;">
                    <div style="margin-bottom: 10px;">
                        <span style="color: #2563eb;">AdSense: ${adsensePercent}%</span>
                    </div>
                    <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: #2563eb; height: 100%; width: ${adsensePercent}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 10px;">
                        <span style="color: #6b7280;">Fallback: ${fallbackPercent}%</span>
                    </div>
                </div>
            `;
        }

        // æ›´æ–°ä¼˜åŒ–å»ºè®®
        function updateRecommendations() {
            if (!window.adOptimizer) {
                document.getElementById('recommendations').innerHTML = '<div class="recommendations"><p>ä¼˜åŒ–å™¨æœªåŠ è½½</p></div>';
                return;
            }

            const analysis = window.adOptimizer.analyzePerformance();
            if (!analysis || !analysis.recommendations.length) {
                document.getElementById('recommendations').innerHTML = '<div class="recommendations"><p>æš‚æ— ä¼˜åŒ–å»ºè®®</p></div>';
                return;
            }

            const recommendationsHtml = analysis.recommendations.map(rec => `
                <div class="recommendation priority-${rec.priority}">
                    <strong>${rec.message}</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        ${rec.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                    </ul>
                </div>
            `).join('');

            document.getElementById('recommendations').innerHTML = recommendationsHtml;
        }

        // æ›´æ–°æ•°æ®è¡¨æ ¼
        function updateDataTable() {
            if (!window.adAnalytics) return;

            const report = window.adAnalytics.getReport();
            const tbody = document.getElementById('dataTableBody');
            
            const data = [
                { metric: 'æ€»å±•ç¤ºæ¬¡æ•°', value: report.summary.totalImpressions, status: 'good', suggestion: 'æ­£å¸¸' },
                { metric: 'æ€»ç‚¹å‡»æ¬¡æ•°', value: report.summary.totalClicks, status: 'good', suggestion: 'æ­£å¸¸' },
                { metric: 'ç‚¹å‡»ç‡', value: report.summary.clickRate, status: parseFloat(report.summary.clickRate) > 2 ? 'good' : 'warning', suggestion: parseFloat(report.summary.clickRate) > 2 ? 'è‰¯å¥½' : 'éœ€è¦ä¼˜åŒ–' },
                { metric: 'å¡«å……ç‡', value: `${(100 - parseFloat(report.summary.fallbackRate)).toFixed(1)}%`, status: parseFloat(report.summary.fallbackRate) < 20 ? 'good' : 'warning', suggestion: parseFloat(report.summary.fallbackRate) < 20 ? 'è‰¯å¥½' : 'éœ€è¦ä¼˜åŒ–' },
                { metric: 'å¹³å‡åŠ è½½æ—¶é—´', value: `${report.summary.avgLoadTime}ms`, status: parseFloat(report.summary.avgLoadTime) < 3000 ? 'good' : 'warning', suggestion: parseFloat(report.summary.avgLoadTime) < 3000 ? 'è‰¯å¥½' : 'éœ€è¦ä¼˜åŒ–' },
                { metric: 'æ€»æ”¶ç›Š', value: `$${report.summary.totalRevenue.toFixed(2)}`, status: 'good', suggestion: 'æ­£å¸¸' }
            ];

            tbody.innerHTML = data.map(row => `
                <tr>
                    <td>${row.metric}</td>
                    <td>${row.value}</td>
                    <td class="status-${row.status}">${row.status === 'good' ? 'âœ…' : row.status === 'warning' ? 'âš ï¸' : 'âŒ'}</td>
                    <td>${row.suggestion}</td>
                </tr>
            `).join('');
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (window.adAnalytics) {
                window.adAnalytics.exportData();
            }
        }

        // é‡ç½®æ•°æ®
        function resetData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                if (window.adAnalytics) {
                    window.adAnalytics.reset();
                    refreshDashboard();
                }
            }
        }

        // è‡ªåŠ¨ä¼˜åŒ–
        function autoOptimize() {
            if (window.adOptimizer) {
                window.adOptimizer.autoOptimize();
                alert('è‡ªåŠ¨ä¼˜åŒ–å·²åº”ç”¨ï¼');
                refreshDashboard();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(refreshDashboard, 1000); // ç­‰å¾…è„šæœ¬åŠ è½½
        });

        // å®šæœŸåˆ·æ–°
        setInterval(refreshDashboard, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>
