<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdSense 诊断页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .diagnosis-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f9fafb;
        }
        .diagnosis-item h3 {
            margin: 0 0 10px;
            color: #374151;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.pass {
            background: #d1fae5;
            color: #065f46;
        }
        .status.fail {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 AdSense 诊断页面</h1>
        <p>这个页面会诊断为什么广告没有显示，并提供解决方案。</p>
        
        <button class="btn" onclick="runDiagnosis()">开始诊断</button>
        <button class="btn" onclick="clearResults()">清空结果</button>
        
        <div id="diagnosis-results"></div>
    </div>

    <!-- 加载广告配置和脚本 -->
    <script src="ad-config.js"></script>
    <script src="ads-manager.js"></script>
    
    <script>
        function runDiagnosis() {
            const resultsDiv = document.getElementById('diagnosis-results');
            resultsDiv.innerHTML = '<h2>🔍 诊断结果</h2>';
            
            // 诊断项目
            const diagnoses = [
                {
                    name: 'AdSense 脚本加载',
                    test: () => typeof adsbygoogle !== 'undefined',
                    message: 'AdSense 脚本已正确加载',
                    failMessage: 'AdSense 脚本未加载，请检查网络连接'
                },
                {
                    name: '广告配置对象',
                    test: () => typeof window.AD_CONFIG !== 'undefined',
                    message: '广告配置对象存在',
                    failMessage: '广告配置对象不存在，请检查 ad-config.js'
                },
                {
                    name: '广告管理器',
                    test: () => typeof window.adManager !== 'undefined',
                    message: '广告管理器已初始化',
                    failMessage: '广告管理器未初始化，请检查 ads-manager.js'
                },
                {
                    name: '广告启用状态',
                    test: () => window.AD_CONFIG?.googleAdsense?.enabled === true,
                    message: '广告功能已启用',
                    failMessage: '广告功能未启用'
                },
                {
                    name: '发布商 ID',
                    test: () => {
                        const publisherId = window.AD_CONFIG?.googleAdsense?.publisherId;
                        return publisherId && publisherId.startsWith('ca-pub-') && publisherId.length > 10;
                    },
                    message: '发布商 ID 格式正确',
                    failMessage: '发布商 ID 格式错误或缺失'
                },
                {
                    name: 'Slot ID 配置',
                    test: () => {
                        const slotIds = window.AD_CONFIG?.googleAdsense?.adSlots;
                        if (!slotIds) return false;
                        
                        const hasRealSlotIds = Object.values(slotIds).some(slot => 
                            slot.slotId && 
                            slot.slotId !== '1234567890' && 
                            slot.slotId !== '1234567891' && 
                            slot.slotId !== '1234567892' && 
                            slot.slotId !== '1234567893' &&
                            !slot.slotId.startsWith('TEST_')
                        );
                        return hasRealSlotIds;
                    },
                    message: 'Slot ID 已配置为真实值',
                    failMessage: 'Slot ID 仍为占位符，需要替换为真实的 AdSense Slot ID'
                },
                {
                    name: '用户同意状态',
                    test: () => {
                        const consent = localStorage.getItem('adsConsent');
                        return consent === 'accepted';
                    },
                    message: '用户已同意显示广告',
                    failMessage: '用户未同意显示广告，需要显示同意条'
                },
                {
                    name: '域名授权',
                    test: () => {
                        // 这个无法在前端直接检测，只能提示
                        return 'unknown';
                    },
                    message: '无法检测，请手动检查 AdSense 后台',
                    failMessage: '请检查 AdSense 后台域名授权状态'
                }
            ];
            
            diagnoses.forEach(diagnosis => {
                const result = diagnosis.test();
                const status = result === true ? 'pass' : (result === 'unknown' ? 'warning' : 'fail');
                const statusText = result === true ? '✅ 通过' : (result === 'unknown' ? '⚠️ 未知' : '❌ 失败');
                
                resultsDiv.innerHTML += `
                    <div class="diagnosis-item">
                        <h3>${diagnosis.name} <span class="status ${status}">${statusText}</span></h3>
                        <p>${result === true ? diagnosis.message : diagnosis.failMessage}</p>
                    </div>
                `;
            });
            
            // 添加解决方案
            resultsDiv.innerHTML += `
                <div class="diagnosis-item">
                    <h3>💡 解决方案</h3>
                    <ol>
                        <li><strong>如果 Slot ID 为占位符：</strong>
                            <div class="code-block">
// 在 AdSense 后台创建广告单元，然后更新配置：
window.AD_CONFIG.googleAdsense.adSlots.video.slotId = '你的真实Slot ID';
                            </div>
                        </li>
                        <li><strong>如果用户未同意：</strong>
                            <div class="code-block">
// 清除同意状态，重新显示同意条：
localStorage.removeItem('adsConsent');
window.adManager.setupConsent();
                            </div>
                        </li>
                        <li><strong>如果 AdSense 脚本未加载：</strong>
                            <div class="code-block">
// 检查网络连接和 AdSense 脚本 URL
// 确保没有广告拦截器
                            </div>
                        </li>
                        <li><strong>测试 Fallback 功能：</strong>
                            <div class="code-block">
// 即使 AdSense 不可用，fallback 插屏也会显示：
window.adManager.createVideoAd();
                            </div>
                        </li>
                    </ol>
                </div>
            `;
            
            // 添加快速修复按钮
            resultsDiv.innerHTML += `
                <div class="diagnosis-item">
                    <h3>🔧 快速修复</h3>
                    <button class="btn" onclick="clearConsent()">清除同意状态</button>
                    <button class="btn" onclick="testFallback()">测试 Fallback</button>
                    <button class="btn" onclick="showConsent()">显示同意条</button>
                </div>
            `;
        }
        
        function clearResults() {
            document.getElementById('diagnosis-results').innerHTML = '';
        }
        
        function clearConsent() {
            localStorage.removeItem('adsConsent');
            alert('同意状态已清除，刷新页面会重新显示同意条');
        }
        
        function testFallback() {
            if (window.adManager) {
                window.adManager.showFallbackInterstitial(() => {
                    console.log('Fallback 测试完成');
                });
            } else {
                alert('广告管理器未加载');
            }
        }
        
        function showConsent() {
            if (window.adManager) {
                localStorage.removeItem('adsConsent');
                window.adManager.setupConsent(() => {
                    console.log('同意条已显示');
                });
            } else {
                alert('广告管理器未加载');
            }
        }
        
        // 页面加载完成后自动运行诊断
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runDiagnosis, 1000);
        });
    </script>
</body>
</html>
