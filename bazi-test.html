<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—Ã—MBTIÃ—æ•°å­—å‘½ç† äººæ ¼æ·±åº¦è§£æ</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #111827;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
        .header { text-align: center; color: #fff; margin: 24px 0; }
        .header h1 { margin: 0 0 8px; font-size: 30px; }
        .card { background: rgba(255,255,255,0.98); border-radius: 16px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); margin-bottom: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 16px; }
        .btn { display:inline-block; background: linear-gradient(135deg, #0ea5e9, #6366f1); color:#fff; border:none; padding:10px 18px; border-radius:999px; cursor:pointer; font-weight:600; }
        .btn:hover { transform: translateY(-1px); }
        .btn-secondary { background: linear-gradient(135deg, #94a3b8, #64748b); color:#fff; }
        .muted { color:#6b7280; font-size:14px; }
        label { font-weight:600; display:block; margin:8px 0 6px; }
        input, select { width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
        .pill { display:inline-block; padding:6px 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px; }
        .kpi { font-size: 28px; font-weight:800; color:#4f46e5; }
        .q { border: 1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:12px; }
        .opt { margin:6px 0; }
        .opt input { width:auto; margin-right:6px; }
        .result { margin-top: 10px; padding: 12px 14px; border-left: 4px solid #10b981; background: #ecfdf5; color: #065f46; border-radius: 10px; }
        a.link { color: #4f46e5; text-decoration: none; font-weight: 600; }
        .section-title { margin: 0 0 10px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .mbti-dimension { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
        .bazi-insight { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #3b82f6; }
        .integration { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 4px solid #16a34a; }
        .numerology { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border-left: 4px solid #9333ea; }
        .hidden { display: none; }
        
        .feature-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }
        
        .feature-status.coming-soon {
            background: #fef3c7;
            color: #92400e;
        }
        
        .feature-status.ready {
            background: #d1fae5;
            color: #065f46;
        }
        .tab-container { display: flex; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.1); }
        .tab { flex: 1; padding: 12px; text-align: center; background: rgba(255,255,255,0.2); color: #fff; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: rgba(255,255,255,0.9); color: #111827; }
        .tab:hover { background: rgba(255,255,255,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Utility bar */
        /* utility/share removed by request */
        
        /* è¯­è¨€åˆ‡æ¢å™¨æ ·å¼å·²åˆ é™¤ */
    </style>
    
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ§  å…«å­—Ã—MBTIÃ—æ•°å­—å‘½ç† äººæ ¼æ·±åº¦è§£æ</h1>
            <p class="muted">ç»“åˆä¼ ç»Ÿå‘½ç†å­¦ã€MBTIç†è®ºä¸ç°ä»£æ•°å­—å‘½ç†å­¦ï¼Œæ¢ç´¢ä½ çš„æ€§æ ¼å¯†ç ä¸äººç”Ÿæ ¼å±€</p>
            
            <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
            <div class="language-switcher">
                <!-- è¯­è¨€åˆ‡æ¢æ ‡ç­¾å·²åˆ é™¤ -->
            </div>
            
            <!-- æµ‹è¯•æŒ‰é’® -->
            <div style="margin-top: 20px;">
                <!-- æµ‹è¯•å›½é™…åŒ–æŒ‰é’®å·²åˆ é™¤ -->
                <button class="btn" onclick="location.href='index.html'" style="background: #6b7280; margin-left: 10px;">ğŸ  è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æµ‹è¯•ç±»å‹é€‰æ‹© -->


        <!-- å…«å­—Ã—MBTI æµ‹è¯•å†…å®¹ -->
        <div id="bazi-content" class="tab-content active">
            <!-- åŸºç¡€ä¿¡æ¯è¾“å…¥ -->
            <div class="card">
                <div class="grid">
                    <div>
                        <h3 class="section-title">åŸºç¡€ä¿¡æ¯</h3>
                        <label for="bDate">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="bDate" />
                        <label for="bTime">å‡ºç”Ÿæ—¶é—´ï¼ˆ24å°æ—¶åˆ¶ï¼‰</label>
                        <input type="time" id="bTime" value="12:00" />
                        <label for="tz">æ—¶åŒº</label>
                        <select id="tz">
                            <option value="8" selected>ä¸œå…«åŒºï¼ˆä¸­å›½å¤§é™†/æ¸¯æ¾³å°ï¼‰UTC+8</option>
                            <option value="7">UTC+7</option>
                            <option value="9">UTC+9</option>
                            <option value="0">UTCÂ±0</option>
                        </select>
                        <div style="margin-top:12px">
                            <button class="btn" type="button" onclick="analyzePersonality()">å¼€å§‹åˆ†æ</button>
                            <button class="btn btn-secondary" type="button" onclick="location.href='index.html'" style="margin-left:8px">è¿”å›é¦–é¡µ</button>
                        </div>
                        <p class="muted" style="margin-top:8px">åŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ã€Šä¸‰å‘½é€šä¼šã€‹ç­‰ç»å…¸å‘½ç†è‘—ä½œï¼Œç»“åˆMBTIç†è®ºè¿›è¡Œäººæ ¼æ·±åº¦è§£æã€‚</p>
                    </div>
                    <div>
                        <h3 class="section-title">å…«å­—åŸºç¡€</h3>
                        <div class="pill">å››æŸ±</div>
                        <div class="kpi mono" id="pillars">â€” â€”ï½œâ€” â€”ï½œâ€” â€”ï½œâ€” â€”</div>
                        <div class="muted" id="stemsBranches"></div>
                        <div style="height:10px"></div>
                        <div class="pill">äº”è¡Œç»Ÿè®¡</div>
                        <div id="wuxing" class="grid" style="grid-template-columns: repeat(5,1fr); gap:8px; margin-top:8px"></div>
                        <div id="calcStatus" class="result hidden" style="margin-top:10px"></div>
                    </div>
                </div>
            </div>

            <!-- MBTIç»´åº¦åˆ†æ -->
            <div class="card hidden" id="mbtiAnalysis">
                <h3 class="section-title">ğŸ§  MBTI å››ç»´åº¦åˆ†æ</h3>
                <div class="grid">
                    <div class="card mbti-dimension">
                        <div class="pill">å¤–å‘ E / å†…å‘ I</div>
                        <div id="eiAnalysis" class="muted"></div>
                    </div>
                    <div class="card mbti-dimension">
                        <div class="pill">æ„Ÿè§‰ S / ç›´è§‰ N</div>
                        <div id="snAnalysis" class="muted"></div>
                    </div>
                    <div class="card mbti-dimension">
                        <div class="pill">æ€è€ƒ T / æƒ…æ„Ÿ F</div>
                        <div id="tfAnalysis" class="muted"></div>
                    </div>
                    <div class="card mbti-dimension">
                        <div class="pill">åˆ¤æ–­ J / æ„ŸçŸ¥ P</div>
                        <div id="jpAnalysis" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- å…«å­—å‘½ç†è§£æ -->
            <div class="card hidden" id="baziAnalysis">
                <h3 class="section-title">ğŸ“… å…«å­—å‘½ç†è§£æ</h3>
                <div class="grid">
                    <div class="card bazi-insight">
                        <div class="pill">æ—¥ä¸»å¼ºå¼±</div>
                        <div id="dayMasterStrength" class="muted"></div>
                    </div>
                    <div class="card bazi-insight">
                        <div class="pill">åç¥é…ç½®</div>
                        <div id="tenGods" class="muted"></div>
                    </div>
                    <div class="card bazi-insight">
                        <div class="pill">äº”è¡Œè°ƒå€™</div>
                        <div id="regulation" class="muted"></div>
                    </div>
                    <div class="card bazi-insight">
                        <div class="pill">æ ¼å±€ç‰¹å¾</div>
                        <div id="pattern" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- å…«å­—Ã—MBTI èåˆè§£æ -->
            <div class="card hidden" id="integrationAnalysis">
                <h3 class="section-title">ğŸŒŸ å…«å­—Ã—MBTI èåˆè§£æ</h3>
                <div class="card integration" style="margin-bottom:12px">
                    <div class="pill">èåˆMBTIç±»å‹</div>
                    <div id="fusionInlineType" class="kpi" style="font-size:22px; margin-top:6px"></div>
                    <div id="fusionInlineBias" class="muted" style="margin-top:4px"></div>
                </div>
                <div class="grid">
                    <div class="card integration">
                        <div class="pill">æ€§æ ¼æ ¹åŸº</div>
                        <div id="personalityFoundation" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">å‘å±•è·¯å¾„</div>
                        <div id="developmentPath" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">æ½œåœ¨æŒ‘æˆ˜</div>
                        <div id="potentialChallenges" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">äººç”Ÿå»ºè®®</div>
                        <div id="lifeAdvice" class="muted"></div>
                    </div>
                </div>
                <div class="card integration" style="margin-top:12px">
                    <div class="pill">èåˆç±»å‹è¯¦è§£</div>
                    <div id="fusionDetail" class="muted" style="margin-top:6px"></div>
                </div>
            </div>

            <!-- èåˆæµ‹è¯„ï¼ˆè‡ªé€‚åº”å‡ºé¢˜ï¼‰ -->
            <div class="card hidden" id="fusionTest">
                <h3 class="section-title">ğŸ§© å…«å­—Ã—MBTI èåˆæµ‹è¯„</h3>
                <div id="fusionQuiz"></div>
                <div style="margin-top:10px">
                    <button class="btn" type="button" onclick="submitFusion()">æäº¤èåˆæµ‹è¯„</button>
                    <span id="fusionResult" class="pill" style="margin-left:10px"></span>
                </div>
            </div>
        </div>

        <!-- æ•°å­—å‘½ç†Ã—MBTI æµ‹è¯•å†…å®¹ -->
        <div id="numerology-content" class="tab-content">
            <div class="card">
                <h3 class="section-title">ğŸ”¢ æ•°å­—å‘½ç†Ã—MBTI æµ‹è¯•</h3>
                <p class="muted">åŸºäºã€Šæ•°å­—å‘½ç†å­¦ï¼šåŸºäºæ•°å­—çš„è‡ªæˆ‘å‘ç°æŒ‡å—ã€‹ã€Šç”Ÿå‘½æ•°å­—ï¼šæ­ç¤ºä½ çš„ç”Ÿå‘½è“å›¾ã€‹ç­‰ç»å…¸è‘—ä½œ</p>
                
                <!-- å¼ºåˆ¶æ˜¾ç¤ºæµ‹è¯•æŒ‰é’® -->
                <div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin: 0 0 10px 0; color: #92400e;">ğŸ§ª è°ƒè¯•ä¿¡æ¯</h4>
                    <p style="margin: 0 0 10px 0; color: #92400e;">å¦‚æœä½ èƒ½çœ‹åˆ°è¿™ä¸ªåŒºåŸŸï¼Œè¯´æ˜æ•°å­—å‘½ç†å†…å®¹å·²ç»åŠ è½½æˆåŠŸï¼</p>
                    <button class="btn" onclick="forceShowNumerology()" style="background: #f59e0b;">ğŸ” å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰å†…å®¹</button>
                    <button class="btn" onclick="testNumerologyFunctions()" style="background: #dc2626; margin-left: 10px;">ğŸ§ª æµ‹è¯•å‡½æ•°</button>
                </div>
                
                <div class="grid">
                    <div>
                        <label for="nDate">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="nDate" />
                        <label for="nName">å§“åï¼ˆä¸­æ–‡ï¼‰</label>
                        <input type="text" id="nName" placeholder="è¯·è¾“å…¥ä¸­æ–‡å§“å" />
                        <div style="margin-top:12px">
                            <button class="btn" type="button" onclick="analyzeNumerology()">å¼€å§‹æ•°å­—å‘½ç†åˆ†æ</button>
                        </div>
                    </div>
                    <div>
                        <h4>ç”Ÿå‘½æ•°å­—åŸºç¡€</h4>
                        <div class="pill">ç”Ÿå‘½æ•°å­—</div>
                        <div class="kpi mono" id="lifeNumber">â€”</div>
                        <div class="pill">å‘½è¿æ•°å­—</div>
                        <div class="kpi mono" id="destinyNumber">â€”</div>
                        <div class="pill">çµé­‚æ•°å­—</div>
                        <div class="kpi mono" id="soulNumber">â€”</div>
                    </div>
                </div>
            </div>

            <!-- æ•°å­—å‘½ç†è§£æç»“æœ -->
            <div class="card hidden" id="numerologyAnalysis">
                <h3 class="section-title">ğŸ”¢ æ•°å­—å‘½ç†è§£æ</h3>
                <div class="grid">
                    <div class="card numerology">
                        <div class="pill">ç”Ÿå‘½æ•°å­—ç‰¹è´¨</div>
                        <div id="lifeNumberTraits" class="muted"></div>
                    </div>
                    <div class="card numerology">
                        <div class="pill">å‘½è¿æ•°å­—æŒ‡å¼•</div>
                        <div id="destinyNumberGuidance" class="muted"></div>
                    </div>
                    <div class="card numerology">
                        <div class="pill">çµé­‚æ•°å­—å†…æ¶µ</div>
                        <div id="soulNumberMeaning" class="muted"></div>
                    </div>
                    <div class="card numerology">
                        <div class="pill">æ•°å­—ç»„åˆåˆ†æ</div>
                        <div id="numberCombination" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- æ•°å­—å‘½ç†Ã—MBTI èåˆåˆ†æ -->
            <div class="card hidden" id="numerologyMBTIAnalysis">
                <h3 class="section-title">ğŸŒŸ æ•°å­—å‘½ç†Ã—MBTI èåˆåˆ†æ</h3>
                <div class="grid">
                    <div class="card integration">
                        <div class="pill">æ•°å­—-MBTIæ˜ å°„</div>
                        <div id="numberMBTIMapping" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">æ€§æ ¼ä¼˜åŠ¿</div>
                        <div id="numerologyStrengths" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">å‘å±•å»ºè®®</div>
                        <div id="numerologyAdvice" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">èŒä¸šé€‚é…</div>
                        <div id="numerologyCareer" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- æ•°å­—å‘½ç†æµ‹è¯•é¢˜ -->
            <div class="card hidden" id="numerologyTest">
                <h3 class="section-title">ğŸ§© æ•°å­—å‘½ç†Ã—MBTI èåˆæµ‹è¯„</h3>
                <div id="numerologyQuiz"></div>
                <div style="margin-top:10px">
                    <button class="btn" type="button" onclick="submitNumerologyTest()">æäº¤æ•°å­—å‘½ç†æµ‹è¯„</button>
                    <span id="numerologyResult" class="pill" style="margin-left:10px"></span>
                </div>
            </div>
        </div>

        <!-- ä¸‰åˆä¸€èåˆæµ‹è¯•å†…å®¹ -->
        <div id="fusion-content" class="tab-content">
            <div class="card">
                <h3 class="section-title">ğŸŒŸ ä¸‰åˆä¸€èåˆæµ‹è¯•</h3>
                <p class="muted">ç»“åˆå…«å­—ã€MBTIã€æ•°å­—å‘½ç†ä¸‰å¤§ä½“ç³»ï¼Œè¿›è¡Œå…¨æ–¹ä½äººæ ¼è§£æ</p>
                
                <div class="grid">
                    <div>
                        <h4>åŸºç¡€ä¿¡æ¯</h4>
                        <label for="fDate">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="fDate" />
                        <label for="fTime">å‡ºç”Ÿæ—¶é—´</label>
                        <input type="time" id="fTime" value="12:00" />
                        <label for="fName">å§“å</label>
                        <input type="text" id="fName" placeholder="è¯·è¾“å…¥ä¸­æ–‡å§“å" />
                        <div style="margin-top:12px">
                            <button class="btn" type="button" onclick="runTripleAnalysis()">å¼€å§‹ä¸‰åˆä¸€åˆ†æ</button>
                        </div>
                    </div>
                    <div>
                        <h4>åˆ†æä½“ç³»</h4>
                        <div class="pill">å…«å­—å‘½ç†</div>
                        <div class="muted">ä¼ ç»Ÿå‘½ç†å­¦åˆ†æ</div>
                        <div class="pill">MBTIç†è®º</div>
                        <div class="muted">ç°ä»£å¿ƒç†å­¦åˆ†æ</div>
                        <div class="pill">æ•°å­—å‘½ç†</div>
                        <div class="muted">æ•°å­—èƒ½é‡å­¦åˆ†æ</div>
                    </div>
                </div>
            </div>

            <!-- ä¸‰åˆä¸€åˆ†æç»“æœ -->
            <div class="card hidden" id="tripleAnalysisResult">
                <h3 class="section-title">ğŸŒŸ ä¸‰åˆä¸€èåˆè§£æç»“æœ</h3>
                <div class="card integration" style="margin-bottom:12px">
                    <div class="pill">ç»¼åˆMBTIç±»å‹</div>
                    <div id="tripleMBTIType" class="kpi" style="font-size:22px; margin-top:6px"></div>
                    <div id="tripleConfidence" class="muted" style="margin-top:4px"></div>
                </div>
                <div class="grid">
                    <div class="card integration">
                        <div class="pill">å…«å­—ç‰¹å¾</div>
                        <div id="tripleBaziTraits" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">æ•°å­—èƒ½é‡</div>
                        <div id="tripleNumberEnergy" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">MBTIå€¾å‘</div>
                        <div id="tripleMBTITendency" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">èåˆå»ºè®®</div>
                        <div id="tripleAdvice" class="muted"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¤©å¹²åœ°æ”¯äº”è¡Œæ˜ å°„
        const STEM_TO_WUXING = { 'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´' };
        const BRANCH_TO_WUXING = { 'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´' };
        const STEM_POLARITY = { 'ç”²':'é˜³','ä¹™':'é˜´','ä¸™':'é˜³','ä¸':'é˜´','æˆŠ':'é˜³','å·±':'é˜´','åºš':'é˜³','è¾›':'é˜´','å£¬':'é˜³','ç™¸':'é˜´' };
        const SHENG = { 'æœ¨':'ç«', 'ç«':'åœŸ', 'åœŸ':'é‡‘', 'é‡‘':'æ°´', 'æ°´':'æœ¨' }; // ç”Ÿ
        const KE   = { 'æœ¨':'åœŸ', 'åœŸ':'æ°´', 'æ°´':'ç«', 'ç«':'é‡‘', 'é‡‘':'æœ¨' }; // å…‹

        // æ•°å­—å‘½ç†æ˜ å°„
        const NUMBER_MEANINGS = {
            1: { traits: 'é¢†å¯¼åŠ›ã€ç‹¬ç«‹æ€§ã€åˆ›æ–°æ€§', mbti: 'ENTJ,ENTP,INTJ', element: 'ç«', career: 'ä¼ä¸šå®¶ã€é¢†å¯¼ã€åˆ›æ–°è€…' },
            2: { traits: 'åˆä½œæ€§ã€æ•æ„Ÿæ€§ã€å’Œè°æ€§', mbti: 'INFJ,INFP,ENFJ', element: 'æ°´', career: 'å’¨è¯¢å¸ˆã€åè°ƒè€…ã€è‰ºæœ¯å®¶' },
            3: { traits: 'è¡¨è¾¾æ€§ã€åˆ›é€ æ€§ã€ä¹è§‚æ€§', mbti: 'ENFP,ESFP,ENTP', element: 'æœ¨', career: 'åˆ›æ„å·¥ä½œè€…ã€è¡¨æ¼”è€…ã€æ•™å¸ˆ' },
            4: { traits: 'ç¨³å®šæ€§ã€å®ç”¨æ€§ã€ç»„ç»‡æ€§', mbti: 'ISTJ,ESTJ,ISFJ', element: 'åœŸ', career: 'ç®¡ç†è€…ã€å·¥ç¨‹å¸ˆã€ä¼šè®¡å¸ˆ' },
            5: { traits: 'è‡ªç”±æ€§ã€å†’é™©æ€§ã€é€‚åº”æ€§', mbti: 'ESTP,ISTP,ENFP', element: 'æ°´', career: 'æ¢é™©å®¶ã€é”€å”®å‘˜ã€è®°è€…' },
            6: { traits: 'è´£ä»»æ„Ÿã€å…³çˆ±æ€§ã€å¹³è¡¡æ€§', mbti: 'ISFJ,ESFJ,INFJ', element: 'åœŸ', career: 'æŠ¤ç†å¸ˆã€æ•™å¸ˆã€ç¤¾å·¥' },
            7: { traits: 'åˆ†ææ€§ã€ç²¾ç¥æ€§ã€ç¥ç§˜æ€§', mbti: 'INTP,INTJ,INFJ', element: 'é‡‘', career: 'ç§‘å­¦å®¶ã€å“²å­¦å®¶ã€åˆ†æå¸ˆ' },
            8: { traits: 'æƒåŠ›æ€§ã€ç‰©è´¨æ€§ã€æˆå°±æ€§', mbti: 'ENTJ,ESTJ,ISTJ', element: 'é‡‘', career: 'ä¼ä¸šå®¶ã€é«˜ç®¡ã€æ”¿æ²»å®¶' },
            9: { traits: 'äººé“æ€§ã€ç†æƒ³æ€§ã€æ™ºæ…§æ€§', mbti: 'INFJ,ENFJ,INFP', element: 'ç«', career: 'äººé“ä¸»ä¹‰è€…ã€è‰ºæœ¯å®¶ã€å¯¼å¸ˆ' }
        };

        // ä¸­æ–‡å§“åæ•°å­—æ˜ å°„
        const CHINESE_NAME_NUMBERS = {
            // æ•°å­—
            'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9,
            'å£¹':1, 'è´°':2, 'å':3, 'è‚†':4, 'ä¼':5, 'é™†':6, 'æŸ’':7, 'æŒ':8, 'ç–':9,
            // å¤©å¹²
            'ç”²':1, 'ä¹™':2, 'ä¸™':3, 'ä¸':4, 'æˆŠ':5, 'å·±':6, 'åºš':7, 'è¾›':8, 'å£¬':9, 'ç™¸':10,
            // åœ°æ”¯
            'å­':1, 'ä¸‘':2, 'å¯…':3, 'å¯':4, 'è¾°':5, 'å·³':6, 'åˆ':7, 'æœª':8, 'ç”³':9, 'é…‰':10, 'æˆŒ':11, 'äº¥':12,
            // äº”è¡Œ
            'æœ¨':3, 'ç«':2, 'åœŸ':5, 'é‡‘':7, 'æ°´':1,
            // å¸¸ç”¨å­—
            'ç‹':1, 'æ':2, 'å¼ ':3, 'åˆ˜':4, 'é™ˆ':5, 'æ¨':6, 'èµµ':7, 'é»„':8, 'å‘¨':9, 'å´':10,
            'å¾':1, 'å­™':2, 'èƒ¡':3, 'æœ±':4, 'é«˜':5, 'æ—':6, 'ä½•':7, 'éƒ­':8, 'é©¬':9, 'ç½—':10,
            'æ¢':1, 'å®‹':2, 'éƒ‘':3, 'è°¢':4, 'éŸ©':5, 'å”':6, 'å†¯':7, 'äº':8, 'è‘£':9, 'è§':10,
            'ç¨‹':1, 'æ›¹':2, 'è¢':3, 'é‚“':4, 'è®¸':5, 'å‚…':6, 'æ²ˆ':7, 'æ›¾':8, 'å½­':9, 'å•':10,
            'è‹':1, 'å¢':2, 'è’‹':3, 'è”¡':4, 'è´¾':5, 'ä¸':6, 'é­':7, 'è–›':8, 'å¶':9, 'é˜':10
        };

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName, event) {
            console.log('åˆ‡æ¢æ ‡ç­¾é¡µåˆ°:', tabName);
            
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
                console.log('æ˜¾ç¤ºå†…å®¹:', tabName + '-content');
            } else {
                console.error('æ‰¾ä¸åˆ°å†…å®¹å…ƒç´ :', tabName + '-content');
            }
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾é¡µ
            const targetTab = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('æ¿€æ´»æ ‡ç­¾é¡µ:', targetTab.textContent);
            }
        }

        // å¤©å¹²åœ°æ”¯äº”è¡Œæ˜ å°„
        function safeGetPillars(year, month, day, hour, minute) {
            try {
                const Solar = window.Solar || (window.Lunar && window.Lunar.Solar);
                if (!Solar) throw new Error('æ¨¡å—æœªå°±ç»ª');
                
                const tz = parseInt(document.getElementById('tz').value || '8', 10);
                const jsDate = new Date(Date.UTC(year, month - 1, day, hour - tz, minute, 0));
                const y = jsDate.getUTCFullYear();
                const m = jsDate.getUTCMonth() + 1;
                const d = jsDate.getUTCDate();
                const h = jsDate.getUTCHours();
                const mi = jsDate.getUTCMinutes();

                let solar = null;
                if (typeof Solar.fromYmdHms === 'function') {
                    solar = Solar.fromYmdHms(y, m, d, h, mi, 0);
                } else if (typeof Solar.fromDate === 'function') {
                    solar = Solar.fromDate(new Date(Date.UTC(y, m - 1, d, h, mi, 0)));
                } else {
                    throw new Error('Solar æ„é€ ä¸å¯ç”¨');
                }
                const lunar = solar.getLunar();
                const ec = lunar.getEightChar();

                const yearP = (ec.getYear && ec.getYear()) || '';
                const monthP = (ec.getMonth && ec.getMonth()) || '';
                const dayP = (ec.getDay && ec.getDay()) || '';
                const timeP = (ec.getTime && ec.getTime()) || '';
                const pillarText = (yearP && monthP && dayP && timeP) ? `${yearP}ï½œ${monthP}ï½œ${dayP}ï½œ${timeP}` : (ec.toString ? ec.toString() : 'â€” â€”ï½œâ€” â€”ï½œâ€” â€”ï½œâ€” â€”');

                const parts = pillarText.replace(/[\s]/g,'').split('ï½œ');
                const parseGanZhi = (gz) => gz && gz.length >= 2 ? [gz[0], gz.slice(1)] : ['â€”','â€”'];
                const [yG, yZ] = parseGanZhi(parts[0] || '');
                const [mG, mZ] = parseGanZhi(parts[1] || '');
                const [dG, dZ] = parseGanZhi(parts[2] || '');
                const [tG, tZ] = parseGanZhi(parts[3] || '');

                return { pillarText, stems: [yG,mG,dG,tG], branches: [yZ,mZ,dZ,tZ] };
            } catch (e) {
                console.warn('è®¡ç®—å¤±è´¥ï¼Œå°†è¿”å›å ä½ï¼š', e);
                return { pillarText: 'â€” â€”ï½œâ€” â€”ï½œâ€” â€”ï½œâ€” â€”', stems: ['â€”','â€”','â€”','â€”'], branches: ['â€”','â€”','â€”','â€”'] };
            }
        }

        let isLoading = false;

        function showStatus(msg){
            const el = document.getElementById('calcStatus');
            if (!el) return;
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideStatus(){
            const el = document.getElementById('calcStatus');
            if (!el) return;
            el.classList.add('hidden');
            el.textContent = '';
        }
        async function waitForLunar(tries = 40, intervalMs = 150){
            for (let i=0;i<tries;i++){
                if ((window.Solar && (window.Solar.fromYmdHms || window.Solar.fromDate)) ||
                    (window.Lunar && window.Lunar.Solar && (window.Lunar.Solar.fromYmdHms || window.Lunar.Solar.fromDate))) {
                    return true;
                }
                await new Promise(r=>setTimeout(r, intervalMs));
            }
            return false;
        }

        const LUNAR_SOURCES = [
            // local first
            './libs/lunar.min.js',
            // jsDelivr common paths
            'https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript/dist/lunar.min.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript/umd/lunar.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript',
            // unpkg common paths
            'https://unpkg.com/lunar-javascript/lunar.min.js',
            'https://unpkg.com/lunar-javascript/dist/lunar.min.js',
            'https://unpkg.com/lunar-javascript/umd/lunar.js',
            'https://unpkg.com/lunar-javascript'
        ];

        function loadScriptOnce(src, timeoutMs = 6000){
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                const bust = (src.startsWith('./') || src.startsWith('/')) ? (`${src}?v=${Date.now()}`) : src;
                s.src = bust;
                s.async = true;
                s.crossOrigin = 'anonymous';
                let done = false;
                const timer = setTimeout(() => { if (!done){ done = true; s.remove(); reject(new Error('timeout')); } }, timeoutMs);
                s.onload = () => { if (!done){ done = true; clearTimeout(timer); resolve(true); } };
                s.onerror = () => { if (!done){ done = true; clearTimeout(timer); reject(new Error('load error')); } };
                document.head.appendChild(s);
            });
        }

        async function loadLunarFromFallbacks(){
            for (const url of LUNAR_SOURCES){
                try {
                    showStatus(`å°è¯•åŠ è½½å‘½ç†åº“ï¼š${url}`);
                    await loadScriptOnce(url);
                    const ok = await waitForLunar(20, 100);
                    if (ok) { hideStatus(); return true; }
                } catch (e) {
                    // try next
                }
            }
            return false;
        }

        // å›½é™…åŒ–é…ç½®å·²åˆ é™¤
        
        // è¯­è¨€å˜é‡å·²åˆ é™¤
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½lunaråº“
        window.addEventListener('load', async () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // è¯­è¨€åˆå§‹åŒ–å·²åˆ é™¤
            
            // åŠ è½½lunaråº“
            try {
                const loaded = await loadLunarFromFallbacks();
                if (loaded) {
                    console.log('âœ… lunaråº“åŠ è½½æˆåŠŸ');
                } else {
                    console.error('âŒ lunaråº“åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½lunaråº“æ—¶å‡ºé”™:', error);
            }
        });
        
        // è¯­è¨€åˆå§‹åŒ–å‡½æ•°å·²åˆ é™¤
        
        // åˆ‡æ¢è¯­è¨€åŠŸèƒ½å·²åˆ é™¤
        
        // è·å–è¯­è¨€åç§°åŠŸèƒ½å·²åˆ é™¤
        
        // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€åŠŸèƒ½å·²åˆ é™¤
        
        // åº”ç”¨è¯­è¨€åŠŸèƒ½å·²åˆ é™¤
        
        // è·å–ç¿»è¯‘åŠŸèƒ½å·²åˆ é™¤
        
        // æµ‹è¯•å›½é™…åŒ–ç³»ç»Ÿ
        function testI18n() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•å›½é™…åŒ–ç³»ç»Ÿ...');
            
            // æ£€æŸ¥TRANSLATIONSå¯¹è±¡
            console.log('TRANSLATIONSå¯¹è±¡:', TRANSLATIONS);
            console.log('å½“å‰è¯­è¨€:', currentLanguage);
            console.log('å¯ç”¨è¯­è¨€:', Object.keys(TRANSLATIONS));
            
            // æµ‹è¯•ç¿»è¯‘åŠŸèƒ½
            const testKey = 'main.title';
            const translation = getTranslation(testKey);
            console.log(`æµ‹è¯•ç¿»è¯‘é”® "${testKey}":`, translation);
            
            // æ£€æŸ¥é¡µé¢å…ƒç´ 
            const elements = document.querySelectorAll('[data-i18n]');
            console.log('æ‰¾åˆ°éœ€è¦ç¿»è¯‘çš„å…ƒç´ æ•°é‡:', elements.length);
            
            elements.forEach((element, index) => {
                const key = element.getAttribute('data-i18n');
                const translation = getTranslation(key);
                console.log(`å…ƒç´  ${index + 1}: ${key} = ${translation}`);
            });
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            alert(`å›½é™…åŒ–æµ‹è¯•ç»“æœ:\nå½“å‰è¯­è¨€: ${currentLanguage}\nå¯ç”¨è¯­è¨€: ${Object.keys(TRANSLATIONS).join(', ')}\nç¿»è¯‘å…ƒç´ æ•°é‡: ${elements.length}\næµ‹è¯•ç¿»è¯‘: ${translation}`);
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                .toast-success { background: rgba(40, 167, 69, 0.9) !important; }
                .toast-error { background: rgba(220, 53, 69, 0.9) !important; }
                .toast-info { background: rgba(23, 162, 184, 0.9) !important; }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // æ•°å­—å‘½ç†åˆ†æ
        function analyzeNumerology() {
            console.log('æ•°å­—å‘½ç†åˆ†æå‡½æ•°è¢«è°ƒç”¨');
            
            const birthDate = document.getElementById('nDate').value;
            const name = document.getElementById('nName').value;

            console.log('å‡ºç”Ÿæ—¥æœŸ:', birthDate);
            console.log('å§“å:', name);

            if (!birthDate) {
                alert('è¯·è¾“å…¥å‡ºç”Ÿæ—¥æœŸ');
                return;
            }

            // è®¡ç®—ç”Ÿå‘½æ•°å­—
            const lifeNumber = calculateLifeNumber(birthDate);
            const destinyNumber = calculateDestinyNumber(birthDate);
            const soulNumber = calculateSoulNumber(name);

            console.log('è®¡ç®—ç»“æœ:', { lifeNumber, destinyNumber, soulNumber });

            // æ˜¾ç¤ºåŸºç¡€æ•°å­—
            document.getElementById('lifeNumber').textContent = lifeNumber;
            document.getElementById('destinyNumber').textContent = destinyNumber;
            document.getElementById('soulNumber').textContent = soulNumber;

            // åˆ†ææ•°å­—ç‰¹è´¨
            analyzeNumberTraits(lifeNumber, destinyNumber, soulNumber);

            // æ˜¾ç¤ºåˆ†æç»“æœ
            document.getElementById('numerologyAnalysis').classList.remove('hidden');
            document.getElementById('numerologyMBTIAnalysis').classList.remove('hidden');

            // ç”Ÿæˆæ•°å­—å‘½ç†æµ‹è¯•é¢˜
            generateNumerologyQuiz(lifeNumber, destinyNumber, soulNumber);
        }

        // è®¡ç®—ç”Ÿå‘½æ•°å­—
        function calculateLifeNumber(birthDate) {
            const dateStr = birthDate.replace(/-/g, '');
            let sum = 0;
            for (let i = 0; i < dateStr.length; i++) {
                sum += parseInt(dateStr[i]);
            }
            while (sum > 9) {
                sum = Math.floor(sum / 10) + (sum % 10);
            }
            return sum;
        }

        // è®¡ç®—å‘½è¿æ•°å­—
        function calculateDestinyNumber(birthDate) {
            const dateStr = birthDate.replace(/-/g, '');
            let sum = 0;
            for (let i = 0; i < dateStr.length; i++) {
                sum += parseInt(dateStr[i]);
            }
            return sum;
        }

        // è®¡ç®—çµé­‚æ•°å­—
        function calculateSoulNumber(name) {
            if (!name) return 0;
            let sum = 0;
            let found = false;
            
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                if (CHINESE_NAME_NUMBERS[char]) {
                    sum += CHINESE_NAME_NUMBERS[char];
                    found = true;
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ å°„å­—ç¬¦ï¼Œä½¿ç”¨å­—ç¬¦çš„Unicodeç¼–ç 
            if (!found) {
                for (let i = 0; i < name.length; i++) {
                    const charCode = name.charCodeAt(i);
                    sum += (charCode % 9) + 1; // å°†Unicodeç¼–ç è½¬æ¢ä¸º1-9çš„æ•°å­—
                }
            }
            
            // å°†æ€»å’Œè½¬æ¢ä¸ºä¸ªä½æ•°
            while (sum > 9) {
                sum = Math.floor(sum / 10) + (sum % 10);
            }
            
            return sum;
        }

        // åˆ†ææ•°å­—ç‰¹è´¨
        function analyzeNumberTraits(lifeNumber, destinyNumber, soulNumber) {
            const lifeInfo = NUMBER_MEANINGS[lifeNumber] || {};
            const destinyInfo = NUMBER_MEANINGS[destinyNumber] || {};
            const soulInfo = NUMBER_MEANINGS[soulNumber] || {};

            // ç”Ÿå‘½æ•°å­—ç‰¹è´¨
            const lifeTraits = lifeInfo.traits || 'ç‰¹è´¨ä¸æ˜æ˜¾';
            const lifeElement = lifeInfo.element || '';
            const lifeCareer = lifeInfo.career || '';
            
            document.getElementById('lifeNumberTraits').innerHTML = 
                `<strong>${lifeNumber}å·äººç‰¹è´¨ï¼š</strong>${lifeTraits}<br>
                 <small>äº”è¡Œå±æ€§ï¼š${lifeElement} | é€‚é…èŒä¸šï¼š${lifeCareer}</small>`;
            
            // å‘½è¿æ•°å­—æŒ‡å¼•
            const destinyTraits = destinyInfo.traits || 'æŒ‡å¼•ä¸æ˜æ˜¾';
            const destinyElement = destinyInfo.element || '';
            
            document.getElementById('destinyNumberGuidance').innerHTML = 
                `<strong>å‘½è¿æŒ‡å¼•ï¼š</strong>${destinyTraits}<br>
                 <small>äº”è¡Œå±æ€§ï¼š${destinyElement}</small>`;
            
            // çµé­‚æ•°å­—å†…æ¶µ
            const soulTraits = soulInfo.traits || 'å†…æ¶µä¸æ˜æ˜¾';
            const soulElement = soulInfo.element || '';
            
            document.getElementById('soulNumberMeaning').innerHTML = 
                `<strong>çµé­‚å†…æ¶µï¼š</strong>${soulTraits}<br>
                 <small>äº”è¡Œå±æ€§ï¼š${soulElement}</small>`;

            // æ•°å­—ç»„åˆåˆ†æ
            const combination = analyzeNumberCombination(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numberCombination').innerHTML = combination;

            // MBTIæ˜ å°„åˆ†æ
            const mbtiMapping = analyzeNumberMBTIMapping(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numberMBTIMapping').innerHTML = mbtiMapping;

            // æ€§æ ¼ä¼˜åŠ¿
            const strengths = analyzeNumerologyStrengths(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numerologyStrengths').innerHTML = strengths;

            // å‘å±•å»ºè®®
            const advice = analyzeNumerologyAdvice(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numerologyAdvice').innerHTML = advice;

            // èŒä¸šé€‚é…
            const career = analyzeNumerologyCareer(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numerologyCareer').innerHTML = career;
        }

        // åˆ†ææ•°å­—ç»„åˆ
        function analyzeNumberCombination(life, destiny, soul) {
            let analysis = '';
            let energyLevel = '';
            let compatibility = '';
            
            if (life === destiny && destiny === soul) {
                analysis = 'ä¸‰æ•°åˆä¸€ï¼Œèƒ½é‡é›†ä¸­ï¼Œæ€§æ ¼ç‰¹å¾éå¸¸çªå‡º';
                energyLevel = 'èƒ½é‡é›†ä¸­åº¦ï¼šæé«˜';
                compatibility = 'å…¼å®¹æ€§ï¼šæå¼ºï¼Œä½†å¯èƒ½è¿‡äºå•ä¸€';
            } else if (life === destiny || destiny === soul || life === soul) {
                analysis = 'ä¸¤æ•°ç›¸åŒï¼Œèƒ½é‡äº’è¡¥ï¼Œæ€§æ ¼ç‰¹å¾æ˜æ˜¾';
                energyLevel = 'èƒ½é‡é›†ä¸­åº¦ï¼šé«˜';
                compatibility = 'å…¼å®¹æ€§ï¼šå¼ºï¼Œä¸»è¦ç‰¹å¾çªå‡º';
            } else if (Math.abs(life - destiny) <= 2 && Math.abs(destiny - soul) <= 2) {
                analysis = 'ä¸‰æ•°ç›¸è¿‘ï¼Œèƒ½é‡å’Œè°ï¼Œæ€§æ ¼ç‰¹å¾å¹³è¡¡';
                energyLevel = 'èƒ½é‡é›†ä¸­åº¦ï¼šä¸­ç­‰';
                compatibility = 'å…¼å®¹æ€§ï¼šè‰¯å¥½ï¼Œç‰¹å¾åè°ƒ';
            } else {
                analysis = 'ä¸‰æ•°åˆ†æ•£ï¼Œèƒ½é‡å¤šå…ƒï¼Œæ€§æ ¼ç‰¹å¾ä¸°å¯Œ';
                energyLevel = 'èƒ½é‡é›†ä¸­åº¦ï¼šä½';
                compatibility = 'å…¼å®¹æ€§ï¼šå¤šå…ƒï¼Œéœ€è¦æ•´åˆ';
            }

            // æ·»åŠ äº”è¡Œç›¸ç”Ÿç›¸å…‹åˆ†æ
            const lifeElement = NUMBER_MEANINGS[life]?.element || '';
            const destinyElement = NUMBER_MEANINGS[destiny]?.element || '';
            const soulElement = NUMBER_MEANINGS[soul]?.element || '';
            
            let elementAnalysis = '';
            if (lifeElement && destinyElement && soulElement) {
                elementAnalysis = `<br><small>äº”è¡Œç»„åˆï¼š${lifeElement} + ${destinyElement} + ${soulElement}</small>`;
            }

            return `<strong>ç»„åˆç‰¹å¾ï¼š</strong>${analysis}<br>
                    <small>${energyLevel} | ${compatibility}${elementAnalysis}</small>`;
        }

        // åˆ†ææ•°å­—-MBTIæ˜ å°„
        function analyzeNumberMBTIMapping(life, destiny, soul) {
            const lifeMBTI = NUMBER_MEANINGS[life]?.mbti || '';
            const destinyMBTI = NUMBER_MEANINGS[destiny]?.mbti || '';
            const soulMBTI = NUMBER_MEANINGS[soul]?.mbti || '';

            let mapping = '';
            let dominantType = '';
            let compatibility = '';
            
            if (lifeMBTI) mapping += `ç”Ÿå‘½æ•°å­—ï¼š${lifeMBTI}<br>`;
            if (destinyMBTI) mapping += `å‘½è¿æ•°å­—ï¼š${destinyMBTI}<br>`;
            if (soulMBTI) mapping += `çµé­‚æ•°å­—ï¼š${soulMBTI}`;

            // åˆ†æä¸»å¯¼ç±»å‹
            const allTypes = [lifeMBTI, destinyMBTI, soulMBTI].filter(Boolean);
            if (allTypes.length > 0) {
                const typeCounts = {};
                allTypes.forEach(type => {
                    const types = type.split(',');
                    types.forEach(t => {
                        typeCounts[t] = (typeCounts[t] || 0) + 1;
                    });
                });
                
                const dominantTypes = Object.entries(typeCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 2)
                    .map(([type, count]) => `${type}(${count}æ¬¡)`);
                
                dominantType = `ä¸»å¯¼ç±»å‹ï¼š${dominantTypes.join('ã€')}`;
                
                // å…¼å®¹æ€§åˆ†æ
                if (Object.keys(typeCounts).length <= 2) {
                    compatibility = 'å…¼å®¹æ€§ï¼šé«˜ï¼Œç±»å‹é›†ä¸­';
                } else if (Object.keys(typeCounts).length <= 4) {
                    compatibility = 'å…¼å®¹æ€§ï¼šä¸­ç­‰ï¼Œç±»å‹å¤šæ ·';
                } else {
                    compatibility = 'å…¼å®¹æ€§ï¼šä½ï¼Œç±»å‹åˆ†æ•£';
                }
            }

            return `${mapping || 'æš‚æ— MBTIæ˜ å°„ä¿¡æ¯'}<br>
                    <small><strong>${dominantType}</strong><br>
                    <strong>${compatibility}</strong></small>`;
        }

        // åˆ†ææ•°å­—å‘½ç†ä¼˜åŠ¿
        function analyzeNumerologyStrengths(life, destiny, soul) {
            const strengths = [];
            const lifeInfo = NUMBER_MEANINGS[life] || {};
            const destinyInfo = NUMBER_MEANINGS[destiny] || {};
            const soulInfo = NUMBER_MEANINGS[soul] || {};
            
            // ç”Ÿå‘½æ•°å­—ä¼˜åŠ¿
            if (life <= 3) {
                strengths.push(`åˆ›æ–°æ€ç»´ï¼ˆ${life}å·ç‰¹è´¨ï¼‰`);
                strengths.push('è¡¨è¾¾èƒ½åŠ›ã€çµæ´»æ€§');
            } else if (life >= 4 && life <= 6) {
                strengths.push(`ç»„ç»‡èƒ½åŠ›ï¼ˆ${life}å·ç‰¹è´¨ï¼‰`);
                strengths.push('è´£ä»»æ„Ÿã€ç¨³å®šæ€§');
            } else if (life >= 7 && life <= 9) {
                strengths.push(`åˆ†æèƒ½åŠ›ï¼ˆ${life}å·ç‰¹è´¨ï¼‰`);
                strengths.push('é¢†å¯¼åŠ›ã€ä¸“ä¸šæ€§');
            }

            // å‘½è¿æ•°å­—ä¼˜åŠ¿
            if (destiny <= 3) {
                strengths.push(`çµæ´»æ€§ï¼ˆ${destiny}å·ç‰¹è´¨ï¼‰`);
                strengths.push('é€‚åº”æ€§ã€åˆ›æ–°æ€§');
            } else if (destiny >= 4 && destiny <= 6) {
                strengths.push(`ç¨³å®šæ€§ï¼ˆ${destiny}å·ç‰¹è´¨ï¼‰`);
                strengths.push('å¯é æ€§ã€ç»„ç»‡æ€§');
            } else if (destiny >= 7 && destiny <= 9) {
                strengths.push(`æ·±åº¦æ€è€ƒï¼ˆ${destiny}å·ç‰¹è´¨ï¼‰`);
                strengths.push('ä¸“ä¸šèƒ½åŠ›ã€æ´å¯ŸåŠ›');
            }

            // çµé­‚æ•°å­—ä¼˜åŠ¿
            if (soul > 0) {
                strengths.push(`å†…åœ¨ç‰¹è´¨ï¼ˆ${soul}å·çµé­‚ï¼‰`);
                strengths.push(soulInfo.traits ? soulInfo.traits.split('ã€')[0] : 'ç‹¬ç‰¹ä¸ªæ€§');
            }

            // äº”è¡Œä¼˜åŠ¿
            const elements = [lifeInfo.element, destinyInfo.element, soulInfo.element].filter(Boolean);
            if (elements.length > 0) {
                const uniqueElements = [...new Set(elements)];
                if (uniqueElements.length === 1) {
                    strengths.push(`${uniqueElements[0]}è¡Œä¸“ç²¾ï¼Œèƒ½é‡é›†ä¸­`);
                } else {
                    strengths.push(`${uniqueElements.join('+')}è¡Œç»„åˆï¼Œèƒ½é‡å¤šå…ƒ`);
                }
            }

            return `<strong>æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong>${strengths.join('ã€')}`;
        }

        // åˆ†ææ•°å­—å‘½ç†å»ºè®®
        function analyzeNumerologyAdvice(life, destiny, soul) {
            let advice = '';
            let focus = '';
            let warning = '';
            
            // ç”Ÿå‘½æ•°å­—å»ºè®®
            if (life <= 3) {
                advice = 'å‘æŒ¥åˆ›é€ åŠ›ï¼Œæ³¨æ„ç»†èŠ‚ç®¡ç†';
                focus = 'é‡ç‚¹å‘å±•ï¼šåˆ›æ–°æ€ç»´ã€è¡¨è¾¾èƒ½åŠ›ã€çµæ´»æ€§';
                warning = 'éœ€è¦æ³¨æ„ï¼šç»†èŠ‚ç®¡ç†ã€æ‰§è¡ŒåŠ›ã€ç¨³å®šæ€§';
            } else if (life >= 4 && life <= 6) {
                advice = 'ä¿æŒç¨³å®šæ€§ï¼ŒåŸ¹å…»åˆ›æ–°æ€ç»´';
                focus = 'é‡ç‚¹å‘å±•ï¼šç»„ç»‡èƒ½åŠ›ã€è´£ä»»æ„Ÿã€ç¨³å®šæ€§';
                warning = 'éœ€è¦æ³¨æ„ï¼šåˆ›æ–°æ€ç»´ã€çµæ´»æ€§ã€çªç ´æ€§';
            } else {
                advice = 'å‘æŒ¥ä¸“ä¸šèƒ½åŠ›ï¼Œæ³¨æ„å›¢é˜Ÿåˆä½œ';
                focus = 'é‡ç‚¹å‘å±•ï¼šåˆ†æèƒ½åŠ›ã€é¢†å¯¼åŠ›ã€ä¸“ä¸šæ€§';
                warning = 'éœ€è¦æ³¨æ„ï¼šå›¢é˜Ÿåˆä½œã€æ²Ÿé€šèƒ½åŠ›ã€åŒ…å®¹æ€§';
            }

            // å‘½è¿æ•°å­—å»ºè®®
            let destinyAdvice = '';
            if (destiny <= 3) {
                destinyAdvice = 'åŸ¹å…»é€‚åº”èƒ½åŠ›ï¼Œæ³¨æ„åšæŒæ€§';
            } else if (destiny >= 4 && destiny <= 6) {
                destinyAdvice = 'å‘æŒ¥ç¨³å®šä¼˜åŠ¿ï¼Œæ³¨æ„çµæ´»æ€§';
            } else {
                destinyAdvice = 'æ·±åŒ–ä¸“ä¸šèƒ½åŠ›ï¼Œæ³¨æ„å®è·µæ€§';
            }

            // çµé­‚æ•°å­—å»ºè®®
            let soulAdvice = '';
            if (soul > 0) {
                const soulInfo = NUMBER_MEANINGS[soul] || {};
                if (soul <= 3) {
                    soulAdvice = 'å…³æ³¨å†…åœ¨æˆé•¿ï¼ŒåŸ¹å…»è‡ªæˆ‘è®¤çŸ¥';
                } else if (soul >= 4 && soul <= 6) {
                    soulAdvice = 'å¹³è¡¡å†…å¤–éœ€æ±‚ï¼ŒåŸ¹å…»è‡ªæˆ‘è°ƒèŠ‚';
                } else {
                    soulAdvice = 'æ·±åŒ–å†…åœ¨æ™ºæ…§ï¼ŒåŸ¹å…»è‡ªæˆ‘è¶…è¶Š';
                }
            }

            return `<strong>å‘å±•å»ºè®®ï¼š</strong>${advice}<br>
                    <small><strong>é‡ç‚¹å‘å±•ï¼š</strong>${focus}<br>
                    <strong>éœ€è¦æ³¨æ„ï¼š</strong>${warning}<br>
                    <strong>å‘½è¿æŒ‡å¼•ï¼š</strong>${destinyAdvice}<br>
                    <strong>çµé­‚æˆé•¿ï¼š</strong>${soulAdvice}</small>`;
        }

        // åˆ†ææ•°å­—å‘½ç†èŒä¸š
        function analyzeNumerologyCareer(life, destiny, soul) {
            const lifeCareer = NUMBER_MEANINGS[life]?.career || '';
            const destinyCareer = NUMBER_MEANINGS[destiny]?.career || '';
            const soulCareer = NUMBER_MEANINGS[soul]?.career || '';
            
            let careers = [];
            let careerTypes = [];
            let developmentPath = '';
            
            // æ”¶é›†èŒä¸šå»ºè®®
            if (lifeCareer) careers.push(lifeCareer);
            if (destinyCareer && destinyCareer !== lifeCareer) careers.push(destinyCareer);
            if (soulCareer && !careers.includes(soulCareer)) careers.push(soulCareer);

            // åˆ†æèŒä¸šç±»å‹
            if (life <= 3 || destiny <= 3) {
                careerTypes.push('åˆ›æ–°åˆ›æ„ç±»');
            }
            if (life >= 4 && life <= 6 || destiny >= 4 && destiny <= 6) {
                careerTypes.push('ç®¡ç†ç»„ç»‡ç±»');
            }
            if (life >= 7 || destiny >= 7) {
                careerTypes.push('ä¸“ä¸šåˆ†æç±»');
            }

            // å‘å±•è·¯å¾„å»ºè®®
            if (life <= 3 && destiny <= 3) {
                developmentPath = 'é€‚åˆä»åˆ›æ„å²—ä½å¼€å§‹ï¼Œé€æ­¥åŸ¹å…»ç®¡ç†èƒ½åŠ›';
            } else if (life >= 7 && destiny >= 7) {
                developmentPath = 'é€‚åˆä»ä¸“ä¸šå²—ä½å¼€å§‹ï¼Œé€æ­¥åŸ¹å…»é¢†å¯¼èƒ½åŠ›';
            } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                developmentPath = 'é€‚åˆä»ç®¡ç†å²—ä½å¼€å§‹ï¼Œé€æ­¥åŸ¹å…»åˆ›æ–°èƒ½åŠ›';
            } else {
                developmentPath = 'é€‚åˆä»ç»¼åˆå²—ä½å¼€å§‹ï¼Œé€æ­¥åŸ¹å…»ä¸“ä¸šèƒ½åŠ›';
            }

            return `<strong>é€‚é…èŒä¸šï¼š</strong>${careers.join('ã€') || 'æ ¹æ®å…´è¶£é€‰æ‹©'}<br>
                    <small><strong>èŒä¸šç±»å‹ï¼š</strong>${careerTypes.join('ã€')}<br>
                    <strong>å‘å±•è·¯å¾„ï¼š</strong>${developmentPath}</small>`;
        }

        // ç”Ÿæˆæ•°å­—å‘½ç†æµ‹è¯•é¢˜
        function generateNumerologyQuiz(life, destiny, soul) {
            const quizContainer = document.getElementById('numerologyQuiz');
            quizContainer.innerHTML = '';

            const questions = [
                {
                    id: 1,
                    question: 'é¢å¯¹æ–°æŒ‘æˆ˜æ—¶ï¼Œä½ æ›´å€¾å‘äºï¼š',
                    options: [
                        { text: 'åˆ¶å®šè¯¦ç»†è®¡åˆ’ï¼ŒæŒ‰æ­¥éª¤æ‰§è¡Œ', score: { S: 1, J: 1, number: { 4: 0.5, 6: 0.5 } } },
                        { text: 'çµæ´»åº”å¯¹ï¼Œéšæœºåº”å˜', score: { N: 1, P: 1, number: { 5: 0.5, 3: 0.5 } } }
                    ]
                },
                {
                    id: 2,
                    question: 'åœ¨å›¢é˜Ÿä¸­ï¼Œä½ æ›´æ„¿æ„æ‰®æ¼”ï¼š',
                    options: [
                        { text: 'é¢†å¯¼è€…ï¼Œåˆ¶å®šæ–¹å‘å’Œç­–ç•¥', score: { E: 1, J: 1, number: { 1: 0.5, 8: 0.5 } } },
                        { text: 'æ”¯æŒè€…ï¼ŒååŠ©ä»–äººå®Œæˆä»»åŠ¡', score: { I: 1, F: 1, number: { 2: 0.5, 6: 0.5 } } }
                    ]
                },
                {
                    id: 3,
                    question: 'è§£å†³é—®é¢˜æ—¶ï¼Œä½ æ›´ä¾èµ–ï¼š',
                    options: [
                        { text: 'é€»è¾‘åˆ†æå’Œæ•°æ®æ”¯æŒ', score: { T: 1, S: 1, number: { 7: 0.5, 4: 0.5 } } },
                        { text: 'ç›´è§‰æ„Ÿå—å’Œåˆ›æ„çµæ„Ÿ', score: { F: 1, N: 1, number: { 3: 0.5, 9: 0.5 } } }
                    ]
                },
                {
                    id: 4,
                    question: 'å¯¹äºè§„åˆ™å’Œä¼ ç»Ÿï¼Œä½ çš„æ€åº¦æ˜¯ï¼š',
                    options: [
                        { text: 'å°Šé‡å¹¶éµå¾ªï¼Œç»´æŠ¤ç§©åº', score: { S: 1, J: 1, number: { 4: 0.5, 6: 0.5 } } },
                        { text: 'çµæ´»è¿ç”¨ï¼Œå¿…è¦æ—¶æ‰“ç ´', score: { N: 1, P: 1, number: { 5: 0.5, 1: 0.5 } } }
                    ]
                },
                {
                    id: 5,
                    question: 'åœ¨ç¤¾äº¤åœºåˆï¼Œä½ æ›´ï¼š',
                    options: [
                        { text: 'ä¸»åŠ¨äº¤æµï¼Œæ‰©å¤§äººè„‰', score: { E: 1, number: { 1: 0.5, 3: 0.5 } } },
                        { text: 'è§‚å¯Ÿå€¾å¬ï¼Œæ·±åº¦äº¤æµ', score: { I: 1, number: { 2: 0.5, 7: 0.5 } } }
                    ]
                },
                {
                    id: 6,
                    question: 'å¤„ç†å†²çªæ—¶ï¼Œä½ æ›´å€¾å‘äºï¼š',
                    options: [
                        { text: 'ç›´æ¥é¢å¯¹ï¼Œå¯»æ±‚è§£å†³æ–¹æ¡ˆ', score: { T: 1, E: 0.5, number: { 1: 0.5, 8: 0.5 } } },
                        { text: 'ç¼“å’Œæ°”æ°›ï¼Œç»´æŠ¤å…³ç³»å’Œè°', score: { F: 1, I: 0.5, number: { 2: 0.5, 6: 0.5 } } }
                    ]
                },
                {
                    id: 7,
                    question: 'å­¦ä¹ æ–°çŸ¥è¯†æ—¶ï¼Œä½ æ›´å–œæ¬¢ï¼š',
                    options: [
                        { text: 'ç³»ç»Ÿå­¦ä¹ ï¼Œå»ºç«‹çŸ¥è¯†æ¡†æ¶', score: { S: 1, J: 1, number: { 4: 0.5, 7: 0.5 } } },
                        { text: 'è·³è·ƒå¼å­¦ä¹ ï¼Œå¯»æ‰¾çµæ„Ÿè¿æ¥', score: { N: 1, P: 1, number: { 3: 0.5, 5: 0.5 } } }
                    ]
                },
                {
                    id: 8,
                    question: 'é¢å¯¹å‹åŠ›æ—¶ï¼Œä½ ä¼šï¼š',
                    options: [
                        { text: 'åˆ¶å®šè®¡åˆ’ï¼Œé€æ­¥åŒ–è§£', score: { J: 1, S: 0.5, number: { 4: 0.5, 6: 0.5 } } },
                        { text: 'å¯»æ‰¾æ”¯æŒï¼Œå¯»æ±‚å¸®åŠ©', score: { F: 1, E: 0.5, number: { 2: 0.5, 9: 0.5 } } }
                    ]
                }
            ];

            // å­˜å‚¨é—®é¢˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›æäº¤å‡½æ•°ä½¿ç”¨
            window._numerologyQuestions = questions;

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'q';
                questionDiv.innerHTML = `<div style="font-weight:700">${index + 1}. ${q.question}</div>`;
                
                q.options.forEach((option, optIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'opt';
                    optionDiv.innerHTML = `<label><input type="radio" name="nq${q.id}" value="${optIndex}"> ${option.text}</label>`;
                    questionDiv.appendChild(optionDiv);
                });
                
                quizContainer.appendChild(questionDiv);
            });

            document.getElementById('numerologyTest').classList.remove('hidden');
        }

        // æäº¤æ•°å­—å‘½ç†æµ‹è¯•
        function submitNumerologyTest() {
            const questions = document.querySelectorAll('#numerologyQuiz .q');
            let scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            let numberScores = {};

            questions.forEach((q, index) => {
                const selected = q.querySelector('input:checked');
                if (selected) {
                    const optionIndex = parseInt(selected.value);
                    const question = window._numerologyQuestions ? window._numerologyQuestions[index] : null;
                    if (question && question.options[optionIndex]) {
                        const option = question.options[optionIndex];
                        Object.entries(option.score).forEach(([key, value]) => {
                            if (key === 'number') {
                                Object.entries(value).forEach(([num, score]) => {
                                    numberScores[num] = (numberScores[num] || 0) + score;
                                });
                            } else {
                                scores[key] = (scores[key] || 0) + value;
                            }
                        });
                    }
                }
            });

            const mbtiType = determineMBTIType(scores);
            const result = `æ•°å­—å‘½ç†MBTIç±»å‹ï¼š${mbtiType}`;
            
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            document.getElementById('numerologyResult').textContent = result;
            
            // æ˜¾ç¤ºæ•°å­—èƒ½é‡åˆ†æ
            const numberAnalysis = analyzeNumberEnergy(numberScores);
            const resultDiv = document.getElementById('numerologyResult');
            resultDiv.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>æ•°å­—å‘½ç†MBTIç±»å‹ï¼š${mbtiType}</strong></div>
                <div style="font-size: 12px; color: #6b7280;">${numberAnalysis}</div>
            `;
        }

        // åˆ†ææ•°å­—èƒ½é‡
        function analyzeNumberEnergy(numberScores) {
            if (Object.keys(numberScores).length === 0) return 'è¯·å®Œæˆæµ‹è¯•é¢˜';
            
            const topNumbers = Object.entries(numberScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([num, score]) => `${num}å·èƒ½é‡(${score.toFixed(1)})`);
            
            return `æ•°å­—èƒ½é‡ï¼š${topNumbers.join('ã€')}`;
        }

        // ç¡®å®šMBTIç±»å‹
        function determineMBTIType(scores) {
            const E = scores.E || 0;
            const I = scores.I || 0;
            const S = scores.S || 0;
            const N = scores.N || 0;
            const T = scores.T || 0;
            const F = scores.F || 0;
            const J = scores.J || 0;
            const P = scores.P || 0;

            const first = E > I ? 'E' : 'I';
            const second = S > N ? 'S' : 'N';
            const third = T > F ? 'T' : 'F';
            const fourth = J > P ? 'J' : 'P';

            return first + second + third + fourth;
        }

        // ä¸‰åˆä¸€åˆ†æ
        function runTripleAnalysis() {
            const birthDate = document.getElementById('fDate').value;
            const birthTime = document.getElementById('fTime').value;
            const name = document.getElementById('fName').value;

            if (!birthDate) {
                alert('è¯·è¾“å…¥å‡ºç”Ÿæ—¥æœŸ');
                return;
            }

            // è®¡ç®—å…«å­—
            const baziResult = calculateBazi(birthDate, birthTime);
            
            // è®¡ç®—æ•°å­—å‘½ç†
            const lifeNumber = calculateLifeNumber(birthDate);
            const destinyNumber = calculateDestinyNumber(birthDate);
            const soulNumber = calculateSoulNumber(name);

            // ç»¼åˆåˆ†æ
            const tripleResult = analyzeTripleIntegration(baziResult, lifeNumber, destinyNumber, soulNumber);
            
            // æ˜¾ç¤ºç»“æœ
            displayTripleResult(tripleResult);
        }

        // è®¡ç®—å…«å­—ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function calculateBazi(birthDate, birthTime) {
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥è°ƒç”¨å®Œæ•´çš„å…«å­—è®¡ç®—
            const date = new Date(birthDate + 'T' + birthTime);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();

            // ç®€åŒ–çš„å¤©å¹²åœ°æ”¯è®¡ç®—ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨ä¸“ä¸šçš„å…«å­—è®¡ç®—åº“ï¼‰
            const stems = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            
            const yearStem = stems[year % 10];
            const monthStem = stems[month % 10];
            const dayStem = stems[day % 10];
            const hourStem = stems[hour % 10];

            return {
                year, month, day, hour,
                yearStem,
                monthStem,
                dayStem,
                hourStem,
                yearBranch: branches[year % 12],
                monthBranch: branches[month % 12],
                dayBranch: branches[day % 12],
                hourBranch: branches[hour % 12]
            };
        }

        // ä¸‰åˆä¸€èåˆåˆ†æ
        function analyzeTripleIntegration(bazi, life, destiny, soul) {
            // åŸºäºå…«å­—ã€æ•°å­—å‘½ç†çš„ç»¼åˆåˆ†æ
            let mbtiType = 'INTJ'; // é»˜è®¤ç±»å‹
            let confidence = 'ä¸­ç­‰';
            let baziTraits = 'ä¼ ç»Ÿå‘½ç†ç‰¹å¾';
            let numberEnergy = 'æ•°å­—èƒ½é‡ç‰¹å¾';
            let mbtiTendency = 'MBTIå€¾å‘ç‰¹å¾';
            let advice = 'ç»¼åˆå‘å±•å»ºè®®';

            // æ•°å­—å‘½ç†ä¸MBTIçš„èåˆé€»è¾‘
            if (life <= 3 && destiny <= 3) {
                mbtiType = 'ENFP';
                confidence = 'é«˜';
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼šåˆ›æ–°æ€ç»´ + å‘½è¿æ•°å­—${destiny}ï¼šçµæ´»é€‚åº”`;
                mbtiTendency = 'å¤–å‘ç›´è§‰æƒ…æ„Ÿæ„ŸçŸ¥å‹ï¼Œå¯Œæœ‰åˆ›é€ åŠ›å’Œé€‚åº”æ€§';
                advice = 'å‘æŒ¥åˆ›æ–°æ€ç»´ï¼ŒåŸ¹å…»æ‰§è¡ŒåŠ›ï¼Œæ³¨æ„ç»†èŠ‚ç®¡ç†';
            } else if (life >= 7 && destiny >= 7) {
                mbtiType = 'INTJ';
                confidence = 'é«˜';
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼šåˆ†æèƒ½åŠ› + å‘½è¿æ•°å­—${destiny}ï¼šæ·±åº¦æ€è€ƒ`;
                mbtiTendency = 'å†…å‘ç›´è§‰æ€è€ƒåˆ¤æ–­å‹ï¼Œæ“…é•¿æˆ˜ç•¥è§„åˆ’å’Œç³»ç»Ÿæ€è€ƒ';
                advice = 'å‘æŒ¥åˆ†æä¼˜åŠ¿ï¼ŒåŸ¹å…»æ²Ÿé€šèƒ½åŠ›ï¼Œæ³¨æ„å›¢é˜Ÿåˆä½œ';
            } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                mbtiType = 'ISTJ';
                confidence = 'é«˜';
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼šç»„ç»‡èƒ½åŠ› + å‘½è¿æ•°å­—${destiny}ï¼šç¨³å®šæ€§`;
                mbtiTendency = 'å†…å‘æ„Ÿè§‰æ€è€ƒåˆ¤æ–­å‹ï¼Œé‡è§†ç§©åºå’Œå¯é æ€§';
                advice = 'å‘æŒ¥ç»„ç»‡ä¼˜åŠ¿ï¼ŒåŸ¹å…»åˆ›æ–°æ€ç»´ï¼Œæ³¨æ„çµæ´»æ€§';
            } else if (life <= 3 && destiny >= 7) {
                mbtiType = 'ENTP';
                confidence = 'ä¸­ç­‰';
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼šåˆ›æ–°æ€ç»´ + å‘½è¿æ•°å­—${destiny}ï¼šæ·±åº¦æ€è€ƒ`;
                mbtiTendency = 'å¤–å‘ç›´è§‰æ€è€ƒæ„ŸçŸ¥å‹ï¼Œå¯Œæœ‰åˆ›æ„å’Œåˆ†æèƒ½åŠ›';
                advice = 'å¹³è¡¡åˆ›æ–°ä¸åˆ†æï¼ŒåŸ¹å…»ä¸“æ³¨åŠ›ï¼Œæ³¨æ„æ‰§è¡ŒåŠ›';
            } else if (life >= 7 && destiny <= 3) {
                mbtiType = 'INFJ';
                confidence = 'ä¸­ç­‰';
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼šåˆ†æèƒ½åŠ› + å‘½è¿æ•°å­—${destiny}ï¼šåˆ›æ–°æ€ç»´`;
                mbtiTendency = 'å†…å‘ç›´è§‰æƒ…æ„Ÿåˆ¤æ–­å‹ï¼Œå…·æœ‰æ´å¯ŸåŠ›å’Œç†æƒ³ä¸»ä¹‰';
                advice = 'å‘æŒ¥æ´å¯Ÿä¼˜åŠ¿ï¼ŒåŸ¹å…»è¡ŒåŠ¨åŠ›ï¼Œæ³¨æ„ç°å®è½åœ°';
            } else {
                // å…¶ä»–ç»„åˆçš„åˆ†æ
                mbtiType = 'ISFP'; // é»˜è®¤ç±»å‹
                confidence = 'ä¸­ç­‰';
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼š${NUMBER_MEANINGS[life]?.traits || 'ç‰¹è´¨'} + å‘½è¿æ•°å­—${destiny}ï¼š${NUMBER_MEANINGS[destiny]?.traits || 'ç‰¹è´¨'}`;
                mbtiTendency = 'å¹³è¡¡å‹ï¼Œå…·æœ‰å¤šå…ƒç‰¹è´¨ï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µåˆ†æ';
                advice = 'å‘æŒ¥ä¸»è¦ä¼˜åŠ¿ï¼Œå¹³è¡¡å‘å±•ï¼Œæ³¨æ„æ•´åˆå¤šå…ƒç‰¹è´¨';
            }

            // æ·»åŠ çµé­‚æ•°å­—åˆ†æ
            if (soul > 0) {
                const soulInfo = NUMBER_MEANINGS[soul] || {};
                numberEnergy += `<br>çµé­‚æ•°å­—${soul}ï¼š${soulInfo.traits || 'å†…åœ¨ç‰¹è´¨'}`;
                if (soul <= 3) {
                    advice += '<br>å…³æ³¨å†…åœ¨æˆé•¿ï¼ŒåŸ¹å…»è‡ªæˆ‘è®¤çŸ¥';
                } else if (soul >= 7) {
                    advice += '<br>æ·±åŒ–å†…åœ¨æ™ºæ…§ï¼ŒåŸ¹å…»è‡ªæˆ‘è¶…è¶Š';
                }
            }

            // å…«å­—ç‰¹å¾åˆ†æ
            const yearElement = STEM_TO_WUXING[bazi.yearStem] || '';
            const monthElement = STEM_TO_WUXING[bazi.monthStem] || '';
            const dayElement = STEM_TO_WUXING[bazi.dayStem] || '';
            const hourElement = STEM_TO_WUXING[bazi.hourStem] || '';
            
            if (yearElement) {
                const elementTraits = {
                    'æœ¨': 'æœ¨æ€§ä¸»ä»ï¼Œå…·æœ‰ç”Ÿé•¿ã€å‘ä¸Šã€è¿›å–çš„ç‰¹è´¨',
                    'ç«': 'ç«æ€§ä¸»ç¤¼ï¼Œå…·æœ‰å…‰æ˜ã€æ¸©æš–ã€çƒ­æƒ…çš„ç‰¹è´¨',
                    'åœŸ': 'åœŸæ€§ä¸»ä¿¡ï¼Œå…·æœ‰åŒ…å®¹ã€ç¨³å®šã€åŠ¡å®çš„ç‰¹è´¨',
                    'é‡‘': 'é‡‘æ€§ä¸»ä¹‰ï¼Œå…·æœ‰åˆšæ¯…ã€æœæ–­ã€åŸåˆ™çš„ç‰¹è´¨',
                    'æ°´': 'æ°´æ€§ä¸»æ™ºï¼Œå…·æœ‰æ™ºæ…§ã€çµæ´»ã€åŒ…å®¹çš„ç‰¹è´¨'
                };
                
                baziTraits = `å¹´å¹²${bazi.yearStem}(${yearElement})ï¼š${elementTraits[yearElement]}`;
                
                // æ·»åŠ æœˆä»¤åˆ†æ
                if (monthElement) {
                    baziTraits += `<br>æœˆå¹²${bazi.monthStem}(${monthElement})ï¼šæœˆä»¤å½“ä»¤ï¼Œå½±å“æ—¥ä¸»å¼ºå¼±`;
                }
                
                // æ·»åŠ æ—¥ä¸»åˆ†æ
                if (dayElement) {
                    baziTraits += `<br>æ—¥å¹²${bazi.dayStem}(${dayElement})ï¼šæ—¥ä¸»ï¼Œæ€§æ ¼æ ¸å¿ƒ`;
                }
                
                // æ·»åŠ æ—¶æŸ±åˆ†æ
                if (hourElement) {
                    baziTraits += `<br>æ—¶å¹²${bazi.hourStem}(${hourElement})ï¼šæ—¶æŸ±ï¼Œæ™šå¹´å‘å±•`;
                }
            }

            // å®Œå–„MBTIå€¾å‘åˆ†æ
            if (mbtiTendency === 'MBTIå€¾å‘ç‰¹å¾') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    mbtiTendency = 'å¤–å‘ç›´è§‰æƒ…æ„Ÿæ„ŸçŸ¥å‹ï¼Œå¯Œæœ‰åˆ›é€ åŠ›å’Œé€‚åº”æ€§ï¼Œé€‚åˆåˆ›æ–°å’Œç¤¾äº¤å·¥ä½œ';
                } else if (life >= 7 && destiny >= 7) {
                    mbtiTendency = 'å†…å‘ç›´è§‰æ€è€ƒåˆ¤æ–­å‹ï¼Œæ“…é•¿æˆ˜ç•¥è§„åˆ’å’Œç³»ç»Ÿæ€è€ƒï¼Œé€‚åˆåˆ†æå’Œé¢†å¯¼å·¥ä½œ';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    mbtiTendency = 'å†…å‘æ„Ÿè§‰æ€è€ƒåˆ¤æ–­å‹ï¼Œé‡è§†ç§©åºå’Œå¯é æ€§ï¼Œé€‚åˆç®¡ç†å’Œæ‰§è¡Œå·¥ä½œ';
                } else {
                    mbtiTendency = 'å¹³è¡¡å‹ï¼Œå…·æœ‰å¤šå…ƒç‰¹è´¨ï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µåˆ†æï¼Œé€‚åˆç»¼åˆå’Œåè°ƒå·¥ä½œ';
                }
            }

            // å®Œå–„ç»¼åˆå»ºè®®åˆ†æ
            if (advice === 'ç»¼åˆå‘å±•å»ºè®®') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    advice = 'å‘æŒ¥åˆ›æ–°æ€ç»´ï¼ŒåŸ¹å…»æ‰§è¡ŒåŠ›ï¼Œæ³¨æ„ç»†èŠ‚ç®¡ç†ï¼Œå¹³è¡¡åˆ›æ„ä¸è½åœ°';
                } else if (life >= 7 && destiny >= 7) {
                    advice = 'å‘æŒ¥åˆ†æä¼˜åŠ¿ï¼ŒåŸ¹å…»æ²Ÿé€šèƒ½åŠ›ï¼Œæ³¨æ„å›¢é˜Ÿåˆä½œï¼Œå¹³è¡¡ä¸“ä¸šä¸åä½œ';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    advice = 'å‘æŒ¥ç»„ç»‡ä¼˜åŠ¿ï¼ŒåŸ¹å…»åˆ›æ–°æ€ç»´ï¼Œæ³¨æ„çµæ´»æ€§ï¼Œå¹³è¡¡ç¨³å®šä¸åˆ›æ–°';
                } else {
                    advice = 'å‘æŒ¥ä¸»è¦ä¼˜åŠ¿ï¼Œå¹³è¡¡å‘å±•ï¼Œæ³¨æ„æ•´åˆå¤šå…ƒç‰¹è´¨ï¼Œå¯»æ‰¾é€‚åˆè‡ªå·±çš„å‘å±•è·¯å¾„';
                }
                
                // æ·»åŠ çµé­‚æ•°å­—å»ºè®®
                if (soul > 0) {
                    const soulInfo = NUMBER_MEANINGS[soul] || {};
                    if (soul <= 3) {
                        advice += '<br>å…³æ³¨å†…åœ¨æˆé•¿ï¼ŒåŸ¹å…»è‡ªæˆ‘è®¤çŸ¥ï¼Œå¹³è¡¡å†…å¤–å‘å±•';
                    } else if (soul >= 7) {
                        advice += '<br>æ·±åŒ–å†…åœ¨æ™ºæ…§ï¼ŒåŸ¹å…»è‡ªæˆ‘è¶…è¶Šï¼Œå¹³è¡¡ç²¾ç¥ä¸ç‰©è´¨';
                    } else {
                        advice += '<br>å¹³è¡¡å†…å¤–éœ€æ±‚ï¼ŒåŸ¹å…»è‡ªæˆ‘è°ƒèŠ‚ï¼Œä¿æŒèº«å¿ƒå¥åº·';
                    }
                }
            }

            // å®Œå–„ç»¼åˆå»ºè®®
            if (advice === 'ç»¼åˆå‘å±•å»ºè®®') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    advice = 'å‘æŒ¥åˆ›æ–°æ€ç»´ï¼ŒåŸ¹å…»æ‰§è¡ŒåŠ›ï¼Œæ³¨æ„ç»†èŠ‚ç®¡ç†ï¼Œå¹³è¡¡åˆ›æ„ä¸è½åœ°';
                } else if (life >= 7 && destiny >= 7) {
                    advice = 'å‘æŒ¥åˆ†æä¼˜åŠ¿ï¼ŒåŸ¹å…»æ²Ÿé€šèƒ½åŠ›ï¼Œæ³¨æ„å›¢é˜Ÿåˆä½œï¼Œå¹³è¡¡ä¸“ä¸šä¸åä½œ';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    advice = 'å‘æŒ¥ç»„ç»‡ä¼˜åŠ¿ï¼ŒåŸ¹å…»åˆ›æ–°æ€ç»´ï¼Œæ³¨æ„çµæ´»æ€§ï¼Œå¹³è¡¡ç¨³å®šä¸åˆ›æ–°';
                } else {
                    advice = 'å‘æŒ¥ä¸»è¦ä¼˜åŠ¿ï¼Œå¹³è¡¡å‘å±•ï¼Œæ³¨æ„æ•´åˆå¤šå…ƒç‰¹è´¨ï¼Œå¯»æ‰¾é€‚åˆè‡ªå·±çš„å‘å±•è·¯å¾„';
                }
            }

            // å®Œå–„ç½®ä¿¡åº¦åˆ†æ
            if (confidence === 'ä¸­ç­‰') {
                if (life === destiny || destiny === soul || life === soul) {
                    confidence = 'é«˜';
                } else if (Math.abs(life - destiny) <= 1 && Math.abs(destiny - soul) <= 1) {
                    confidence = 'é«˜';
                } else if (Math.abs(life - destiny) <= 3 && Math.abs(destiny - soul) <= 3) {
                    confidence = 'ä¸­ç­‰';
                } else {
                    confidence = 'ä½';
                }
            }

            // å®Œå–„å…«å­—ç‰¹å¾åˆ†æ
            if (baziTraits === 'ä¼ ç»Ÿå‘½ç†ç‰¹å¾') {
                const yearElement = STEM_TO_WUXING[bazi.yearStem] || '';
                const monthElement = STEM_TO_WUXING[bazi.monthStem] || '';
                const dayElement = STEM_TO_WUXING[bazi.dayStem] || '';
                const hourElement = STEM_TO_WUXING[bazi.hourStem] || '';
                
                if (yearElement) {
                    const elementTraits = {
                        'æœ¨': 'æœ¨æ€§ä¸»ä»ï¼Œå…·æœ‰ç”Ÿé•¿ã€å‘ä¸Šã€è¿›å–çš„ç‰¹è´¨',
                        'ç«': 'ç«æ€§ä¸»ç¤¼ï¼Œå…·æœ‰å…‰æ˜ã€æ¸©æš–ã€çƒ­æƒ…çš„ç‰¹è´¨',
                        'åœŸ': 'åœŸæ€§ä¸»ä¿¡ï¼Œå…·æœ‰åŒ…å®¹ã€ç¨³å®šã€åŠ¡å®çš„ç‰¹è´¨',
                        'é‡‘': 'é‡‘æ€§ä¸»ä¹‰ï¼Œå…·æœ‰åˆšæ¯…ã€æœæ–­ã€åŸåˆ™çš„ç‰¹è´¨',
                        'æ°´': 'æ°´æ€§ä¸»æ™ºï¼Œå…·æœ‰æ™ºæ…§ã€çµæ´»ã€åŒ…å®¹çš„ç‰¹è´¨'
                    };
                    
                    baziTraits = `å¹´å¹²${bazi.yearStem}(${yearElement})ï¼š${elementTraits[yearElement]}`;
                    
                    // æ·»åŠ æœˆä»¤åˆ†æ
                    if (monthElement) {
                        baziTraits += `<br>æœˆå¹²${bazi.monthStem}(${monthElement})ï¼šæœˆä»¤å½“ä»¤ï¼Œå½±å“æ—¥ä¸»å¼ºå¼±`;
                    }
                    
                    // æ·»åŠ æ—¥ä¸»åˆ†æ
                    if (dayElement) {
                        baziTraits += `<br>æ—¥å¹²${bazi.dayStem}(${dayElement})ï¼šæ—¥ä¸»ï¼Œæ€§æ ¼æ ¸å¿ƒ`;
                    }
                    
                    // æ·»åŠ æ—¶æŸ±åˆ†æ
                    if (hourElement) {
                        baziTraits += `<br>æ—¶å¹²${bazi.hourStem}(${hourElement})ï¼šæ—¶æŸ±ï¼Œæ™šå¹´å‘å±•`;
                    }
                }
            }

            // å®Œå–„æ•°å­—èƒ½é‡åˆ†æ
            if (numberEnergy === 'æ•°å­—èƒ½é‡ç‰¹å¾') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                const soulInfo = NUMBER_MEANINGS[soul] || {};
                
                numberEnergy = `ç”Ÿå‘½æ•°å­—${life}ï¼š${lifeInfo.traits || 'ç‰¹è´¨'} + å‘½è¿æ•°å­—${destiny}ï¼š${destinyInfo.traits || 'ç‰¹è´¨'}`;
                
                if (soul > 0) {
                    numberEnergy += `<br>çµé­‚æ•°å­—${soul}ï¼š${soulInfo.traits || 'å†…åœ¨ç‰¹è´¨'}`;
                }
                
                // æ·»åŠ äº”è¡Œåˆ†æ
                const elements = [lifeInfo.element, destinyInfo.element, soulInfo.element].filter(Boolean);
                if (elements.length > 0) {
                    const uniqueElements = [...new Set(elements)];
                    if (uniqueElements.length === 1) {
                        numberEnergy += `<br>äº”è¡Œä¸“ç²¾ï¼š${uniqueElements[0]}è¡Œï¼Œèƒ½é‡é›†ä¸­`;
                    } else {
                        numberEnergy += `<br>äº”è¡Œç»„åˆï¼š${uniqueElements.join('+')}ï¼Œèƒ½é‡å¤šå…ƒ`;
                    }
                }
            }

            // å®Œå–„MBTIå€¾å‘åˆ†æ
            if (mbtiTendency === 'MBTIå€¾å‘ç‰¹å¾') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    mbtiTendency = 'å¤–å‘ç›´è§‰æƒ…æ„Ÿæ„ŸçŸ¥å‹ï¼Œå¯Œæœ‰åˆ›é€ åŠ›å’Œé€‚åº”æ€§ï¼Œé€‚åˆåˆ›æ–°å’Œç¤¾äº¤å·¥ä½œ';
                } else if (life >= 7 && destiny >= 7) {
                    mbtiTendency = 'å†…å‘ç›´è§‰æ€è€ƒåˆ¤æ–­å‹ï¼Œæ“…é•¿æˆ˜ç•¥è§„åˆ’å’Œç³»ç»Ÿæ€è€ƒï¼Œé€‚åˆåˆ†æå’Œé¢†å¯¼å·¥ä½œ';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    mbtiTendency = 'å†…å‘æ„Ÿè§‰æ€è€ƒåˆ¤æ–­å‹ï¼Œé‡è§†ç§©åºå’Œå¯é æ€§ï¼Œé€‚åˆç®¡ç†å’Œæ‰§è¡Œå·¥ä½œ';
                } else {
                    mbtiTendency = 'å¹³è¡¡å‹ï¼Œå…·æœ‰å¤šå…ƒç‰¹è´¨ï¼Œéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µåˆ†æï¼Œé€‚åˆç»¼åˆå’Œåè°ƒå·¥ä½œ';
                }
            }

            return {
                mbtiType,
                confidence,
                baziTraits,
                numberEnergy,
                mbtiTendency,
                advice
            };
        }

        // æ˜¾ç¤ºä¸‰åˆä¸€ç»“æœ
        function displayTripleResult(result) {
            document.getElementById('tripleMBTIType').textContent = result.mbtiType;
            document.getElementById('tripleConfidence').textContent = `ç½®ä¿¡åº¦ï¼š${result.confidence}`;
            document.getElementById('tripleBaziTraits').innerHTML = result.baziTraits;
            document.getElementById('tripleNumberEnergy').innerHTML = result.numberEnergy;
            document.getElementById('tripleMBTITendency').innerHTML = result.mbtiTendency;
            document.getElementById('tripleAdvice').innerHTML = result.advice;

            document.getElementById('tripleAnalysisResult').classList.remove('hidden');
        }

        // â€”â€”â€” èåˆé¢˜åº“ä¸æ‰“åˆ† â€”â€”â€”
        const FUSION_QUESTIONS = [
            { id:1, d:'EI', when:{ any:[{ dayElementIn:['æœ¨','ç«'] }, { tenGodsTopIn:['æ¯”åŠ«','é£Ÿä¼¤'] }] }, t:'æ–°é¡¹ç›®Kickoffï¼Œä½ æ›´å¯èƒ½ï¼š', a:{ text:'ä¸»åŠ¨å®šæ¡†æ¶ã€æ‹‰é½èŠ‚å¥', mbti:{E:1.2}, bias:{ element:{ç«:+0.3,æœ¨:+0.2}, strength:{'åæ—º':-0.1,'åå¼±':+0.1} } }, b:{ text:'å…ˆå¬ä¿¡æ¯ã€å†ç»™å…³é”®æ„è§', mbti:{I:1.2}, bias:{ element:{æ°´:+0.3,é‡‘:+0.2} } } },
            { id:2, d:'EI', when:{ any:[{ dayElementIn:['é‡‘','æ°´'] }, { tenGodsTopIn:['å®˜æ€','å°'] }] }, t:'å¤§å‹ç¤¾äº¤åœºåˆï¼Œä½ æ›´ï¼š', a:{ text:'è‡ªç„¶ä¸²è”äººè„‰ï¼Œå¿«é€Ÿå»ºç«‹è¿æ¥', mbti:{E:1.0}, bias:{ element:{ç«:+0.2,æœ¨:+0.2} } }, b:{ text:'ç‚¹åˆ°ä¸ºæ­¢ï¼Œä¿ç•™ç²¾åŠ›åœ¨æ·±èŠä¸Š', mbti:{I:1.0}, bias:{ element:{é‡‘:+0.2,æ°´:+0.2} } } },
            { id:3, d:'SN', when:{ any:[{ dayElementIn:['åœŸ','é‡‘'] }, { monthBranchIn:['ä¸‘','è¾°','æœª','æˆŒ'] }] }, t:'åšæ–¹æ¡ˆä½ ä¼šä¼˜å…ˆï¼š', a:{ text:'è°ƒç ”æ¡ˆä¾‹ä¸çº¦æŸï¼Œå…ˆå¯è¡Œåä¼˜åŒ–', mbti:{S:1.2}, bias:{ element:{åœŸ:+0.3,é‡‘:+0.2} } }, b:{ text:'æ­å‡è®¾ä¸è“å›¾ï¼Œå…ˆæ–¹å‘åç»†åŒ–', mbti:{N:1.2}, bias:{ element:{æœ¨:+0.2,ç«:+0.2} } } },
            { id:4, d:'SN', when:{ any:[{ dayElementIn:['æœ¨','ç«'] }, { tenGodsTopIn:['é£Ÿä¼¤'] }] }, t:'é‡åˆ°æ¨¡ç³Šé—®é¢˜ä½ æ›´ï¼š', a:{ text:'æŠ“æ˜¾æ€§äº‹å®ï¼Œé€æ­¥æ”¶æ•›', mbti:{S:1.0} }, b:{ text:'ç”¨ç±»æ¯”å’Œæ„¿æ™¯å¿«é€Ÿå®šä½æœ¬è´¨', mbti:{N:1.0}, bias:{ element:{æœ¨:+0.2,ç«:+0.2} } } },
            { id:5, d:'TF', when:{ any:[{ tenGodsTopIn:['å®˜æ€','å°'] }, { dayElementIn:['é‡‘','æ°´'] }] }, t:'è£å†³æ—¶çš„ç¬¬ä¸€åŸåˆ™ï¼š', a:{ text:'ä¸€è‡´æ€§ä¸æ ‡å‡†ä¼˜å…ˆ', mbti:{T:1.2}, bias:{ element:{é‡‘:+0.3,æ°´:+0.2} } }, b:{ text:'å…³ç³»ä¸ä½“éªŒä¼˜å…ˆ', mbti:{F:1.2}, bias:{ element:{ç«:+0.2,æœ¨:+0.2} } } },
            { id:6, d:'TF', when:{ any:[{ tenGodsTopIn:['é£Ÿä¼¤','è´¢'] }, { dayElementIn:['ç«','æœ¨'] }] }, t:'åé¦ˆåŒäº‹æ—¶ä½ ä¼šï¼š', a:{ text:'å…ˆè®²æ¸…æ ‡å‡†ä¸æ”¹è¿›è·¯å¾„', mbti:{T:1.0} }, b:{ text:'å…ˆå…±æƒ…ï¼Œå†ç»™å»ºè®®', mbti:{F:1.0}, bias:{ element:{ç«:+0.2,æœ¨:+0.2} } } },
            { id:7, d:'JP', when:{ any:[{ dayElementIn:['åœŸ'] }, { strengthIn:['åæ—º'] }] }, t:'æ¨è¿›å¤æ‚ä»»åŠ¡ä½ æ›´ï¼š', a:{ text:'åˆ‡åˆ†é˜¶æ®µï¼Œæ§èŠ‚å¥ä¸é£é™©', mbti:{J:1.2}, bias:{ element:{åœŸ:+0.3} } }, b:{ text:'å¤šæ–¹æ¡ˆå¹¶è¡Œï¼ŒåŠ¨æ€è¯•é”™', mbti:{P:1.0}, bias:{ strength:{'åæ—º':-0.1,'åå¼±':+0.1} } } },
            { id:8, d:'JP', when:{ any:[{ dayElementIn:['æœ¨','æ°´'] }, { monthBranchIn:['äº¥','å­','ä¸‘'] }] }, t:'é¢å¯¹ä¸ç¡®å®šçš„å¸‚åœºçª—å£ï¼š', a:{ text:'æ‹‰é½è®¡åˆ’ä¸ä¾èµ–å†åŠ¨', mbti:{J:1.0} }, b:{ text:'å…ˆå°æ­¥è¯•æ¢æŠ¢æ—¶æœº', mbti:{P:1.2}, bias:{ element:{æœ¨:+0.2,æ°´:+0.2} } } },
            { id:9, d:'TF', cross:['EI'], t:'ç°åœºå†²çªå‡çº§ï¼Œä½ ä¼šï¼š', a:{ text:'å‡ºé¢å®šè§„åˆ™ä¸è¾¹ç•Œ', mbti:{T:1.0,E:0.4}, bias:{ tenGods:{'å®˜æ€':+0.2} } }, b:{ text:'ç§ä¸‹å®‰æŠšï¼Œå…ˆç¨³äººå¿ƒ', mbti:{F:1.0,I:0.4}, bias:{ element:{æ°´:+0.2} } } },
            { id:10, d:'SN', cross:['JP'], t:'0â†’1 äº§å“æ¢ç´¢æ—¶ï¼š', a:{ text:'åšMVPéªŒè¯å…³é”®äº‹å®', mbti:{S:1.0,J:0.4}, bias:{ element:{åœŸ:+0.2} } }, b:{ text:'å…ˆè·‘æ„¿æ™¯Demoæ”¶åé¦ˆ', mbti:{N:1.0,P:0.4}, bias:{ element:{æœ¨:+0.2,ç«:+0.2} } } },
            { id:11, d:'JP', when:{ any:[{ monthBranchIn:['å¯…','å¯','è¾°'] }, { dayElementIn:['æœ¨'] }] }, t:'èµ„æºæœ‰é™çš„æ˜¥å­£èŠ‚ç‚¹ï¼š', a:{ text:'ç«‹ç›®æ ‡æŠ¢ç”Ÿé•¿çª—å£', mbti:{J:1.0}, bias:{ element:{æœ¨:+0.2} } }, b:{ text:'ä¿ç•™å¼¹æ€§ç­‰ä¿¡å·æ˜ç¡®', mbti:{P:1.0}, bias:{ strength:{'åå¼±':+0.1} } } },
            { id:12, d:'TF', when:{ any:[{ monthBranchIn:['å·³','åˆ','æœª'] }, { dayElementIn:['ç«'] }] }, t:'é«˜å‹å‘¨æœŸä½ æ›´ï¼š', a:{ text:'é æµç¨‹ä¸æ ‡å‡†æŠ—å‹', mbti:{T:1.0}, bias:{ element:{é‡‘:+0.2} } }, b:{ text:'é å£«æ°”ä¸å…³ç³»æ’‘ä½', mbti:{F:1.0}, bias:{ element:{ç«:+0.2} } } },
            { id:13, d:'SN', t:'ä½ æ›´æ„¿æ„æ‰¿æ‹…çš„ä»·å€¼ï¼š', a:{ text:'å®ˆæ­£ä¸å¤ç›˜ï¼ˆç¨³å®š/æ²‰æ·€ï¼‰', mbti:{S:1.0,J:0.2}, bias:{ element:{åœŸ:+0.2,é‡‘:+0.1} } }, b:{ text:'ç ´å±€ä¸åˆ›å˜ï¼ˆæ‹“å±•/è¿æ¥ï¼‰', mbti:{N:1.0,P:0.2}, bias:{ element:{æœ¨:+0.2,ç«:+0.1} } } },
            { id:14, d:'EI', t:'å›¢é˜Ÿé‡Œä½ æ›´åƒï¼š', a:{ text:'å‘åŠ¨æœºï¼šæ‹‰åŠ¨èŠ‚å¥ä¸åä½œ', mbti:{E:1.0}, bias:{ element:{ç«:+0.2} } }, b:{ text:'ç¨³å®šå™¨ï¼šå…œåº•è´¨é‡ä¸é£é™©', mbti:{I:1.0}, bias:{ element:{åœŸ:+0.2,é‡‘:+0.1} } } },
            { id:15, d:'TF', when:{ any:[{ tenGodsTopIn:['å°'] }, { tenGodsTopIn:['è´¢'] }] }, t:'çŸ¥è¯†/èµ„æºè·å–æ—¶ä½ æ›´ï¼š', a:{ text:'ä»¥çŸ¥è¯†ä½“ç³»ä¸ºé”šï¼ˆå°ï¼‰', mbti:{T:0.6,N:0.4}, bias:{ tenGods:{'å°':+0.3} } }, b:{ text:'ä»¥æ”¶ç›Šä¸è½åœ°ä¸ºé”šï¼ˆè´¢ï¼‰', mbti:{S:0.6,J:0.4}, bias:{ tenGods:{'è´¢':+0.3} } } },
            { id:16, d:'JP', when:{ any:[{ tenGodsTopIn:['æ¯”åŠ«'] }, { tenGodsTopIn:['å®˜æ€'] }] }, t:'æ¨è¿›æ–¹å¼ä½ æ›´ï¼š', a:{ text:'æ‹‰é½ä¼™ä¼´å…±åŒå‡ºåŠ›ï¼ˆæ¯”åŠ«ï¼‰', mbti:{E:0.4,P:0.6}, bias:{ tenGods:{'æ¯”åŠ«':+0.3} } }, b:{ text:'è®¾å®šæƒè´£å‹ä½æ¨è¿›ï¼ˆå®˜æ€ï¼‰', mbti:{J:0.8}, bias:{ tenGods:{'å®˜æ€':+0.3} } } }
        ];

        function matches(ctx, when){
            if (!when) return true;
            const ok = (cond)=>{
                if (cond.dayElementIn && !cond.dayElementIn.includes(ctx.dayElement)) return false;
                if (cond.strengthIn && !cond.strengthIn.includes(ctx.strength)) return false;
                if (cond.monthBranchIn && !cond.monthBranchIn.includes(ctx.monthBranch)) return false;
                if (cond.tenGodsTopIn && !cond.tenGodsTopIn.includes(ctx.tenGodsTop)) return false;
                return true;
            };
            if (when.any) return when.any.some(ok);
            return ok(when);
        }

        function pickFusionQuestions(all, ctx, max = 12){
            const pool = all.filter(q => matches(ctx, q.when));
            const byD = { EI:[], SN:[], TF:[], JP:[] };
            pool.forEach(q => byD[q.d].push(q));
            const seq = [];
            const order = ['EI','SN','TF','JP'];
            let i = 0;
            while (seq.length < Math.min(max, pool.length) && i < 1000){
                const d = order[seq.length % 4];
                const arr = byD[d];
                if (arr && arr.length) seq.push(arr.shift());
                i++;
            }
            return seq;
        }

        function scoreOption(base, opt, ctx){
            const s = { ...base };
            Object.entries(opt.mbti || {}).forEach(([k,v])=>{ s[k] = (s[k]||0) + v; });
            const b = opt.bias || {};
            if (b.element && b.element[ctx.dayElement]) s.BIAS = (s.BIAS||0) + b.element[ctx.dayElement];
            if (b.strength && b.strength[ctx.strength]) s.BIAS = (s.BIAS||0) + b.strength[ctx.strength];
            if (b.tenGods && b.tenGods[ctx.tenGodsTop]) s.BIAS = (s.BIAS||0) + b.tenGods[ctx.tenGodsTop];
            return s;
        }

        function decideType(scores){
            const p = (a,b)=> (scores[a]||0) >= (scores[b]||0) ? a : b;
            return p('E','I') + p('S','N') + p('T','F') + p('J','P');
        }

        let fusionQuestions = [];

        function renderFusionQuiz(ctx){
            const root = document.getElementById('fusionQuiz');
            root.innerHTML = '';
            fusionQuestions = pickFusionQuestions(FUSION_QUESTIONS, ctx, 12);
            fusionQuestions.forEach((q, i)=>{
                const div = document.createElement('div');
                div.className = 'q';
                div.innerHTML = `<div style="font-weight:700">${i+1}. ${q.t}</div>`;
                ['a','b'].forEach((k,j)=>{
                    const optDiv = document.createElement('div');
                    optDiv.className = 'opt';
                    optDiv.innerHTML = `<label><input type="radio" name="fq${q.id}" value="${k}"> ${q[k].text}</label>`;
                    div.appendChild(optDiv);
                });
                root.appendChild(div);
            });
            document.getElementById('fusionTest').classList.remove('hidden');
        }

        function submitFusion(){
            if (!fusionQuestions.length){ showStatus('æ²¡æœ‰èåˆé¢˜å¯æäº¤'); return; }
            const ctx = window._lastFusionCtx;
            let scores = { E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0 };
            for (const q of fusionQuestions){
                const sel = document.querySelector(`input[name="fq${q.id}"]:checked`);
                if (!sel){ continue; }
                const opt = q[sel.value];
                scores = scoreOption(scores, opt, ctx);
            }
            const type = decideType(scores);
            document.getElementById('fusionResult').textContent = `èåˆç±»å‹ï¼š${type}`;
            const inlineType = document.getElementById('fusionInlineType');
            const inlineBias = document.getElementById('fusionInlineBias');
            if (inlineType) inlineType.textContent = type;
            if (inlineBias) inlineBias.textContent = `ååŒåç½®(Bazi)ï¼š${(scores.BIAS||0).toFixed(2)} Â· dayElement=${ctx.dayElement} Â· strength=${ctx.strength} Â· åç¥=${ctx.tenGodsTop}`;

            const detailEl = document.getElementById('fusionDetail');
            if (detailEl){
                detailEl.innerHTML = buildFusionDetail(type, ctx);
            }
        }

        const TYPE_SUMMARY = {
            INTJ: { desc:'ç­–ç•¥å‹Â·å†…æ•›è€Œæ·±è°‹è¿œè™‘ï¼Œç³»ç»Ÿæ€§å¼ºï¼Œæ“…é•¿å‰ç»è§„åˆ’ã€‚', careers:['æˆ˜ç•¥/å’¨è¯¢','æ•°æ®/ç®—æ³•','äº§å“æ¶æ„','æŠ•ç ”/é£æ§'], figures:['é©¬æ–¯å…‹ï¼ˆé£æ ¼ç±»æ¯”ï¼‰'] },
            INTP: { desc:'åˆ†æå‹Â·å¥½å¥‡ä¸é€»è¾‘å¹¶é‡ï¼Œåç ”ç©¶ä¸ç³»ç»Ÿå»ºæ„ã€‚', careers:['ç§‘ç ”/å·¥ç¨‹','åç«¯/ç³»ç»Ÿ','çŸ¥è¯†ç®¡ç†'], figures:['å›¾çµï¼ˆç±»æ¯”ï¼‰'] },
            ENTJ: { desc:'é¢†å¯¼å‹Â·æœæ–­ä¸ç»„ç»‡åŠ›ï¼Œæ“…é•¿ç›®æ ‡æ‹†è§£ä¸æ¨è¿›ã€‚', careers:['ç®¡ç†/è¿è¥','BD/æˆ˜ç•¥','å¤§é¡¹ç›®ç»Ÿç­¹'], figures:['ä¹”å¸ƒæ–¯ï¼ˆç±»æ¯”ï¼‰'] },
            ENTP: { desc:'åˆ›å˜å‹Â·ç‚¹å­ä¸è¯•é”™ï¼Œååˆ›æ–°ä¸è·¨ç•Œè¿æ¥ã€‚', careers:['åˆ›æ–°/åˆ›ä¸š','å¢é•¿/å¸‚åœº','æ–°äº§å“æ¢ç´¢'], figures:['è¾¾èŠ¬å¥‡ï¼ˆç±»æ¯”ï¼‰'] },
            INFJ: { desc:'æ´å¯Ÿå‹Â·ä»·å€¼ä¸æ„¿æ™¯ï¼Œæ“…é•¿äººæœ¬ä¸é•¿æœŸä¸»ä¹‰ã€‚', careers:['å“ç‰Œ/å…¬å…³','æ•™è‚²/å…¬ç›Š','äº§å“ä½“éªŒ'], figures:['ç”˜åœ°ï¼ˆç±»æ¯”ï¼‰'] },
            INFP: { desc:'ç†æƒ³å‹Â·è¡¨è¾¾ä¸å…±æƒ…ï¼Œåå†…å®¹ä¸äººæ–‡ä»·å€¼ã€‚', careers:['å†…å®¹/è®¾è®¡','æ–‡æ¡ˆ/ç­–åˆ’','ç”¨æˆ·ç ”ç©¶'], figures:['æ‘ä¸Šæ˜¥æ ‘ï¼ˆç±»æ¯”ï¼‰'] },
            ENFJ: { desc:'å¼•å¯¼å‹Â·æ²Ÿé€šä¸å½±å“ï¼Œæ“…é•¿å›¢é˜Ÿæ¿€å‘ä¸åŸ¹å…»ã€‚', careers:['ç»„ç»‡å‘å±•','é”€å”®/åŸ¹è®­','ç¤¾åŒºè¿è¥'], figures:['å¥¥æ™®æ‹‰ï¼ˆç±»æ¯”ï¼‰'] },
            ENFP: { desc:'çµæ„Ÿå‹Â·çƒ­æƒ…ä¸åˆ›é€ ï¼Œååˆ›æ–°ä½“éªŒä¸è¿æ¥ã€‚', careers:['åˆ›æ„/å“ç‰Œ','äº§å“æ¢ç´¢','ç¤¾åŒº/æ–°åª’ä½“'], figures:['ç½—å®¾Â·å¨å»‰å§†æ–¯ï¼ˆç±»æ¯”ï¼‰'] },
            ISTJ: { desc:'æ‰§è¡Œå‹Â·ç§©åºä¸å¯é ï¼Œæ“…é•¿æµç¨‹ä¸æ ‡å‡†åŒ–ã€‚', careers:['é¡¹ç›®ç®¡ç†','è´¨é‡/æ³•åŠ¡','è´¢ä¼š/åˆè§„'], figures:['å·´è²ç‰¹ï¼ˆç±»æ¯”ï¼‰'] },
            ISFJ: { desc:'å®ˆæŠ¤å‹Â·ç»†è‡´ä¸è´£ä»»ï¼Œæ“…é•¿æœåŠ¡ä¸ä¿éšœã€‚', careers:['è¿è¥æ”¯æŒ','HR/è¡Œæ”¿','åŒ»ç–—/æŠ¤ç†'], figures:['æˆ´å®‰å¨œï¼ˆç±»æ¯”ï¼‰'] },
            ESTJ: { desc:'ç»Ÿç­¹å‹Â·ç»„ç»‡ä¸æ•ˆç‡ï¼Œæ“…é•¿æ‰§è¡Œè½åœ°ã€‚', careers:['è¿è¥/ä¾›åº”é“¾','å›¢é˜Ÿç®¡ç†','æ”¿åºœ/å†›è­¦'], figures:['åˆ˜é‚¦ï¼ˆç±»æ¯”ï¼‰'] },
            ESFJ: { desc:'åä½œå‹Â·äººé™…ä¸ç§©åºï¼Œæ“…é•¿åè°ƒä¸æœåŠ¡ã€‚', careers:['å®¢æˆ·æˆåŠŸ','æ´»åŠ¨/å…¬å…³','æ•™è‚²/ç¤¾å·¥'], figures:['æµ·ä¼¦Â·å‡¯å‹’ï¼ˆç±»æ¯”ï¼‰'] },
            ISTP: { desc:'åŒ äººå‹Â·åŠ¨æ‰‹ä¸ä¼˜åŒ–ï¼Œåå·¥ç¨‹ä¸å®æ“ã€‚', careers:['å·¥ç¨‹/ç»´ä¿®','å®‰å…¨/åº”æ€¥','æ¸¸æˆ/ç¡¬ä»¶'], figures:['"é’¢é“ä¾ "æ‰˜å°¼Â·æ–¯å¡”å…‹ï¼ˆç±»æ¯”ï¼‰'] },
            ISFP: { desc:'å®¡ç¾å‹Â·ä½“éªŒä¸è¡¨è¾¾ï¼Œåè‰ºæœ¯ä¸ä½“éªŒã€‚', careers:['UI/UX','æ‘„å½±/éŸ³ä¹','äº§å“ä½“éªŒ'], figures:['æ¢µé«˜ï¼ˆç±»æ¯”ï¼‰'] },
            ESTP: { desc:'è¿›å–å‹Â·è¡ŒåŠ¨ä¸åšå¼ˆï¼Œåå¸‚åœºä¸å®æˆ˜ã€‚', careers:['é”€å”®/äº¤æ˜“','ä½“è‚²/èµ›äº‹','å±æœºå¤„ç†'], figures:['ç§‘æ¯”ï¼ˆç±»æ¯”ï¼‰'] },
            ESFP: { desc:'è¡¨ç°å‹Â·çƒ­æƒ…ä¸äº’åŠ¨ï¼Œåè¡¨æ¼”ä¸äº¤ä»˜ä½“éªŒã€‚', careers:['æ¼”å‘˜/ä¸»æŒ','ç›´æ’­/ç”µå•†','å®¢æœ/æ´»åŠ¨'], figures:['Lady Gagaï¼ˆç±»æ¯”ï¼‰'] }
        };

        const ELEMENT_TUNING = {
            æœ¨: { tilt:'+ åˆ›å˜/ç”Ÿé•¿', add:['äº§å“æ¢ç´¢','å“ç‰Œåˆ›æ„','æ•™è‚²/ç¤¾åŒº'] },
            ç«: { tilt:'+ è¡¨è¾¾/å½±å“', add:['å¸‚åœº/å¢é•¿','å…¬å…³/æ¼”è®²','æ´»åŠ¨è¿è¥'] },
            åœŸ: { tilt:'+ ç¨³å®š/æ²»ç†', add:['PMO/æµç¨‹','è´¢ä¼š/æ³•åŠ¡','åˆè§„/æ”¿åŠ¡'] },
            é‡‘: { tilt:'+ æ ‡å‡†/å†³æ–­', add:['é£æ§/å®¡è®¡','äº¤æ˜“/è°ˆåˆ¤','ç®¡ç†/ç»Ÿç­¹'] },
            æ°´: { tilt:'+ æ´å¯Ÿ/è¿æ¥', add:['ç”¨æˆ·ç ”ç©¶','æ•°æ®/ç­–ç•¥','çŸ¥è¯†ç®¡ç†'] }
        };

        const STRENGTH_TUNING = {
            'åæ—º': { tilt:'+ è¿›æ”»/è¾“å‡º', add:['å‰å°å¢é•¿','é”€å”®æ‹“å±•','ç­–ç•¥æ¨è¿›'], strategy:'èšç„¦è¾“å‡ºä¸å½±å“ï¼Œæ³¨æ„æ”¶æ•›ä¸ååŒï¼Œé¿å…è¿‡åº¦æ¶ˆè€—å›¢é˜Ÿä¿¡ç”¨' },
            'åå¼±': { tilt:'+ é˜²å®ˆ/ç§¯ç´¯', add:['åå°æ”¯æŒ','ç ”ç©¶æ²‰æ·€','æµç¨‹æ²»ç†'], strategy:'å…ˆç«‹æ ¹åŸºä¸èƒ½åŠ›ï¼Œäº‰å–èµ„æºä¸è´µäººåŠ©åŠ›ï¼Œé€æ­¥æ‰©å¤§å½±å“åŠå¾„' },
            'å¹³':   { tilt:'+ å¹³è¡¡/è°ƒå’Œ', add:['è·¨éƒ¨é—¨ååŒ','PMO/é¡¹ç›®','äº§å“åè°ƒ'], strategy:'å› åŠ¿åˆ©å¯¼ã€å¹³è¡¡æ¨è¿›ï¼Œä¿æŒèŠ‚å¥ä¸å¥åº·è¾¹ç•Œ' }
        };

        function buildFusionDetail(type, ctx){
            const base = TYPE_SUMMARY[type] || { desc:'æ··åˆå‹', careers:[], figures:[] };
            const tuneEl = ELEMENT_TUNING[ctx.dayElement] || { tilt:'', add:[] };
            const tuneSt = STRENGTH_TUNING[ctx.strength] || { tilt:'', add:[], strategy:'' };
            const jobs = Array.from(new Set([...(base.careers||[]), ...tuneEl.add, ...tuneSt.add]));
            return `
                <div><strong>${type}</strong> Â· ${base.desc} ${tuneEl.tilt ? `ï¼ˆæ—¥ä¸»${ctx.dayElement} ${tuneEl.tilt}` : ''}${tuneSt.tilt ? `ï¼Œ${tuneSt.tilt}` : ''}${tuneEl.tilt || tuneSt.tilt ? 'ï¼‰' : ''}</div>
                <div style=\"margin-top:6px\"><strong>é€‚é…èŒä¸šï¼š</strong>${jobs.join('ã€') || 'ä¾å…´è¶£ä¸èƒ½åŠ›å®šå‘'}</div>
                <div style=\"margin-top:6px\"><strong>å‘å±•ç­–ç•¥ï¼š</strong>${tuneSt.strategy || 'æ ¹æ®å¤§åŠ¿çµæ´»å–ç”¨ï¼Œç»´æŒèŠ‚å¥ä¸è¾¹ç•Œ'}</div>
                <div style=\"margin-top:6px\"><strong>ä»£è¡¨äººç‰©é£æ ¼ï¼š</strong>${(base.figures||[]).join('ã€') || 'â€”'}ï¼ˆç±»æ¯”ï¼Œéè®¤è¯ï¼‰</div>
            `;
        }

        function analyzeDayMasterStrength(dayStem, stems, monthBranch) {
            const dm = { element: STEM_TO_WUXING[dayStem], polarity: STEM_POLARITY[dayStem] };
            let score = 0;
            
            stems.forEach(s => {
                const si = { element: STEM_TO_WUXING[s], polarity: STEM_POLARITY[s] };
                if (!si.element) return;
                if (si.element === dm.element) score += 1;
                else if (SHENG[si.element] === dm.element) score += 0.6;
                else if (SHENG[dm.element] === si.element) score -= 0.4;
                else if (KE[dm.element] === si.element) score -= 0.5;
                else if (KE[si.element] === dm.element) score -= 0.7;
            });

            if (monthBranch) {
                const me = dm.element;
                const be = BRANCH_TO_WUXING[monthBranch];
                if (be) {
                    if (be === me) score += 1.0;
                    else if (SHENG[be] === me) score += 0.5;
                    else if (KE[be] === me) score -= 0.6;
                    else if (SHENG[me] === be) score -= 0.2;
                }
            }

            let verdict = 'å¹³';
            if (score >= 2) verdict = 'åæ—º';
            else if (score <= 0.5) verdict = 'åå¼±';
            
            return { score: Number(score.toFixed(2)), verdict };
        }

        function analyzeTenGods(dayStem, stems) {
            const labels = ['å¹´å¹²', 'æœˆå¹²', 'æ—¥å¹²', 'æ—¶å¹²'];
            let result = '';
            
            stems.forEach((s, idx) => {
                if (idx === 2) {
                    result += `${labels[idx]}ï¼š${s}ï¼ˆæ—¥ä¸»ï¼‰<br>`;
                } else {
                    const god = getTenGod(dayStem, s);
                    result += `${labels[idx]}ï¼š${s} â†’ ${god}<br>`;
                }
            });
            
            return result;
        }

        function getTenGod(dayStem, otherStem) {
            const d = { element: STEM_TO_WUXING[dayStem], polarity: STEM_POLARITY[dayStem] };
            const o = { element: STEM_TO_WUXING[otherStem], polarity: STEM_POLARITY[otherStem] };
            
            if (!d.element || !o.element) return 'â€”';
            if (d.element === o.element) return (d.polarity === o.polarity) ? 'æ¯”è‚©' : 'åŠ«è´¢';
            if (SHENG[o.element] === d.element) return (d.polarity !== o.polarity) ? 'æ­£å°' : 'åå°';
            if (SHENG[d.element] === o.element) return (d.polarity !== o.polarity) ? 'é£Ÿç¥' : 'ä¼¤å®˜';
            if (KE[d.element] === o.element) return (d.polarity !== o.polarity) ? 'æ­£è´¢' : 'åè´¢';
            if (KE[o.element] === d.element) return (d.polarity !== o.polarity) ? 'æ­£å®˜' : 'ä¸ƒæ€';
            return 'â€”';
        }

        function analyzeRegulation(dayElement, monthBranch, wuxing) {
            const monthElement = BRANCH_TO_WUXING[monthBranch];
            if (!monthElement || !dayElement) return 'æ— æ³•åˆ†æ';
            
            if (monthElement === dayElement) {
                return 'æœˆä»¤å½“ä»¤ï¼Œæ—¥ä¸»å¾—ä»¤ï¼Œæ°”åŠ¿è¾ƒå¼º';
            } else if (SHENG[monthElement] === dayElement) {
                return 'æœˆä»¤ç”Ÿèº«ï¼Œæ—¥ä¸»å¾—ç”Ÿï¼Œæ ¹åŸºç¨³å›º';
            } else if (KE[monthElement] === dayElement) {
                return 'æœˆä»¤å…‹èº«ï¼Œæ—¥ä¸»å—å…‹ï¼Œéœ€è¦è°ƒå€™';
            } else if (SHENG[dayElement] === monthElement) {
                return 'æ—¥ä¸»ç”Ÿæœˆä»¤ï¼Œæ³„æ°”è¾ƒå¤šï¼Œéœ€è¦è¡¥ç›Š';
            } else {
                return 'æœˆä»¤ä¸æ—¥ä¸»å…³ç³»ä¸­æ€§ï¼Œæ•´ä½“å¹³è¡¡';
            }
        }

        function analyzePattern(dayStem, stems, wuxing) {
            const dayElement = STEM_TO_WUXING[dayStem];
            const fireCount = wuxing['ç«'] || 0;
            const waterCount = wuxing['æ°´'] || 0;
            const earthCount = wuxing['åœŸ'] || 0;
            const woodCount = wuxing['æœ¨'] || 0;
            const metalCount = wuxing['é‡‘'] || 0;

            if (fireCount > 3) return 'ç«æ—ºæ ¼ï¼šçƒ­æƒ…ä¸»åŠ¨ï¼Œå¯Œæœ‰åˆ›é€ åŠ›ï¼Œä½†éœ€æ³¨æ„æƒ…ç»ªæ§åˆ¶';
            if (waterCount > 3) return 'æ°´æ—ºæ ¼ï¼šæ™ºæ…§æ·±æ²‰ï¼Œå–„äºæ€è€ƒï¼Œä½†éœ€æ³¨æ„è¡ŒåŠ¨åŠ›';
            if (earthCount > 3) return 'åœŸæ—ºæ ¼ï¼šç¨³é‡åŠ¡å®ï¼Œé‡è§†ç§©åºï¼Œä½†éœ€æ³¨æ„çµæ´»æ€§';
            if (woodCount > 3) return 'æœ¨æ—ºæ ¼ï¼šç”Ÿæœºå‹ƒå‹ƒï¼Œå¯Œæœ‰ç†æƒ³ï¼Œä½†éœ€æ³¨æ„ç¨³å®šæ€§';
            if (metalCount > 3) return 'é‡‘æ—ºæ ¼ï¼šåˆšæ¯…æœæ–­ï¼Œé‡è§†åŸåˆ™ï¼Œä½†éœ€æ³¨æ„åŒ…å®¹æ€§';
            
            return 'ä¸­å’Œæ ¼ï¼šäº”è¡Œç›¸å¯¹å‡è¡¡ï¼Œæ€§æ ¼ç‰¹å¾ä¸æ˜æ˜¾ï¼Œé€‚åº”æ€§è¾ƒå¼º';
        }

        function analyzeIntegration(bazi, wuxing) {
            const dayStem = bazi.stems[2];
            const dayElement = STEM_TO_WUXING[dayStem];
            const strength = analyzeDayMasterStrength(dayStem, bazi.stems, bazi.branches[1]);

            // æ€§æ ¼æ ¹åŸº
            const foundation = getPersonalityFoundation(dayElement, strength.verdict);
            document.getElementById('personalityFoundation').innerHTML = foundation;

            // å‘å±•è·¯å¾„
            const path = getDevelopmentPath(dayElement, strength.verdict, wuxing);
            document.getElementById('developmentPath').innerHTML = path;

            // æ½œåœ¨æŒ‘æˆ˜
            const challenges = getPotentialChallenges(dayElement, strength.verdict, wuxing);
            document.getElementById('potentialChallenges').innerHTML = challenges;

            // äººç”Ÿå»ºè®®
            const advice = getLifeAdvice(dayElement, strength.verdict, wuxing);
            document.getElementById('lifeAdvice').innerHTML = advice;
        }

        function getPersonalityFoundation(dayElement, strength) {
            const foundations = {
                'æœ¨': 'æœ¨æ€§ä¸»ä»ï¼Œå…·æœ‰ç”Ÿé•¿ã€å‘ä¸Šã€è¿›å–çš„ç‰¹è´¨',
                'ç«': 'ç«æ€§ä¸»ç¤¼ï¼Œå…·æœ‰å…‰æ˜ã€æ¸©æš–ã€çƒ­æƒ…çš„ç‰¹è´¨',
                'åœŸ': 'åœŸæ€§ä¸»ä¿¡ï¼Œå…·æœ‰åŒ…å®¹ã€ç¨³å®šã€åŠ¡å®çš„ç‰¹è´¨',
                'é‡‘': 'é‡‘æ€§ä¸»ä¹‰ï¼Œå…·æœ‰åˆšæ¯…ã€æœæ–­ã€åŸåˆ™çš„ç‰¹è´¨',
                'æ°´': 'æ°´æ€§ä¸»æ™ºï¼Œå…·æœ‰æ™ºæ…§ã€çµæ´»ã€åŒ…å®¹çš„ç‰¹è´¨'
            };
            
            const base = foundations[dayElement] || 'äº”è¡Œç‰¹å¾ä¸æ˜æ˜¾';
            return `${base}ã€‚æ—¥ä¸»${strength}ï¼Œ${strength === 'åæ—º' ? 'æ€§æ ¼ç‰¹å¾çªå‡ºï¼Œä¼˜åŠ¿æ˜æ˜¾' : strength === 'åå¼±' ? 'æ€§æ ¼æ¸©å’Œï¼Œéœ€è¦åŸ¹å…»' : 'æ€§æ ¼å¹³è¡¡ï¼Œé€‚åº”æ€§è¾ƒå¼º'}ã€‚`;
        }

        function getDevelopmentPath(dayElement, strength, wuxing) {
            if (strength === 'åæ—º') {
                return 'å‘æŒ¥ä¼˜åŠ¿ï¼šåˆ©ç”¨æ—¥ä¸»æ—ºç›¸çš„ä¼˜åŠ¿ï¼Œåœ¨æ“…é•¿çš„é¢†åŸŸæ·±è€•å‘å±•ã€‚æ³¨æ„é€‚åº¦æ”¶æ•›ï¼Œé¿å…è¿‡äºå¼ºåŠ¿ã€‚';
            } else if (strength === 'åå¼±') {
                return 'è¡¥ç›Šå‘å±•ï¼šé€šè¿‡å­¦ä¹ å’Œå®è·µå¢å¼ºæ—¥ä¸»åŠ›é‡ï¼ŒåŸ¹å…»æ ¸å¿ƒèƒ½åŠ›ã€‚å¯»æ‰¾è´µäººç›¸åŠ©ï¼Œå»ºç«‹æ”¯æŒç³»ç»Ÿã€‚';
            } else {
                return 'å¹³è¡¡å‘å±•ï¼šä¿æŒäº”è¡Œå¹³è¡¡ï¼Œå…¨é¢å‘å±•å„é¡¹èƒ½åŠ›ã€‚æ ¹æ®å¤§è¿æµå¹´è°ƒæ•´å‘å±•é‡ç‚¹ã€‚';
            }
        }

        function getPotentialChallenges(dayElement, strength, wuxing) {
            const challenges = {
                'æœ¨': 'æœ¨æ—ºæ˜“æŠ˜ï¼Œéœ€æ³¨æ„æƒ…ç»ªæ§åˆ¶å’Œäººé™…å…³ç³»å¤„ç†',
                'ç«': 'ç«æ—ºæ˜“ç‡¥ï¼Œéœ€æ³¨æ„è€å¿ƒå’Œç»†èŠ‚ç®¡ç†',
                'åœŸ': 'åœŸæ—ºæ˜“æ»ï¼Œéœ€æ³¨æ„åˆ›æ–°æ€ç»´å’Œçµæ´»æ€§',
                'é‡‘': 'é‡‘æ—ºæ˜“åˆšï¼Œéœ€æ³¨æ„åŒ…å®¹æ€§å’Œäººé™…å…³ç³»',
                'æ°´': 'æ°´æ—ºæ˜“æµï¼Œéœ€æ³¨æ„ç¨³å®šæ€§å’Œæ‰§è¡ŒåŠ›'
            };
            
            const base = challenges[dayElement] || 'æ— æ˜æ˜¾æŒ‘æˆ˜';
            return `${base}ã€‚${strength === 'åæ—º' ? 'æ—¥ä¸»è¿‡æ—ºæ—¶ï¼Œè¿™äº›æŒ‘æˆ˜ä¼šæ›´åŠ æ˜æ˜¾' : strength === 'åå¼±' ? 'æ—¥ä¸»åå¼±æ—¶ï¼Œéœ€è¦å…‹æœè¿™äº›æŒ‘æˆ˜æ¥å¢å¼ºè‡ªèº«' : 'æ—¥ä¸»å¹³è¡¡æ—¶ï¼Œè¿™äº›æŒ‘æˆ˜ç›¸å¯¹æ¸©å’Œ'}ã€‚`;
        }

        function getLifeAdvice(dayElement, strength, wuxing) {
            const advice = {
                'æœ¨': 'åŸ¹å…»è€å¿ƒï¼Œå­¦ä¼šå€¾å¬ï¼Œåœ¨å›¢é˜Ÿä¸­å‘æŒ¥é¢†å¯¼ä½œç”¨',
                'ç«': 'ä¿æŒçƒ­æƒ…ï¼Œæ³¨æ„ç»†èŠ‚ï¼Œåœ¨åˆ›æ–°ä¸­å±•ç°æ‰å',
                'åœŸ': 'ä¿æŒç¨³å®šï¼ŒåŸ¹å…»åˆ›æ–°ï¼Œåœ¨åŠ¡å®ä¸­è¿½æ±‚å“è¶Š',
                'é‡‘': 'åšæŒåŸåˆ™ï¼Œå­¦ä¼šåŒ…å®¹ï¼Œåœ¨åˆšæ¯…ä¸­å±•ç°æ™ºæ…§',
                'æ°´': 'ä¿æŒæ™ºæ…§ï¼Œå¢å¼ºè¡ŒåŠ¨ï¼Œåœ¨çµæ´»ä¸­è¿½æ±‚ç¨³å®š'
            };
            
            const base = advice[dayElement] || 'ä¿æŒå¹³è¡¡å‘å±•';
            return `${base}ã€‚${strength === 'åæ—º' ? 'å‘æŒ¥ä¼˜åŠ¿çš„åŒæ—¶ï¼Œæ³¨æ„è‡ªæˆ‘è°ƒèŠ‚å’Œä»–äººæ„Ÿå—' : strength === 'åå¼±' ? 'åœ¨è¡¥ç›Šè‡ªèº«çš„åŒæ—¶ï¼Œå¯»æ‰¾é€‚åˆè‡ªå·±çš„å‘å±•é“è·¯' : 'åœ¨å¹³è¡¡å‘å±•ä¸­ï¼Œå¯»æ‰¾çªç ´å’Œåˆ›æ–°çš„æœºä¼š'}ã€‚`;
        }

        // åˆ†äº«/è¿”å›å·²å–æ¶ˆï¼šå¦‚éœ€æ¢å¤ï¼Œå¯åœ¨æ­¤å¤„é‡æ–°å¯ç”¨å‡½æ•°

        // ï¼ˆåˆ é™¤ï¼‰å‘½ç†çŸ¥è¯†é¢˜ä¸ç›¸å…³é€»è¾‘ï¼Œç»Ÿä¸€ä½¿ç”¨èåˆæµ‹è¯„

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥æ ‡ç­¾é¡µå…ƒç´ 
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('æ‰¾åˆ°æ ‡ç­¾é¡µæ•°é‡:', tabs.length);
            console.log('æ‰¾åˆ°æ ‡ç­¾å†…å®¹æ•°é‡:', tabContents.length);
            
            // æ£€æŸ¥æ•°å­—å‘½ç†ç›¸å…³å…ƒç´ 
            const numerologyContent = document.getElementById('numerology-content');
            const numerologyBtn = document.querySelector('button[onclick="analyzeNumerology()"]');
            
            console.log('æ•°å­—å‘½ç†å†…å®¹å…ƒç´ :', numerologyContent);
            console.log('æ•°å­—å‘½ç†æŒ‰é’®:', numerologyBtn);
            
            // æ£€æŸ¥å‡½æ•°æ˜¯å¦å¯ç”¨
            console.log('analyzeNumerologyå‡½æ•°:', typeof analyzeNumerology);
            console.log('switchTabå‡½æ•°:', typeof switchTab);
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼');
        });

        // åŠŸèƒ½å¡ç‰‡ç‚¹å‡»å¤„ç†
        function showFeatureInfo(featureType) {
            console.log('ç‚¹å‡»åŠŸèƒ½å¡ç‰‡:', featureType);
            
            if (featureType === 'numerology') {
                // åˆ‡æ¢åˆ°æ•°å­—å‘½ç†æ ‡ç­¾é¡µ
                switchTab('numerology');
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const statusElement = document.querySelector('.feature-status.coming-soon');
                if (statusElement) {
                    statusElement.textContent = 'åŠŸèƒ½å·²å°±ç»ª';
                    statusElement.classList.remove('coming-soon');
                    statusElement.classList.add('ready');
                }
                
                console.log('æ•°å­—å‘½ç†åŠŸèƒ½å·²æ¿€æ´»ï¼');
            }
        }

        // ç›´æ¥æµ‹è¯•æ•°å­—å‘½ç†åŠŸèƒ½
        function testNumerologyDirectly() {
            console.log('ğŸ§ª ç›´æ¥æµ‹è¯•æ•°å­—å‘½ç†åŠŸèƒ½');
            
            // ç›´æ¥åˆ‡æ¢åˆ°æ•°å­—å‘½ç†æ ‡ç­¾é¡µ
            switchTab('numerology');
            
            // æ¨¡æ‹Ÿè¾“å…¥æ•°æ®
            const testDate = '1990-01-01';
            const testName = 'å¼ ä¸‰';
            
            // è®¾ç½®æµ‹è¯•æ•°æ®
            if (document.getElementById('nDate')) {
                document.getElementById('nDate').value = testDate;
            }
            if (document.getElementById('nName')) {
                document.getElementById('nName').value = testName;
            }
            
            console.log('æµ‹è¯•æ•°æ®å·²è®¾ç½®:', { testDate, testName });
            console.log('è¯·æ£€æŸ¥æ•°å­—å‘½ç†æ ‡ç­¾é¡µæ˜¯å¦æ˜¾ç¤ºå†…å®¹');
        }

        // è°ƒè¯•æ ‡ç­¾é¡µåˆ‡æ¢
        function debugTabSwitching() {
            console.log('ğŸ› å¼€å§‹è°ƒè¯•æ ‡ç­¾é¡µåˆ‡æ¢');
            
            // æ£€æŸ¥æ‰€æœ‰æ ‡ç­¾é¡µå…ƒç´ 
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('æ ‡ç­¾é¡µæ•°é‡:', tabs.length);
            console.log('æ ‡ç­¾å†…å®¹æ•°é‡:', tabContents.length);
            
            // æ£€æŸ¥æ¯ä¸ªæ ‡ç­¾é¡µ
            tabs.forEach((tab, index) => {
                console.log(`æ ‡ç­¾é¡µ ${index}:`, tab.textContent, 'active:', tab.classList.contains('active'));
            });
            
            // æ£€æŸ¥æ¯ä¸ªæ ‡ç­¾å†…å®¹
            tabContents.forEach((content, index) => {
                console.log(`æ ‡ç­¾å†…å®¹ ${index}:`, content.id, 'active:', content.classList.contains('active'), 'display:', window.getComputedStyle(content).display);
            });
            
            // å°è¯•æ‰‹åŠ¨åˆ‡æ¢
            console.log('å°è¯•æ‰‹åŠ¨åˆ‡æ¢åˆ°æ•°å­—å‘½ç†æ ‡ç­¾é¡µ...');
            switchTab('numerology');
            
            // æ£€æŸ¥åˆ‡æ¢åçš„çŠ¶æ€
            setTimeout(() => {
                const numerologyContent = document.getElementById('numerology-content');
                if (numerologyContent) {
                    console.log('æ•°å­—å‘½ç†å†…å®¹å…ƒç´ çŠ¶æ€:', {
                        id: numerologyContent.id,
                        classes: numerologyContent.className,
                        display: window.getComputedStyle(numerologyContent).display,
                        visible: numerologyContent.offsetParent !== null
                    });
                } else {
                    console.error('æ‰¾ä¸åˆ°æ•°å­—å‘½ç†å†…å®¹å…ƒç´ ï¼');
                }
            }, 100);
        }

        // å¼ºåˆ¶æ˜¾ç¤ºæ•°å­—å‘½ç†å†…å®¹
        function forceShowNumerology() {
            console.log('ğŸ” å¼ºåˆ¶æ˜¾ç¤ºæ•°å­—å‘½ç†å†…å®¹');
            
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæ•°å­—å‘½ç†å†…å®¹
            const numerologyContent = document.getElementById('numerology-content');
            if (numerologyContent) {
                numerologyContent.style.display = 'block';
                numerologyContent.classList.add('active');
                console.log('âœ… æ•°å­—å‘½ç†å†…å®¹å·²å¼ºåˆ¶æ˜¾ç¤º');
                
                // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const numerologyTab = document.querySelector('.tab[onclick*="numerology"]');
                if (numerologyTab) {
                    numerologyTab.classList.add('active');
                }
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°æ•°å­—å‘½ç†å†…å®¹å…ƒç´ ');
            }
        }

        // åˆ†æäººæ ¼ç‰¹å¾ï¼ˆå…«å­—+MBTIèåˆåˆ†æï¼‰
        async function analyzePersonality() {
            console.log('ğŸ§  å¼€å§‹äººæ ¼åˆ†æ...');
            
            // æ£€æŸ¥lunaråº“æ˜¯å¦å·²åŠ è½½
            if (!window.Solar && !(window.Lunar && window.Lunar.Solar)) {
                console.log('lunaråº“æœªåŠ è½½ï¼Œå°è¯•åŠ è½½...');
                try {
                    const loaded = await loadLunarFromFallbacks();
                    if (!loaded) {
                        alert('å‘½ç†åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        return;
                    }
                } catch (error) {
                    console.error('åŠ è½½lunaråº“å¤±è´¥:', error);
                    alert('å‘½ç†åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
            }
            
            // è·å–è¾“å…¥æ•°æ®
            const birthDate = document.getElementById('bDate').value;
            const birthTime = document.getElementById('bTime').value;
            
            if (!birthDate || !birthTime) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å‡ºç”Ÿä¿¡æ¯ï¼ˆæ—¥æœŸã€æ—¶é—´ï¼‰');
                return;
            }
            
            try {
                console.log('è§£æå‡ºç”Ÿæ—¶é—´:', { birthDate, birthTime });
                
                // è§£æå‡ºç”Ÿæ—¶é—´
                const [year, month, day] = birthDate.split('-').map(Number);
                const [hour, minute] = birthTime.split(':').map(Number);
                
                console.log('è§£æåçš„æ—¶é—´:', { year, month, day, hour, minute });
                
                // è®¡ç®—å…«å­—
                const pillars = safeGetPillars(year, month, day, hour, minute);
                console.log('è®¡ç®—å¾—åˆ°çš„å…«å­—:', pillars);
                
                if (pillars && pillars.pillarText) {
                    const pillarText = pillars.pillarText;
                    document.getElementById('pillars').textContent = pillarText;
                    document.getElementById('stemsBranches').textContent = `å¹´æŸ±: ${pillarText.split('ï½œ')[0]} | æœˆæŸ±: ${pillarText.split('ï½œ')[1]} | æ—¥æŸ±: ${pillarText.split('ï½œ')[2]} | æ—¶æŸ±: ${pillarText.split('ï½œ')[3]}`;
                    
                    // åˆ†æäº”è¡Œ
                    analyzeWuxing(pillarText);
                    
                    // æ˜¾ç¤ºåˆ†æç»“æœåŒºåŸŸ
                    document.getElementById('mbtiAnalysis').classList.remove('hidden');
                    document.getElementById('baziAnalysis').classList.remove('hidden');
                    document.getElementById('integrationAnalysis').classList.remove('hidden');
                    
                    // æ‰§è¡ŒMBTIåˆ†æ
                    performMBTIAnalysis(pillarText);
                    
                    // æ‰§è¡Œå…«å­—åˆ†æ
                    performBaziAnalysis(pillarText);
                    
                    // æ‰§è¡Œèåˆåˆ†æ
                    performIntegrationAnalysis(pillarText);
                    
                    console.log('âœ… äººæ ¼åˆ†æå®Œæˆ');
                } else {
                    throw new Error('æ— æ³•è®¡ç®—å…«å­—');
                }
                
            } catch (error) {
                console.error('äººæ ¼åˆ†æå¤±è´¥:', error);
                alert('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®');
            }
        }
        
        // åˆ†æäº”è¡Œ
        function analyzeWuxing(pillars) {
            const wuxingCount = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
            const elements = pillars.split('ï½œ').join('').split('');
            
            elements.forEach(char => {
                if (STEM_TO_WUXING[char]) {
                    wuxingCount[STEM_TO_WUXING[char]]++;
                }
                if (BRANCH_TO_WUXING[char]) {
                    wuxingCount[BRANCH_TO_WUXING[char]]++;
                }
            });
            
            const wuxingDiv = document.getElementById('wuxing');
            wuxingDiv.innerHTML = '';
            
            Object.entries(wuxingCount).forEach(([element, count]) => {
                const elementDiv = document.createElement('div');
                elementDiv.className = 'pill';
                elementDiv.style.background = getElementColor(element);
                elementDiv.textContent = `${element}: ${count}`;
                wuxingDiv.appendChild(elementDiv);
            });
        }
        
        // è·å–äº”è¡Œé¢œè‰²
        function getElementColor(element) {
            const colors = {
                'æœ¨': '#4ade80',
                'ç«': '#f87171',
                'åœŸ': '#fbbf24',
                'é‡‘': '#fbbf24',
                'æ°´': '#60a5fa'
            };
            return colors[element] || '#6b7280';
        }
        
        // æ‰§è¡ŒMBTIåˆ†æ
        function performMBTIAnalysis(pillars) {
            // åŸºäºå…«å­—ç‰¹å¾æ¨æ–­MBTIå€¾å‘
            const analysis = {
                'EI': 'åŸºäºæ—¥ä¸»å¼ºå¼±å’Œäº”è¡Œé…ç½®åˆ†æå¤–å‘/å†…å‘å€¾å‘',
                'SN': 'åŸºäºå¤©å¹²åœ°æ”¯çš„æŠ½è±¡/å…·ä½“ç‰¹å¾åˆ†æ',
                'TF': 'åŸºäºäº”è¡Œç”Ÿå…‹å…³ç³»çš„ç†æ€§/æ„Ÿæ€§å€¾å‘',
                'JP': 'åŸºäºæ—¶æŸ±å’Œæ ¼å±€ç‰¹å¾çš„åˆ¤æ–­/æ„ŸçŸ¥åå¥½'
            };
            
            document.getElementById('eiAnalysis').textContent = analysis.EI;
            document.getElementById('snAnalysis').textContent = analysis.SN;
            document.getElementById('tfAnalysis').textContent = analysis.TF;
            document.getElementById('jpAnalysis').textContent = analysis.JP;
        }
        
        // æ‰§è¡Œå…«å­—åˆ†æ
        function performBaziAnalysis(pillars) {
            const analysis = {
                'dayMasterStrength': 'æ—¥ä¸»ä¸º' + pillars.split('ï½œ')[2].charAt(0) + 'ï¼Œäº”è¡Œå±æ€§ä¸º' + STEM_TO_WUXING[pillars.split('ï½œ')[2].charAt(0)],
                'tenGods': 'åŸºäºæ—¥ä¸»åˆ†æåç¥é…ç½®å’Œäººé™…å…³ç³»',
                'regulation': 'äº”è¡Œè°ƒå€™å»ºè®®ï¼š' + getRegulationAdvice(pillars),
                'pattern': 'æ ¼å±€ç‰¹å¾ï¼š' + getPatternAnalysis(pillars)
            };
            
            document.getElementById('dayMasterStrength').textContent = analysis.dayMasterStrength;
            document.getElementById('tenGods').textContent = analysis.tenGods;
            document.getElementById('regulation').textContent = analysis.regulation;
            document.getElementById('pattern').textContent = analysis.pattern;
        }
        
        // æ‰§è¡Œèåˆåˆ†æ
        function performIntegrationAnalysis(pillars) {
            // ç”ŸæˆèåˆMBTIç±»å‹
            const fusionType = generateFusionMBTI(pillars);
            document.getElementById('fusionInlineType').textContent = fusionType;
            document.getElementById('fusionInlineBias').textContent = 'åŸºäºå…«å­—ç‰¹å¾çš„MBTIæ¨æ–­';
            
            // èåˆåˆ†æç»“æœ
            const integration = {
                'personalityFoundation': 'å…«å­—æ ¹åŸºï¼š' + getFoundationAnalysis(pillars),
                'developmentPath': 'å‘å±•è·¯å¾„ï¼š' + getDevelopmentPath(pillars),
                'potentialChallenges': 'æ½œåœ¨æŒ‘æˆ˜ï¼š' + getChallengesAnalysis(pillars),
                'lifeAdvice': 'äººç”Ÿå»ºè®®ï¼š' + getLifeAdvice(pillars)
            };
            
            document.getElementById('personalityFoundation').textContent = integration.personalityFoundation;
            document.getElementById('fusionInlineBias').textContent = integration.personalityFoundation;
            document.getElementById('developmentPath').textContent = integration.developmentPath;
            document.getElementById('potentialChallenges').textContent = integration.potentialChallenges;
            document.getElementById('lifeAdvice').textContent = integration.lifeAdvice;
            
            // è¯¦ç»†è§£æ
            document.getElementById('fusionDetail').textContent = getFusionDetail(fusionType, pillars);
        }
        
        // ç”ŸæˆèåˆMBTIç±»å‹
        function generateFusionMBTI(pillars) {
            // åŸºäºå…«å­—ç‰¹å¾ç”ŸæˆMBTIç±»å‹
            const elements = pillars.split('ï½œ').join('').split('');
            let ei = 'I', sn = 'N', tf = 'F', jp = 'P';
            
            // ç®€å•çš„æ¨æ–­é€»è¾‘ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦ä¼˜åŒ–ï¼‰
            const dayStem = pillars.split('ï½œ')[2].charAt(0);
            const dayElement = STEM_TO_WUXING[dayStem];
            
            if (dayElement === 'ç«' || dayElement === 'æœ¨') {
                ei = 'E'; // ç«æœ¨ä¸»å¤–å‘
            }
            if (dayElement === 'é‡‘' || dayElement === 'æ°´') {
                sn = 'S'; // é‡‘æ°´ä¸»å…·ä½“
            }
            if (dayElement === 'åœŸ') {
                tf = 'T'; // åœŸä¸»ç†æ€§
            }
            
            return ei + sn + tf + jp;
        }
        
        // è·å–è°ƒå€™å»ºè®®
        function getRegulationAdvice(pillars) {
            const dayElement = STEM_TO_WUXING[pillars.split('ï½œ')[2].charAt(0)];
            const advice = {
                'æœ¨': 'å®œè¡¥ç«åœŸï¼Œå¿Œé‡‘æ°´',
                'ç«': 'å®œè¡¥åœŸé‡‘ï¼Œå¿Œæ°´æœ¨',
                'åœŸ': 'å®œè¡¥é‡‘æ°´ï¼Œå¿Œæœ¨ç«',
                'é‡‘': 'å®œè¡¥æ°´æœ¨ï¼Œå¿Œç«åœŸ',
                'æ°´': 'å®œè¡¥æœ¨ç«ï¼Œå¿ŒåœŸé‡‘'
            };
            return advice[dayElement] || 'éœ€è¦è¿›ä¸€æ­¥åˆ†æ';
        }
        
        // è·å–æ ¼å±€åˆ†æ
        function getPatternAnalysis(pillars) {
            const elements = pillars.split('ï½œ').join('').split('');
            const wuxingCount = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
            
            elements.forEach(char => {
                if (STEM_TO_WUXING[char]) wuxingCount[STEM_TO_WUXING[char]]++;
                if (BRANCH_TO_WUXING[char]) wuxingCount[BRANCH_TO_WUXING[char]]++;
            });
            
            const maxElement = Object.entries(wuxingCount).reduce((a, b) => wuxingCount[a[0]] > wuxingCount[b[0]] ? a : b)[0];
            return `${maxElement}æ—ºæ ¼ï¼Œä¸»${getElementTrait(maxElement)}`;
        }
        
        // è·å–äº”è¡Œç‰¹è´¨
        function getElementTrait(element) {
            const traits = {
                'æœ¨': 'ä»å¾·ã€è¿›å–ã€ç”Ÿæœº',
                'ç«': 'ç¤¼ä¹‰ã€çƒ­æƒ…ã€å…‰æ˜',
                'åœŸ': 'è¯šä¿¡ã€ç¨³é‡ã€åŒ…å®¹',
                'é‡‘': 'ä¹‰æ°”ã€æœæ–­ã€åšéŸ§',
                'æ°´': 'æ™ºæ…§ã€çµæ´»ã€é€‚åº”'
            };
            return traits[element] || 'æœªçŸ¥ç‰¹è´¨';
        }
        
        // è·å–æ ¹åŸºåˆ†æ
        function getFoundationAnalysis(pillars) {
            const dayElement = STEM_TO_WUXING[pillars.split('ï½œ')[2].charAt(0)];
            return `æ—¥ä¸»${dayElement}ï¼Œæ ¹åŸº${getElementTrait(dayElement)}ï¼Œæ€§æ ¼åŸºç¡€ç¨³å®š`;
        }
        
        // è·å–å‘å±•è·¯å¾„
        function getDevelopmentPath(pillars) {
            const dayElement = STEM_TO_WUXING[pillars.split('ï½œ')[2].charAt(0)];
            const path = {
                'æœ¨': 'é€‚åˆæ•™è‚²ã€æ–‡åŒ–ã€ç¯ä¿ç­‰é¢†åŸŸ',
                'ç«': 'é€‚åˆåª’ä½“ã€é”€å”®ã€æ¼”è‰ºç­‰é¢†åŸŸ',
                'åœŸ': 'é€‚åˆç®¡ç†ã€å»ºç­‘ã€å†œä¸šç­‰é¢†åŸŸ',
                'é‡‘': 'é€‚åˆé‡‘èã€æ³•å¾‹ã€æŠ€æœ¯ç­‰é¢†åŸŸ',
                'æ°´': 'é€‚åˆç§‘ç ”ã€å’¨è¯¢ã€è¿è¾“ç­‰é¢†åŸŸ'
            };
            return path[dayElement] || 'éœ€è¦ç»“åˆå…¶ä»–å› ç´ åˆ†æ';
        }
        
        // è·å–æŒ‘æˆ˜åˆ†æ
        function getChallengesAnalysis(pillars) {
            const dayElement = STEM_TO_WUXING[pillars.split('ï½œ')[2].charAt(0)];
            const challenges = {
                'æœ¨': 'éœ€æ³¨æ„æƒ…ç»ªç®¡ç†ï¼Œé¿å…è¿‡äºç†æƒ³åŒ–',
                'ç«': 'éœ€æ§åˆ¶å†²åŠ¨ï¼ŒåŸ¹å…»è€å¿ƒå’Œä¸“æ³¨åŠ›',
                'åœŸ': 'éœ€é¿å…è¿‡äºä¿å®ˆï¼ŒåŸ¹å…»åˆ›æ–°æ€ç»´',
                'é‡‘': 'éœ€æ³¨æ„äººé™…å…³ç³»ï¼Œé¿å…è¿‡äºåˆšç¡¬',
                'æ°´': 'éœ€é¿å…è¿‡äºçµæ´»ï¼ŒåŸ¹å…»åšæŒç²¾ç¥'
            };
            return challenges[dayElement] || 'éœ€è¦è¿›ä¸€æ­¥åˆ†æ';
        }
        
        // è·å–äººç”Ÿå»ºè®®
        function getLifeAdvice(pillars) {
            const dayElement = STEM_TO_WUXING[pillars.split('ï½œ')[2].charAt(0)];
            const advice = {
                'æœ¨': 'åŸ¹å…»é¢†å¯¼åŠ›ï¼Œå‘æŒ¥åˆ›é€ åŠ›ï¼Œæ³¨æ„å›¢é˜Ÿåˆä½œ',
                'ç«': 'ä¿æŒçƒ­æƒ…ï¼ŒåŸ¹å…»ä¸“æ³¨åŠ›ï¼Œæ³¨æ„æ—¶é—´ç®¡ç†',
                'åœŸ': 'å‘æŒ¥ç¨³å®šæ€§ï¼ŒåŸ¹å…»åŒ…å®¹å¿ƒï¼Œæ³¨æ„åˆ›æ–°æ€ç»´',
                'é‡‘': 'ä¿æŒåŸåˆ™æ€§ï¼ŒåŸ¹å…»çµæ´»æ€§ï¼Œæ³¨æ„äººé™…å…³ç³»',
                'æ°´': 'å‘æŒ¥æ™ºæ…§ï¼ŒåŸ¹å…»åšæŒåŠ›ï¼Œæ³¨æ„ç›®æ ‡æ˜ç¡®'
            };
            return advice[dayElement] || 'å»ºè®®ç»“åˆä¸ªäººå®é™…æƒ…å†µ';
        }
        
        // è·å–èåˆè¯¦æƒ…
        function getFusionDetail(fusionType, pillars) {
            return `åŸºäºæ‚¨çš„å…«å­—ç‰¹å¾ï¼Œæ¨æ–­å‡ºMBTIç±»å‹ä¸º${fusionType}ã€‚è¿™ä¸ªç±»å‹ç»“åˆäº†ä¼ ç»Ÿå‘½ç†å­¦çš„æ™ºæ…§ä¸ç°ä»£å¿ƒç†å­¦çš„æ´å¯Ÿï¼Œä¸ºæ‚¨æä¾›æ›´å…¨é¢çš„äººæ ¼åˆ†æã€‚å»ºè®®æ‚¨å°†æ­¤ç»“æœä½œä¸ºå‚è€ƒï¼Œç»“åˆå®é™…æƒ…å†µè¿›è¡Œè‡ªæˆ‘è®¤çŸ¥å’Œå‘å±•è§„åˆ’ã€‚`;
        }
        
        // æµ‹è¯•analyzePersonalityå‡½æ•°
        function testAnalyzePersonality() {
            console.log('ğŸ§ª æµ‹è¯•analyzePersonalityå‡½æ•°');
            
            // æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
            if (typeof analyzePersonality === 'function') {
                console.log('âœ… analyzePersonalityå‡½æ•°å­˜åœ¨');
            } else {
                console.error('âŒ analyzePersonalityå‡½æ•°ä¸å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥è¾“å…¥å…ƒç´ 
            const bDate = document.getElementById('bDate');
            const bTime = document.getElementById('bTime');
            
            if (bDate) {
                console.log('âœ… å‡ºç”Ÿæ—¥æœŸè¾“å…¥æ¡†å­˜åœ¨:', bDate.value);
            } else {
                console.error('âŒ å‡ºç”Ÿæ—¥æœŸè¾“å…¥æ¡†ä¸å­˜åœ¨');
            }
            
            if (bTime) {
                console.log('âœ… å‡ºç”Ÿæ—¶é—´è¾“å…¥æ¡†å­˜åœ¨:', bTime.value);
            } else {
                console.error('âŒ å‡ºç”Ÿæ—¶é—´è¾“å…¥æ¡†ä¸å­˜åœ¨');
            }
            
            // æ£€æŸ¥lunaråº“
            if (window.Solar || (window.Lunar && window.Lunar.Solar)) {
                console.log('âœ… lunaråº“å·²åŠ è½½');
            } else {
                console.log('âš ï¸ lunaråº“æœªåŠ è½½');
            }
            
            // æ£€æŸ¥å…¶ä»–ç›¸å…³å‡½æ•°
            const functions = ['safeGetPillars', 'analyzeWuxing', 'performMBTIAnalysis', 'performBaziAnalysis', 'performIntegrationAnalysis'];
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`âœ… ${funcName} å‡½æ•°å­˜åœ¨`);
                } else {
                    console.error(`âŒ ${funcName} å‡½æ•°ä¸å­˜åœ¨`);
                }
            });
            
            // æ£€æŸ¥ç»“æœå…ƒç´ 
            const resultElements = ['pillars', 'stemsBranches', 'wuxing', 'mbtiAnalysis', 'baziAnalysis', 'integrationAnalysis'];
            resultElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`âœ… ${elementId} å…ƒç´ å­˜åœ¨`);
                } else {
                    console.error(`âŒ ${elementId} å…ƒç´ ä¸å­˜åœ¨`);
                }
            });
        }
        
        // æµ‹è¯•æ•°å­—å‘½ç†å‡½æ•°
        function testNumerologyFunctions() {
            console.log('ğŸ§ª æµ‹è¯•æ•°å­—å‘½ç†å‡½æ•°');
            
            // æµ‹è¯•åŸºæœ¬å‡½æ•°æ˜¯å¦å­˜åœ¨
            const functions = [
                'analyzePersonality',
                'analyzeNumerology',
                'calculateLifeNumber', 
                'calculateDestinyNumber',
                'calculateSoulNumber',
                'analyzeNumberTraits'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`âœ… ${funcName} å‡½æ•°å­˜åœ¨`);
                } else {
                    console.error(`âŒ ${funcName} å‡½æ•°ä¸å­˜åœ¨`);
                }
            });
            
            // æµ‹è¯•æ•°æ®å¯¹è±¡
            if (typeof NUMBER_MEANINGS !== 'undefined') {
                console.log('âœ… NUMBER_MEANINGS å¯¹è±¡å­˜åœ¨ï¼ŒåŒ…å«', Object.keys(NUMBER_MEANINGS).length, 'ä¸ªæ•°å­—');
            } else {
                console.error('âŒ NUMBER_MEANINGS å¯¹è±¡ä¸å­˜åœ¨');
            }
            
            if (typeof CHINESE_NAME_NUMBERS !== 'undefined') {
                console.log('âœ… CHINESE_NAME_NUMBERS å¯¹è±¡å­˜åœ¨ï¼ŒåŒ…å«', Object.keys(CHINESE_NAME_NUMBERS).length, 'ä¸ªå­—ç¬¦');
            } else {
                console.error('âŒ CHINESE_NAME_NUMBERS å¯¹è±¡ä¸å­˜åœ¨');
            }
            
            // æµ‹è¯•è¾“å…¥å…ƒç´ 
            const nDate = document.getElementById('nDate');
            const nName = document.getElementById('nName');
            
            if (nDate) {
                console.log('âœ… å‡ºç”Ÿæ—¥æœŸè¾“å…¥æ¡†å­˜åœ¨');
            } else {
                console.error('âŒ å‡ºç”Ÿæ—¥æœŸè¾“å…¥æ¡†ä¸å­˜åœ¨');
            }
            
            if (nName) {
                console.log('âœ… å§“åè¾“å…¥æ¡†å­˜åœ¨');
            } else {
                console.error('âŒ å§“åè¾“å…¥æ¡†ä¸å­˜åœ¨');
            }
        }
    </script>
</body>
</html>
