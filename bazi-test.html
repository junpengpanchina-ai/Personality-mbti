<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—Ã—MBTI äººæ ¼æ·±åº¦è§£æ</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #111827;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
        .header { text-align: center; color: #fff; margin: 24px 0; }
        .header h1 { margin: 0 0 8px; font-size: 30px; }
        .card { background: rgba(255,255,255,0.98); border-radius: 16px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); margin-bottom: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 16px; }
        .btn { display:inline-block; background: linear-gradient(135deg, #0ea5e9, #6366f1); color:#fff; border:none; padding:10px 18px; border-radius:999px; cursor:pointer; font-weight:600; }
        .btn:hover { transform: translateY(-1px); }
        .muted { color:#6b7280; font-size:14px; }
        label { font-weight:600; display:block; margin:8px 0 6px; }
        input, select { width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
        .pill { display:inline-block; padding:6px 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px; }
        .kpi { font-size: 28px; font-weight:800; color:#4f46e5; }
        .q { border: 1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:12px; }
        .opt { margin:6px 0; }
        .opt input { width:auto; margin-right:6px; }
        .result { margin-top: 10px; padding: 12px 14px; border-left: 4px solid #10b981; background: #ecfdf5; color: #065f46; border-radius: 10px; }
        a.link { color: #4f46e5; text-decoration: none; font-weight: 600; }
        .section-title { margin: 0 0 10px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .mbti-dimension { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
        .bazi-insight { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #3b82f6; }
        .integration { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 4px solid #16a34a; }
        .hidden { display: none; }
    </style>
    
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ§  å…«å­—Ã—MBTI äººæ ¼æ·±åº¦è§£æ</h1>
            <p class="muted">ç»“åˆä¼ ç»Ÿå‘½ç†å­¦ä¸MBTIç†è®ºï¼Œæ¢ç´¢ä½ çš„æ€§æ ¼å¯†ç ä¸äººç”Ÿæ ¼å±€</p>
        </div>
    </div>

    <div class="container">
        <!-- åŸºç¡€ä¿¡æ¯è¾“å…¥ -->
        <div class="card">
            <div class="grid">
                <div>
                    <h3 class="section-title">åŸºç¡€ä¿¡æ¯</h3>
                    <label for="bDate">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="bDate" />
                    <label for="bTime">å‡ºç”Ÿæ—¶é—´ï¼ˆ24å°æ—¶åˆ¶ï¼‰</label>
                    <input type="time" id="bTime" value="12:00" />
                    <label for="tz">æ—¶åŒº</label>
                    <select id="tz">
                        <option value="8" selected>ä¸œå…«åŒºï¼ˆä¸­å›½å¤§é™†/æ¸¯æ¾³å°ï¼‰UTC+8</option>
                        <option value="7">UTC+7</option>
                        <option value="9">UTC+9</option>
                        <option value="0">UTCÂ±0</option>
                    </select>
                    <div style="margin-top:12px">
                        <button class="btn" type="button" onclick="analyzePersonality()">å¼€å§‹åˆ†æ</button>
                        <a class="link" href="index.html" style="margin-left:12px">è¿”å›é¦–é¡µ</a>
                    </div>
                    <p class="muted" style="margin-top:8px">åŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹ã€Šä¸‰å‘½é€šä¼šã€‹ç­‰ç»å…¸å‘½ç†è‘—ä½œï¼Œç»“åˆMBTIç†è®ºè¿›è¡Œäººæ ¼æ·±åº¦è§£æã€‚</p>
                </div>
                <div>
                    <h3 class="section-title">å…«å­—åŸºç¡€</h3>
                    <div class="pill">å››æŸ±</div>
                    <div class="kpi mono" id="pillars">â€” â€”ï½œâ€” â€”ï½œâ€” â€”ï½œâ€” â€”</div>
                    <div class="muted" id="stemsBranches"></div>
                    <div style="height:10px"></div>
                    <div class="pill">äº”è¡Œç»Ÿè®¡</div>
                    <div id="wuxing" class="grid" style="grid-template-columns: repeat(5,1fr); gap:8px; margin-top:8px"></div>
                    <div id="calcStatus" class="result hidden" style="margin-top:10px"></div>
                </div>
            </div>
        </div>

        <!-- MBTIç»´åº¦åˆ†æ -->
        <div class="card hidden" id="mbtiAnalysis">
            <h3 class="section-title">ğŸ§  MBTI å››ç»´åº¦åˆ†æ</h3>
            <div class="grid">
                <div class="card mbti-dimension">
                    <div class="pill">å¤–å‘ E / å†…å‘ I</div>
                    <div id="eiAnalysis" class="muted"></div>
                </div>
                <div class="card mbti-dimension">
                    <div class="pill">æ„Ÿè§‰ S / ç›´è§‰ N</div>
                    <div id="snAnalysis" class="muted"></div>
                </div>
                <div class="card mbti-dimension">
                    <div class="pill">æ€è€ƒ T / æƒ…æ„Ÿ F</div>
                    <div id="tfAnalysis" class="muted"></div>
                </div>
                <div class="card mbti-dimension">
                    <div class="pill">åˆ¤æ–­ J / æ„ŸçŸ¥ P</div>
                    <div id="jpAnalysis" class="muted"></div>
                </div>
            </div>
        </div>

        <!-- å…«å­—å‘½ç†è§£æ -->
        <div class="card hidden" id="baziAnalysis">
            <h3 class="section-title">ğŸ“… å…«å­—å‘½ç†è§£æ</h3>
            <div class="grid">
                <div class="card bazi-insight">
                    <div class="pill">æ—¥ä¸»å¼ºå¼±</div>
                    <div id="dayMasterStrength" class="muted"></div>
                </div>
                <div class="card bazi-insight">
                    <div class="pill">åç¥é…ç½®</div>
                    <div id="tenGods" class="muted"></div>
                </div>
                <div class="card bazi-insight">
                    <div class="pill">äº”è¡Œè°ƒå€™</div>
                    <div id="regulation" class="muted"></div>
                </div>
                <div class="card bazi-insight">
                    <div class="pill">æ ¼å±€ç‰¹å¾</div>
                    <div id="pattern" class="muted"></div>
                </div>
            </div>
        </div>

        <!-- å…«å­—Ã—MBTI èåˆè§£æ -->
        <div class="card hidden" id="integrationAnalysis">
            <h3 class="section-title">ğŸŒŸ å…«å­—Ã—MBTI èåˆè§£æ</h3>
            <div class="grid">
                <div class="card integration">
                    <div class="pill">æ€§æ ¼æ ¹åŸº</div>
                    <div id="personalityFoundation" class="muted"></div>
                </div>
                <div class="card integration">
                    <div class="pill">å‘å±•è·¯å¾„</div>
                    <div id="developmentPath" class="muted"></div>
                </div>
                <div class="card integration">
                    <div class="pill">æ½œåœ¨æŒ‘æˆ˜</div>
                    <div id="potentialChallenges" class="muted"></div>
                </div>
                <div class="card integration">
                    <div class="pill">äººç”Ÿå»ºè®®</div>
                    <div id="lifeAdvice" class="muted"></div>
                </div>
            </div>
        </div>

        <!-- å‘½ç†åŸºç¡€æµ‹è¯• -->
        <div class="card">
            <h3 class="section-title">ğŸ§ª å‘½ç†åŸºç¡€æµ‹è¯•ï¼ˆ10é¢˜ï¼‰</h3>
            <div id="quiz"></div>
            <div style="margin-top:10px">
                <button class="btn" type="button" onclick="gradeQuiz()">æäº¤ç­”æ¡ˆ</button>
                <span id="quizScore" class="pill" style="margin-left:10px"></span>
            </div>
        </div>
    </div>

    <script>
        // å¤©å¹²åœ°æ”¯äº”è¡Œæ˜ å°„
        const STEM_TO_WUXING = { 'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´' };
        const BRANCH_TO_WUXING = { 'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«','åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´' };
        const STEM_POLARITY = { 'ç”²':'é˜³','ä¹™':'é˜´','ä¸™':'é˜³','ä¸':'é˜´','æˆŠ':'é˜³','å·±':'é˜´','åºš':'é˜³','è¾›':'é˜´','å£¬':'é˜³','ç™¸':'é˜´' };
        const SHENG = { 'æœ¨':'ç«', 'ç«':'åœŸ', 'åœŸ':'é‡‘', 'é‡‘':'æ°´', 'æ°´':'æœ¨' }; // ç”Ÿ
        const KE   = { 'æœ¨':'åœŸ', 'åœŸ':'æ°´', 'æ°´':'ç«', 'ç«':'é‡‘', 'é‡‘':'æœ¨' }; // å…‹

        function safeGetPillars(year, month, day, hour, minute) {
            try {
                const Solar = window.Solar || (window.Lunar && window.Lunar.Solar);
                if (!Solar) throw new Error('æ¨¡å—æœªå°±ç»ª');
                
                const tz = parseInt(document.getElementById('tz').value || '8', 10);
                const jsDate = new Date(Date.UTC(year, month - 1, day, hour - tz, minute, 0));
                const y = jsDate.getUTCFullYear();
                const m = jsDate.getUTCMonth() + 1;
                const d = jsDate.getUTCDate();
                const h = jsDate.getUTCHours();
                const mi = jsDate.getUTCMinutes();

                let solar = null;
                if (typeof Solar.fromYmdHms === 'function') {
                    solar = Solar.fromYmdHms(y, m, d, h, mi, 0);
                } else if (typeof Solar.fromDate === 'function') {
                    solar = Solar.fromDate(new Date(Date.UTC(y, m - 1, d, h, mi, 0)));
                } else {
                    throw new Error('Solar æ„é€ ä¸å¯ç”¨');
                }
                const lunar = solar.getLunar();
                const ec = lunar.getEightChar();

                const yearP = (ec.getYear && ec.getYear()) || '';
                const monthP = (ec.getMonth && ec.getMonth()) || '';
                const dayP = (ec.getDay && ec.getDay()) || '';
                const timeP = (ec.getTime && ec.getTime()) || '';
                const pillarText = (yearP && monthP && dayP && timeP) ? `${yearP}ï½œ${monthP}ï½œ${dayP}ï½œ${timeP}` : (ec.toString ? ec.toString() : 'â€” â€”ï½œâ€” â€”ï½œâ€” â€”ï½œâ€” â€”');

                const parts = pillarText.replace(/[\s]/g,'').split('ï½œ');
                const parseGanZhi = (gz) => gz && gz.length >= 2 ? [gz[0], gz.slice(1)] : ['â€”','â€”'];
                const [yG, yZ] = parseGanZhi(parts[0] || '');
                const [mG, mZ] = parseGanZhi(parts[1] || '');
                const [dG, dZ] = parseGanZhi(parts[2] || '');
                const [tG, tZ] = parseGanZhi(parts[3] || '');

                return { pillarText, stems: [yG,mG,dG,tG], branches: [yZ,mZ,dZ,tZ] };
            } catch (e) {
                console.warn('è®¡ç®—å¤±è´¥ï¼Œå°†è¿”å›å ä½ï¼š', e);
                return { pillarText: 'â€” â€”ï½œâ€” â€”ï½œâ€” â€”ï½œâ€” â€”', stems: ['â€”','â€”','â€”','â€”'], branches: ['â€”','â€”','â€”','â€”'] };
            }
        }

        let isLoading = false;

        function showStatus(msg){
            const el = document.getElementById('calcStatus');
            if (!el) return;
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideStatus(){
            const el = document.getElementById('calcStatus');
            if (!el) return;
            el.classList.add('hidden');
            el.textContent = '';
        }
        async function waitForLunar(tries = 40, intervalMs = 150){
            for (let i=0;i<tries;i++){
                if ((window.Solar && (window.Solar.fromYmdHms || window.Solar.fromDate)) ||
                    (window.Lunar && window.Lunar.Solar && (window.Lunar.Solar.fromYmdHms || window.Lunar.Solar.fromDate))) {
                    return true;
                }
                await new Promise(r=>setTimeout(r, intervalMs));
            }
            return false;
        }

        const LUNAR_SOURCES = [
            // local first
            './libs/lunar.min.js',
            // jsDelivr common paths
            'https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript/dist/lunar.min.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript/umd/lunar.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript',
            // unpkg common paths
            'https://unpkg.com/lunar-javascript/lunar.min.js',
            'https://unpkg.com/lunar-javascript/dist/lunar.min.js',
            'https://unpkg.com/lunar-javascript/umd/lunar.js',
            'https://unpkg.com/lunar-javascript'
        ];

        function loadScriptOnce(src, timeoutMs = 6000){
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                const bust = (src.startsWith('./') || src.startsWith('/')) ? (`${src}?v=${Date.now()}`) : src;
                s.src = bust;
                s.async = true;
                s.crossOrigin = 'anonymous';
                let done = false;
                const timer = setTimeout(() => { if (!done){ done = true; s.remove(); reject(new Error('timeout')); } }, timeoutMs);
                s.onload = () => { if (!done){ done = true; clearTimeout(timer); resolve(true); } };
                s.onerror = () => { if (!done){ done = true; clearTimeout(timer); reject(new Error('load error')); } };
                document.head.appendChild(s);
            });
        }

        async function loadLunarFromFallbacks(){
            for (const url of LUNAR_SOURCES){
                try {
                    showStatus(`å°è¯•åŠ è½½å‘½ç†åº“ï¼š${url}`);
                    await loadScriptOnce(url);
                    const ok = await waitForLunar(20, 100);
                    if (ok) { hideStatus(); return true; }
                } catch (e) {
                    // try next
                }
            }
            return false;
        }

        async function analyzePersonality() {
            if (isLoading) return;
            isLoading = true;
            const btn = document.querySelector('button.btn');
            if (btn) { btn.disabled = true; btn.textContent = 'åˆ†æä¸­â€¦'; }
            hideStatus();
            const d = document.getElementById('bDate').value;
            const t = document.getElementById('bTime').value || '12:00';
            if (!d) { showStatus('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ'); if (btn){ btn.disabled=false; btn.textContent='å¼€å§‹åˆ†æ'; } isLoading=false; return; }

            let ready = await waitForLunar();
            if (!ready) {
                showStatus('ä¸»CDNåŠ è½½å¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨é•œåƒ...');
                ready = await loadLunarFromFallbacks();
            }
            if (!ready) { showStatus('é•œåƒåŠ è½½å¤±è´¥ã€‚å¦‚éœ€ç¦»çº¿ï¼Œè¯·å°† lunar-javascript çš„ UMD ç‰ˆæœ¬ç½®äº ./libs/lunar.min.js'); if (btn){ btn.disabled=false; btn.textContent='å¼€å§‹åˆ†æ'; } isLoading=false; return; }

            const [yy,mm,dd] = d.split('-').map(s=>parseInt(s,10));
            const [hh,mi] = t.split(':').map(s=>parseInt(s,10));

            const res = safeGetPillars(yy,mm,dd,hh,mi);
            if (!res || res.stems.every(s => s === 'â€”')) {
                showStatus('è§£æå¤±è´¥ï¼šè¾“å…¥æˆ–åº“å¼‚å¸¸ã€‚è¯·ç¡®è®¤æ—¥æœŸ/æ—¶é—´/æ—¶åŒºæ­£ç¡®ï¼Œæˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                if (btn){ btn.disabled=false; btn.textContent='å¼€å§‹åˆ†æ'; } isLoading=false; return;
            }
            document.getElementById('pillars').textContent = res.pillarText;
            document.getElementById('stemsBranches').textContent = `å¤©å¹²ï¼š${res.stems.join(' ')} ï½œ åœ°æ”¯ï¼š${res.branches.join(' ')}`;

            // äº”è¡Œç»Ÿè®¡
            const count = { 'é‡‘':0, 'æœ¨':0, 'æ°´':0, 'ç«':0, 'åœŸ':0 };
            res.stems.forEach(g => { const w = STEM_TO_WUXING[g]; if (w) count[w] += 1; });
            res.branches.forEach(z => { const w = BRANCH_TO_WUXING[z]; if (w) count[w] += 1; });
            
            const wx = document.getElementById('wuxing');
            wx.innerHTML = '';
            Object.entries(count).forEach(([k,v])=>{
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<div class="pill">${k}</div><div class="kpi">${v}</div>`;
                wx.appendChild(div);
            });

            // åˆ†æMBTIç»´åº¦
            analyzeMBTIDimensions(res, count);
            
            // åˆ†æå…«å­—å‘½ç†
            analyzeBaziPatterns(res, count);
            
            // èåˆè§£æ
            analyzeIntegration(res, count);

            // æ˜¾ç¤ºåˆ†æç»“æœ
            document.getElementById('mbtiAnalysis').classList.remove('hidden');
            document.getElementById('baziAnalysis').classList.remove('hidden');
            document.getElementById('integrationAnalysis').classList.remove('hidden');
            if (btn){ btn.disabled=false; btn.textContent='å¼€å§‹åˆ†æ'; }
            isLoading = false;
        }

        function analyzeMBTIDimensions(bazi, wuxing) {
            const dayStem = bazi.stems[2];
            const dayElement = STEM_TO_WUXING[dayStem];
            
            // åŸºäºæ—¥ä¸»äº”è¡Œå’Œæ•´ä½“äº”è¡Œåˆ†å¸ƒåˆ†æMBTIå€¾å‘
            const ei = analyzeEI(dayElement, wuxing);
            const sn = analyzeSN(dayElement, wuxing);
            const tf = analyzeTF(dayElement, wuxing);
            const jp = analyzeJP(dayElement, wuxing);

            document.getElementById('eiAnalysis').innerHTML = ei;
            document.getElementById('snAnalysis').innerHTML = sn;
            document.getElementById('tfAnalysis').innerHTML = tf;
            document.getElementById('jpAnalysis').innerHTML = jp;
        }

        function analyzeEI(dayElement, wuxing) {
            const fireCount = wuxing['ç«'] || 0;
            const waterCount = wuxing['æ°´'] || 0;
            const woodCount = wuxing['æœ¨'] || 0;
            const metalCount = wuxing['é‡‘'] || 0;

            if (fireCount > waterCount && woodCount > metalCount) {
                return 'åå¤–å‘(E)ï¼šç«æœ¨æ—ºç›¸ï¼Œä¸»åŠ¨è¡¨è¾¾ï¼Œå–„äºç¤¾äº¤äº’åŠ¨';
            } else if (waterCount > fireCount && metalCount > woodCount) {
                return 'åå†…å‘(I)ï¼šé‡‘æ°´æ—ºç›¸ï¼Œå†…æ•›æ€è€ƒï¼Œå–„äºæ²‰æ·€åæ€';
            } else {
                return 'å†…å¤–å¹³è¡¡ï¼šäº”è¡Œç›¸å¯¹å‡è¡¡ï¼Œå†…å¤–å‘ç‰¹å¾ä¸æ˜æ˜¾';
            }
        }

        function analyzeSN(dayElement, wuxing) {
            const earthCount = wuxing['åœŸ'] || 0;
            const woodCount = wuxing['æœ¨'] || 0;
            const fireCount = wuxing['ç«'] || 0;

            if (earthCount > 2) {
                return 'åæ„Ÿè§‰(S)ï¼šåœŸæ—ºä¸»å®ï¼Œé‡è§†ç»†èŠ‚ï¼Œå…³æ³¨ç°å®';
            } else if (woodCount + fireCount > 3) {
                return 'åç›´è§‰(N)ï¼šæœ¨ç«æ—ºç›¸ï¼Œå¯Œæœ‰æƒ³è±¡ï¼Œå–„äºè”æƒ³';
            } else {
                return 'æ„Ÿè§‰ç›´è§‰å¹³è¡¡ï¼šäº”è¡Œåˆ†å¸ƒç›¸å¯¹å‡è¡¡';
            }
        }

        function analyzeTF(dayElement, wuxing) {
            const metalCount = wuxing['é‡‘'] || 0;
            const fireCount = wuxing['ç«'] || 0;
            const waterCount = wuxing['æ°´'] || 0;

            if (metalCount > 2) {
                return 'åæ€è€ƒ(T)ï¼šé‡‘æ—ºä¸»ç†ï¼Œé€»è¾‘æ¸…æ™°ï¼Œé‡è§†åŸåˆ™';
            } else if (fireCount + waterCount > 3) {
                return 'åæƒ…æ„Ÿ(F)ï¼šç«æ°´æ—ºç›¸ï¼Œæ„Ÿæ€§ä¸°å¯Œï¼Œé‡è§†å…³ç³»';
            } else {
                return 'æ€è€ƒæƒ…æ„Ÿå¹³è¡¡ï¼šç†æ€§ä¸æ„Ÿæ€§ç›¸å¯¹å‡è¡¡';
            }
        }

        function analyzeJP(dayElement, wuxing) {
            const earthCount = wuxing['åœŸ'] || 0;
            const woodCount = wuxing['æœ¨'] || 0;
            const waterCount = wuxing['æ°´'] || 0;

            if (earthCount > 2) {
                return 'ååˆ¤æ–­(J)ï¼šåœŸæ—ºä¸»ç¨³ï¼Œè®¡åˆ’æ€§å¼ºï¼Œé‡è§†ç§©åº';
            } else if (woodCount + waterCount > 3) {
                return 'åæ„ŸçŸ¥(P)ï¼šæœ¨æ°´æ—ºç›¸ï¼Œçµæ´»é€‚åº”ï¼Œä¿æŒå¼€æ”¾';
            } else {
                return 'åˆ¤æ–­æ„ŸçŸ¥å¹³è¡¡ï¼šè®¡åˆ’æ€§ä¸çµæ´»æ€§ç›¸å¯¹å‡è¡¡';
            }
        }

        function analyzeBaziPatterns(bazi, wuxing) {
            const dayStem = bazi.stems[2];
            const dayElement = STEM_TO_WUXING[dayStem];
            
            // æ—¥ä¸»å¼ºå¼±åˆ†æ
            const strength = analyzeDayMasterStrength(dayStem, bazi.stems, bazi.branches[1]);
            document.getElementById('dayMasterStrength').innerHTML = `æ—¥ä¸»${dayStem}ï¼š${strength.verdict}ï¼ˆè¯„åˆ†${strength.score}ï¼‰`;

            // åç¥é…ç½®åˆ†æ
            const tenGods = analyzeTenGods(dayStem, bazi.stems);
            document.getElementById('tenGods').innerHTML = tenGods;

            // äº”è¡Œè°ƒå€™åˆ†æ
            const regulation = analyzeRegulation(dayElement, bazi.branches[1], wuxing);
            document.getElementById('regulation').innerHTML = regulation;

            // æ ¼å±€ç‰¹å¾åˆ†æ
            const pattern = analyzePattern(dayStem, bazi.stems, wuxing);
            document.getElementById('pattern').innerHTML = pattern;
        }

        function analyzeDayMasterStrength(dayStem, stems, monthBranch) {
            const dm = { element: STEM_TO_WUXING[dayStem], polarity: STEM_POLARITY[dayStem] };
            let score = 0;
            
            stems.forEach(s => {
                const si = { element: STEM_TO_WUXING[s], polarity: STEM_POLARITY[s] };
                if (!si.element) return;
                if (si.element === dm.element) score += 1;
                else if (SHENG[si.element] === dm.element) score += 0.6;
                else if (SHENG[dm.element] === si.element) score -= 0.4;
                else if (KE[dm.element] === si.element) score -= 0.5;
                else if (KE[si.element] === dm.element) score -= 0.7;
            });

            if (monthBranch) {
                const me = dm.element;
                const be = BRANCH_TO_WUXING[monthBranch];
                if (be) {
                    if (be === me) score += 1.0;
                    else if (SHENG[be] === me) score += 0.5;
                    else if (KE[be] === me) score -= 0.6;
                    else if (SHENG[me] === be) score -= 0.2;
                }
            }

            let verdict = 'å¹³';
            if (score >= 2) verdict = 'åæ—º';
            else if (score <= 0.5) verdict = 'åå¼±';
            
            return { score: Number(score.toFixed(2)), verdict };
        }

        function analyzeTenGods(dayStem, stems) {
            const labels = ['å¹´å¹²', 'æœˆå¹²', 'æ—¥å¹²', 'æ—¶å¹²'];
            let result = '';
            
            stems.forEach((s, idx) => {
                if (idx === 2) {
                    result += `${labels[idx]}ï¼š${s}ï¼ˆæ—¥ä¸»ï¼‰<br>`;
                } else {
                    const god = getTenGod(dayStem, s);
                    result += `${labels[idx]}ï¼š${s} â†’ ${god}<br>`;
                }
            });
            
            return result;
        }

        function getTenGod(dayStem, otherStem) {
            const d = { element: STEM_TO_WUXING[dayStem], polarity: STEM_POLARITY[dayStem] };
            const o = { element: STEM_TO_WUXING[otherStem], polarity: STEM_POLARITY[otherStem] };
            
            if (!d.element || !o.element) return 'â€”';
            if (d.element === o.element) return (d.polarity === o.polarity) ? 'æ¯”è‚©' : 'åŠ«è´¢';
            if (SHENG[o.element] === d.element) return (d.polarity !== o.polarity) ? 'æ­£å°' : 'åå°';
            if (SHENG[d.element] === o.element) return (d.polarity !== o.polarity) ? 'é£Ÿç¥' : 'ä¼¤å®˜';
            if (KE[d.element] === o.element) return (d.polarity !== o.polarity) ? 'æ­£è´¢' : 'åè´¢';
            if (KE[o.element] === d.element) return (d.polarity !== o.polarity) ? 'æ­£å®˜' : 'ä¸ƒæ€';
            return 'â€”';
        }

        function analyzeRegulation(dayElement, monthBranch, wuxing) {
            const monthElement = BRANCH_TO_WUXING[monthBranch];
            if (!monthElement || !dayElement) return 'æ— æ³•åˆ†æ';
            
            if (monthElement === dayElement) {
                return 'æœˆä»¤å½“ä»¤ï¼Œæ—¥ä¸»å¾—ä»¤ï¼Œæ°”åŠ¿è¾ƒå¼º';
            } else if (SHENG[monthElement] === dayElement) {
                return 'æœˆä»¤ç”Ÿèº«ï¼Œæ—¥ä¸»å¾—ç”Ÿï¼Œæ ¹åŸºç¨³å›º';
            } else if (KE[monthElement] === dayElement) {
                return 'æœˆä»¤å…‹èº«ï¼Œæ—¥ä¸»å—å…‹ï¼Œéœ€è¦è°ƒå€™';
            } else if (SHENG[dayElement] === monthElement) {
                return 'æ—¥ä¸»ç”Ÿæœˆä»¤ï¼Œæ³„æ°”è¾ƒå¤šï¼Œéœ€è¦è¡¥ç›Š';
            } else {
                return 'æœˆä»¤ä¸æ—¥ä¸»å…³ç³»ä¸­æ€§ï¼Œæ•´ä½“å¹³è¡¡';
            }
        }

        function analyzePattern(dayStem, stems, wuxing) {
            const dayElement = STEM_TO_WUXING[dayStem];
            const fireCount = wuxing['ç«'] || 0;
            const waterCount = wuxing['æ°´'] || 0;
            const earthCount = wuxing['åœŸ'] || 0;
            const woodCount = wuxing['æœ¨'] || 0;
            const metalCount = wuxing['é‡‘'] || 0;

            if (fireCount > 3) return 'ç«æ—ºæ ¼ï¼šçƒ­æƒ…ä¸»åŠ¨ï¼Œå¯Œæœ‰åˆ›é€ åŠ›ï¼Œä½†éœ€æ³¨æ„æƒ…ç»ªæ§åˆ¶';
            if (waterCount > 3) return 'æ°´æ—ºæ ¼ï¼šæ™ºæ…§æ·±æ²‰ï¼Œå–„äºæ€è€ƒï¼Œä½†éœ€æ³¨æ„è¡ŒåŠ¨åŠ›';
            if (earthCount > 3) return 'åœŸæ—ºæ ¼ï¼šç¨³é‡åŠ¡å®ï¼Œé‡è§†ç§©åºï¼Œä½†éœ€æ³¨æ„çµæ´»æ€§';
            if (woodCount > 3) return 'æœ¨æ—ºæ ¼ï¼šç”Ÿæœºå‹ƒå‹ƒï¼Œå¯Œæœ‰ç†æƒ³ï¼Œä½†éœ€æ³¨æ„ç¨³å®šæ€§';
            if (metalCount > 3) return 'é‡‘æ—ºæ ¼ï¼šåˆšæ¯…æœæ–­ï¼Œé‡è§†åŸåˆ™ï¼Œä½†éœ€æ³¨æ„åŒ…å®¹æ€§';
            
            return 'ä¸­å’Œæ ¼ï¼šäº”è¡Œç›¸å¯¹å‡è¡¡ï¼Œæ€§æ ¼ç‰¹å¾ä¸æ˜æ˜¾ï¼Œé€‚åº”æ€§è¾ƒå¼º';
        }

        function analyzeIntegration(bazi, wuxing) {
            const dayStem = bazi.stems[2];
            const dayElement = STEM_TO_WUXING[dayStem];
            const strength = analyzeDayMasterStrength(dayStem, bazi.stems, bazi.branches[1]);

            // æ€§æ ¼æ ¹åŸº
            const foundation = getPersonalityFoundation(dayElement, strength.verdict);
            document.getElementById('personalityFoundation').innerHTML = foundation;

            // å‘å±•è·¯å¾„
            const path = getDevelopmentPath(dayElement, strength.verdict, wuxing);
            document.getElementById('developmentPath').innerHTML = path;

            // æ½œåœ¨æŒ‘æˆ˜
            const challenges = getPotentialChallenges(dayElement, strength.verdict, wuxing);
            document.getElementById('potentialChallenges').innerHTML = challenges;

            // äººç”Ÿå»ºè®®
            const advice = getLifeAdvice(dayElement, strength.verdict, wuxing);
            document.getElementById('lifeAdvice').innerHTML = advice;
        }

        function getPersonalityFoundation(dayElement, strength) {
            const foundations = {
                'æœ¨': 'æœ¨æ€§ä¸»ä»ï¼Œå…·æœ‰ç”Ÿé•¿ã€å‘ä¸Šã€è¿›å–çš„ç‰¹è´¨',
                'ç«': 'ç«æ€§ä¸»ç¤¼ï¼Œå…·æœ‰å…‰æ˜ã€æ¸©æš–ã€çƒ­æƒ…çš„ç‰¹è´¨',
                'åœŸ': 'åœŸæ€§ä¸»ä¿¡ï¼Œå…·æœ‰åŒ…å®¹ã€ç¨³å®šã€åŠ¡å®çš„ç‰¹è´¨',
                'é‡‘': 'é‡‘æ€§ä¸»ä¹‰ï¼Œå…·æœ‰åˆšæ¯…ã€æœæ–­ã€åŸåˆ™çš„ç‰¹è´¨',
                'æ°´': 'æ°´æ€§ä¸»æ™ºï¼Œå…·æœ‰æ™ºæ…§ã€çµæ´»ã€åŒ…å®¹çš„ç‰¹è´¨'
            };
            
            const base = foundations[dayElement] || 'äº”è¡Œç‰¹å¾ä¸æ˜æ˜¾';
            return `${base}ã€‚æ—¥ä¸»${strength}ï¼Œ${strength === 'åæ—º' ? 'æ€§æ ¼ç‰¹å¾çªå‡ºï¼Œä¼˜åŠ¿æ˜æ˜¾' : strength === 'åå¼±' ? 'æ€§æ ¼æ¸©å’Œï¼Œéœ€è¦åŸ¹å…»' : 'æ€§æ ¼å¹³è¡¡ï¼Œé€‚åº”æ€§è¾ƒå¼º'}ã€‚`;
        }

        function getDevelopmentPath(dayElement, strength, wuxing) {
            if (strength === 'åæ—º') {
                return 'å‘æŒ¥ä¼˜åŠ¿ï¼šåˆ©ç”¨æ—¥ä¸»æ—ºç›¸çš„ä¼˜åŠ¿ï¼Œåœ¨æ“…é•¿çš„é¢†åŸŸæ·±è€•å‘å±•ã€‚æ³¨æ„é€‚åº¦æ”¶æ•›ï¼Œé¿å…è¿‡äºå¼ºåŠ¿ã€‚';
            } else if (strength === 'åå¼±') {
                return 'è¡¥ç›Šå‘å±•ï¼šé€šè¿‡å­¦ä¹ å’Œå®è·µå¢å¼ºæ—¥ä¸»åŠ›é‡ï¼ŒåŸ¹å…»æ ¸å¿ƒèƒ½åŠ›ã€‚å¯»æ‰¾è´µäººç›¸åŠ©ï¼Œå»ºç«‹æ”¯æŒç³»ç»Ÿã€‚';
            } else {
                return 'å¹³è¡¡å‘å±•ï¼šä¿æŒäº”è¡Œå¹³è¡¡ï¼Œå…¨é¢å‘å±•å„é¡¹èƒ½åŠ›ã€‚æ ¹æ®å¤§è¿æµå¹´è°ƒæ•´å‘å±•é‡ç‚¹ã€‚';
            }
        }

        function getPotentialChallenges(dayElement, strength, wuxing) {
            const challenges = {
                'æœ¨': 'æœ¨æ—ºæ˜“æŠ˜ï¼Œéœ€æ³¨æ„æƒ…ç»ªæ§åˆ¶å’Œäººé™…å…³ç³»å¤„ç†',
                'ç«': 'ç«æ—ºæ˜“ç‡¥ï¼Œéœ€æ³¨æ„è€å¿ƒå’Œç»†èŠ‚ç®¡ç†',
                'åœŸ': 'åœŸæ—ºæ˜“æ»ï¼Œéœ€æ³¨æ„åˆ›æ–°æ€ç»´å’Œçµæ´»æ€§',
                'é‡‘': 'é‡‘æ—ºæ˜“åˆšï¼Œéœ€æ³¨æ„åŒ…å®¹æ€§å’Œäººé™…å…³ç³»',
                'æ°´': 'æ°´æ—ºæ˜“æµï¼Œéœ€æ³¨æ„ç¨³å®šæ€§å’Œæ‰§è¡ŒåŠ›'
            };
            
            const base = challenges[dayElement] || 'æ— æ˜æ˜¾æŒ‘æˆ˜';
            return `${base}ã€‚${strength === 'åæ—º' ? 'æ—¥ä¸»è¿‡æ—ºæ—¶ï¼Œè¿™äº›æŒ‘æˆ˜ä¼šæ›´åŠ æ˜æ˜¾' : strength === 'åå¼±' ? 'æ—¥ä¸»åå¼±æ—¶ï¼Œéœ€è¦å…‹æœè¿™äº›æŒ‘æˆ˜æ¥å¢å¼ºè‡ªèº«' : 'æ—¥ä¸»å¹³è¡¡æ—¶ï¼Œè¿™äº›æŒ‘æˆ˜ç›¸å¯¹æ¸©å’Œ'}ã€‚`;
        }

        function getLifeAdvice(dayElement, strength, wuxing) {
            const advice = {
                'æœ¨': 'åŸ¹å…»è€å¿ƒï¼Œå­¦ä¼šå€¾å¬ï¼Œåœ¨å›¢é˜Ÿä¸­å‘æŒ¥é¢†å¯¼ä½œç”¨',
                'ç«': 'ä¿æŒçƒ­æƒ…ï¼Œæ³¨æ„ç»†èŠ‚ï¼Œåœ¨åˆ›æ–°ä¸­å±•ç°æ‰å',
                'åœŸ': 'ä¿æŒç¨³å®šï¼ŒåŸ¹å…»åˆ›æ–°ï¼Œåœ¨åŠ¡å®ä¸­è¿½æ±‚å“è¶Š',
                'é‡‘': 'åšæŒåŸåˆ™ï¼Œå­¦ä¼šåŒ…å®¹ï¼Œåœ¨åˆšæ¯…ä¸­å±•ç°æ™ºæ…§',
                'æ°´': 'ä¿æŒæ™ºæ…§ï¼Œå¢å¼ºè¡ŒåŠ¨ï¼Œåœ¨çµæ´»ä¸­è¿½æ±‚ç¨³å®š'
            };
            
            const base = advice[dayElement] || 'ä¿æŒå¹³è¡¡å‘å±•';
            return `${base}ã€‚${strength === 'åæ—º' ? 'å‘æŒ¥ä¼˜åŠ¿çš„åŒæ—¶ï¼Œæ³¨æ„è‡ªæˆ‘è°ƒèŠ‚å’Œä»–äººæ„Ÿå—' : strength === 'åå¼±' ? 'åœ¨è¡¥ç›Šè‡ªèº«çš„åŒæ—¶ï¼Œå¯»æ‰¾é€‚åˆè‡ªå·±çš„å‘å±•é“è·¯' : 'åœ¨å¹³è¡¡å‘å±•ä¸­ï¼Œå¯»æ‰¾çªç ´å’Œåˆ›æ–°çš„æœºä¼š'}ã€‚`;
        }

        // å‘½ç†åŸºç¡€æµ‹è¯•ï¼ˆ10é¢˜ï¼‰
        const QUIZ = [
            { t:'æ—¥ä¸»ä¸ºç”²æœ¨ï¼Œå¹´å¹²ä¸ºåºšé‡‘ï¼Œåˆ™å¹´å¹²å¯¹æ—¥ä¸»çš„åç¥æ˜¯ï¼Ÿ', opts:['æ­£å®˜','ä¸ƒæ€','æ­£å°','åå°'], a:1, explanation:'ç”²æœ¨æ—¥ä¸»ï¼Œåºšé‡‘å…‹ç”²æœ¨ï¼Œé˜´é˜³ä¸åŒä¸ºä¸ƒæ€ã€‚' },
            { t:'æ—¥ä¸»ä¸ºä¸™ç«ï¼Œæœˆå¹²ä¸ºæˆŠåœŸï¼Œåˆ™æœˆå¹²å¯¹æ—¥ä¸»çš„åç¥æ˜¯ï¼Ÿ', opts:['é£Ÿç¥','ä¼¤å®˜','æ­£å°','åå°'], a:0, explanation:'ä¸™ç«ç”ŸæˆŠåœŸï¼Œé˜´é˜³ä¸åŒä¸ºé£Ÿç¥ã€‚' },
            { t:'æ—¥ä¸»ä¸ºå£¬æ°´ï¼Œæ—¶å¹²ä¸ºç”²æœ¨ï¼Œåˆ™æ—¶å¹²å¯¹æ—¥ä¸»çš„åç¥æ˜¯ï¼Ÿ', opts:['æ­£è´¢','åè´¢','é£Ÿç¥','ä¼¤å®˜'], a:2, explanation:'å£¬æ°´ç”Ÿç”²æœ¨ï¼Œé˜´é˜³ä¸åŒä¸ºé£Ÿç¥ã€‚' },
            { t:'æ—¥ä¸»ç”²æœ¨ç”Ÿäºå¯…æœˆï¼Œå¯…ä¸­è—å¹²ä¸ºï¼Ÿ', opts:['ç”²æœ¨','ä¸™ç«','æˆŠåœŸ','ç”²ä¸™æˆŠ'], a:3, explanation:'å¯…ä¸ºæœ¨ä¹‹é•¿ç”Ÿï¼Œè—ç”²æœ¨æœ¬æ°”ã€ä¸™ç«ä¸­æ°”ã€æˆŠåœŸä½™æ°”ã€‚' },
            { t:'æ—¥ä¸»ä¸™ç«ç”Ÿäºäº¥æœˆï¼Œäº¥ä¸ºæ°´æ—ºä¹‹æœˆï¼Œæ­¤å‘½å±€è°ƒå€™å®œï¼Ÿ', opts:['å–ç«è°ƒå€™','å–åœŸåˆ¶æ°´','å–æœ¨ç”Ÿç«','å–é‡‘ç”Ÿæ°´'], a:0, explanation:'äº¥æœˆæ°´æ—ºç«å¼±ï¼Œéœ€ç«è°ƒå€™æš–å±€ã€‚' },
            { t:'æ—¥ä¸»åå¼±ï¼Œå±€ä¸­å°æ˜Ÿè¾ƒå¤šï¼Œæ­¤æ ¼å±€å®œï¼Ÿ', opts:['å–å°ç”Ÿèº«','å–æ¯”åŠ«æ‰¶èº«','å–é£Ÿä¼¤æ³„ç§€','å–è´¢æ˜Ÿè€—èº«'], a:1, explanation:'å°å¤šèº«å¼±ï¼Œå°é‡ä¸ºå¿Œï¼Œå®œå–æ¯”åŠ«æ‰¶èº«åˆ¶å°ã€‚' },
            { t:'æ—¥ä¸»åæ—ºï¼Œå±€ä¸­é£Ÿä¼¤è¾ƒå¤šï¼Œæ­¤æ ¼å±€å®œï¼Ÿ', opts:['å–å°ç”Ÿèº«','å–æ¯”åŠ«æ‰¶èº«','å–é£Ÿä¼¤æ³„ç§€','å–å®˜æ€åˆ¶èº«'], a:2, explanation:'èº«æ—ºé£Ÿä¼¤å¤šï¼Œå®œé¡ºå…¶åŠ¿å–é£Ÿä¼¤æ³„ç§€ã€‚' },
            { t:'å¤§è¿ä¸æµå¹´å¤©å¹²ç›¸åŒï¼Œåœ°æ”¯ç›¸å†²ï¼Œæ­¤å¹´è¿åŠ¿ï¼Ÿ', opts:['å¹³ç¨³å‘å±•','å˜åŠ¨è¾ƒå¤§','è´µäººç›¸åŠ©','å£èˆŒæ˜¯é'], a:1, explanation:'å¤©å¹²ç›¸åŒåœ°æ”¯ç›¸å†²ï¼Œä¸»å˜åŠ¨è¾ƒå¤§ï¼Œéœ€è°¨æ…ã€‚' },
            { t:'æ—¥ä¸»ä¸ºé‡‘ï¼Œå¤§è¿ä¸ºç«ï¼Œæµå¹´ä¸ºæœ¨ï¼Œæ­¤å¹´äº”è¡Œå…³ç³»ï¼Ÿ', opts:['ç«å…‹é‡‘ï¼Œæœ¨ç”Ÿç«','æœ¨å…‹åœŸï¼Œç«ç”ŸåœŸ','é‡‘å…‹æœ¨ï¼Œç«å…‹é‡‘','æœ¨ç”Ÿç«ï¼Œç«å…‹é‡‘'], a:3, explanation:'æœ¨ç”Ÿç«ï¼Œç«å…‹é‡‘ï¼Œå½¢æˆæœ¨â†’ç«â†’é‡‘çš„ç”Ÿå…‹é“¾ã€‚' },
            { t:'æ—¥ä¸»ä¸ºæ°´ï¼Œç”Ÿäºåˆæœˆï¼Œåˆä¸ºç«æ—ºä¹‹æœˆï¼Œæ­¤å‘½å±€è°ƒå€™å®œï¼Ÿ', opts:['å–æ°´è°ƒå€™','å–é‡‘ç”Ÿæ°´','å–åœŸåˆ¶ç«','å–æœ¨ç”Ÿç«'], a:0, explanation:'åˆæœˆç«æ—ºæ°´å¼±ï¼Œéœ€æ°´è°ƒå€™æ¶¦å±€ã€‚' }
        ];

        function renderQuiz(){
            const root = document.getElementById('quiz');
            root.innerHTML = '';
            QUIZ.forEach((q, i)=>{
                const div = document.createElement('div');
                div.className = 'q';
                div.innerHTML = `<div style="font-weight:700">${i+1}. ${q.t}</div>`;
                q.opts.forEach((o, j)=>{
                    const opt = document.createElement('div');
                    opt.className = 'opt';
                    opt.innerHTML = `<label><input type="radio" name="q${i}" value="${j}"> ${o}</label>`;
                    div.appendChild(opt);
                });
                root.appendChild(div);
            });
        }

        function gradeQuiz(){
            let score = 0;
            let explanations = [];
            QUIZ.forEach((q, i)=>{
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                if (sel && parseInt(sel.value,10) === q.a) {
                    score += 1;
                } else if (sel) {
                    explanations.push(`ç¬¬${i+1}é¢˜ï¼š${q.explanation || 'æ— è§£é‡Š'}`);
                }
            });
            const pill = document.getElementById('quizScore');
            pill.textContent = `å¾—åˆ†ï¼š${score}/${QUIZ.length}`;
            
            if (explanations.length > 0) {
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'result';
                explanationDiv.style.marginTop = '10px';
                explanationDiv.innerHTML = `<strong>é”™é¢˜è§£æï¼š</strong><br>${explanations.join('<br>')}`;
                document.getElementById('quiz').appendChild(explanationDiv);
            }
        }

        // åˆå§‹åŒ–
        renderQuiz();
    </script>
</body>
</html>
