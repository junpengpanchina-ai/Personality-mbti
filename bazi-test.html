<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bazi × MBTI × Numerology - Deep Personality Analysis</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #111827;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 24px; }
        .header { text-align: center; color: #fff; margin: 24px 0; }
        .header h1 { margin: 0 0 8px; font-size: 30px; }
        .card { background: rgba(255,255,255,0.98); border-radius: 16px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); margin-bottom: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 16px; }
        .btn { display:inline-block; background: linear-gradient(135deg, #0ea5e9, #6366f1); color:#fff; border:none; padding:10px 18px; border-radius:999px; cursor:pointer; font-weight:600; }
        .btn:hover { transform: translateY(-1px); }
        .btn-secondary { background: linear-gradient(135deg, #94a3b8, #64748b); color:#fff; }
        .muted { color:#6b7280; font-size:14px; }
        label { font-weight:600; display:block; margin:8px 0 6px; }
        input, select { width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb; }
        .pill { display:inline-block; padding:6px 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px; }
        .kpi { font-size: 28px; font-weight:800; color:#4f46e5; }
        .q { border: 1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:12px; }
        .opt { margin:6px 0; }
        .opt input { width:auto; margin-right:6px; }
        .result { margin-top: 10px; padding: 12px 14px; border-left: 4px solid #10b981; background: #ecfdf5; color: #065f46; border-radius: 10px; }
        a.link { color: #4f46e5; text-decoration: none; font-weight: 600; }
        .section-title { margin: 0 0 10px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .mbti-dimension { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; }
        .bazi-insight { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #3b82f6; }
        .integration { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 4px solid #16a34a; }
        .numerology { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border-left: 4px solid #9333ea; }
        .hidden { display: none; }
        
        .feature-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }
        
        .feature-status.coming-soon {
            background: #fef3c7;
            color: #92400e;
        }
        
        .feature-status.ready {
            background: #d1fae5;
            color: #065f46;
        }
        .tab-container { display: flex; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.1); }
        .tab { flex: 1; padding: 12px; text-align: center; background: rgba(255,255,255,0.2); color: #fff; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: rgba(255,255,255,0.9); color: #111827; }
        .tab:hover { background: rgba(255,255,255,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Utility bar */
        /* utility/share removed by request */
        
        /* Language switcher styles removed */
    </style>
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.ico">
    
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🧠 Bazi × MBTI × Numerology - Deep Personality Analysis</h1>
            <p class="muted">Combining traditional metaphysics, MBTI theory, and modern numerology to explore your personality code and life pattern</p>
            
            <!-- Language switcher -->
            <div class="language-switcher">
                <!-- Language switching labels removed -->
            </div>
            
            <!-- Test buttons -->
            <div style="margin-top: 20px;">
                <!-- Internationalized test buttons removed -->
                <button class="btn" onclick="location.href='index.html'" style="background: #6b7280; margin-left: 10px;">🏠 Back to Home</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Test type selection -->


        <!-- Bazi × MBTI Test Content -->
        <div id="bazi-content" class="tab-content active">
            <!-- Basic Information Input -->
            <div class="card">
                <div class="grid">
                    <div>
                        <h3 class="section-title">Basic Information</h3>
                        <label for="bDate">Date of Birth (MM/DD/YYYY)</label>
                        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px">
                            <select id="bYear"></select>
                            <select id="bMonth"></select>
                            <select id="bDay"></select>
                        </div>
                        <input type="text" id="bDate" placeholder="MM/DD/YYYY 或 2020-01-01 或 农历2020年十月初三" />
                        <div class="muted" style="margin-top:6px">支持：YYYY-MM-DD / YYYY/MM/DD / MM/DD/YYYY / YYYYMMDD / YYYY.M.D / YYYY年M月D日 / 农历/阴历（含闰月），示例：农历2020年闰四月初一</div>
                        <label for="bTime">Birth Time (24-hour format)</label>
                        <input type="time" id="bTime" value="12:00" />
                        <label for="tz">Time Zone</label>
                        <select id="tz">
                            <option value="8" selected>East Eight Zone (Mainland China/Hong Kong/Macau/Taiwan) UTC+8</option>
                            <option value="7">UTC+7</option>
                            <option value="9">UTC+9</option>
                            <option value="0">UTC±0</option>
                        </select>
                        <div style="margin-top:12px">
                            <button class="btn" type="button" onclick="analyzePersonality()">Start Analysis</button>
                            <button class="btn btn-secondary" type="button" onclick="testAnalyzePersonality()" style="margin-left:8px">🧪 Test Function</button>
                            <button class="btn btn-secondary" type="button" onclick="location.href='index.html'" style="margin-left:8px">Back to Home</button>
                            <div style="margin-top:10px; display:none">
                                <button class="btn" type="button" onclick="setSampleDate('gregorian')" style="background:#10b981">示例(公历)</button>
                                <button class="btn" type="button" onclick="setSampleDate('lunar')" style="background:#8b5cf6; margin-left:8px">示例(农历)</button>
                                <button class="btn" type="button" onclick="setSampleDate('leap')" style="background:#ef4444; margin-left:8px">示例(闰月)</button>
                            </div>
                        </div>
                        <p class="muted" style="margin-top:8px">Based on classic metaphysics works such as "Yuanhai Ziping" and "Three Lives Tonghui", combined with MBTI theory for deep personality analysis.</p>
                    </div>
                    <div>
                        <h3 class="section-title">Bazi Basics</h3>
                        <div class="pill">Four Pillars</div>
                        <div class="kpi mono" id="pillars">— —｜— —｜— —｜— —</div>
                        <div class="muted" id="stemsBranches"></div>
                        <div style="height:10px"></div>
                        <div class="pill">Five Elements Statistics</div>
                        <div id="wuxing" class="grid" style="grid-template-columns: repeat(5,1fr); gap:8px; margin-top:8px"></div>
                        <div id="calcStatus" class="result hidden" style="margin-top:10px"></div>
                    </div>
                </div>
            </div>

            <!-- MBTI Dimension Analysis -->
            <div class="card hidden" id="mbtiAnalysis">
                <h3 class="section-title">🧠 MBTI Four Dimensions Analysis</h3>
                <div class="grid">
                    <div class="card mbti-dimension">
                        <div class="pill">Extroverted E / Introverted I</div>
                        <div id="eiAnalysis" class="muted"></div>
                    </div>
                    <div class="card mbti-dimension">
                        <div class="pill">Sensing S / Intuition N</div>
                        <div id="snAnalysis" class="muted"></div>
                    </div>
                    <div class="card mbti-dimension">
                        <div class="pill">Thinking T / Feeling F</div>
                        <div id="tfAnalysis" class="muted"></div>
                    </div>
                    <div class="card mbti-dimension">
                        <div class="pill">Judging J / Perceiving P</div>
                        <div id="jpAnalysis" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- Bazi Interpretation -->
            <div class="card hidden" id="baziAnalysis">
                <h3 class="section-title">📅 Bazi Interpretation</h3>
                <div class="grid">
                    <div class="card bazi-insight">
                        <div class="pill">Day Master Strength</div>
                        <div id="dayMasterStrength" class="muted"></div>
                    </div>
                    <div class="card bazi-insight">
                        <div class="pill">Ten Gods Configuration</div>
                        <div id="tenGods" class="muted"></div>
                    </div>
                    <div class="card bazi-insight">
                        <div class="pill">Regulation of Five Elements</div>
                        <div id="regulation" class="muted"></div>
                    </div>
                    <div class="card bazi-insight">
                        <div class="pill">Pattern Characteristics</div>
                        <div id="pattern" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- Bazi × MBTI Integration Analysis -->
            <div class="card hidden" id="integrationAnalysis">
                <h3 class="section-title">🌟 Bazi × MBTI Integration Analysis</h3>
                <div class="card integration" style="margin-bottom:12px">
                    <div class="pill">Fusion MBTI Type</div>
                    <div id="fusionInlineType" class="kpi" style="font-size:22px; margin-top:6px"></div>
                    <div id="fusionInlineBias" class="muted" style="margin-top:4px"></div>
                </div>
                <div class="grid">
                    <div class="card integration">
                        <div class="pill">Personality Foundation</div>
                        <div id="personalityFoundation" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Development Path</div>
                        <div id="developmentPath" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Potential Challenges</div>
                        <div id="potentialChallenges" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Life Advice</div>
                        <div id="lifeAdvice" class="muted"></div>
                    </div>
                </div>
                <div class="card integration" style="margin-top:12px">
                    <div class="pill">Detailed Explanation of Fusion Type</div>
                    <div id="fusionDetail" class="muted" style="margin-top:6px"></div>
                </div>
            </div>

            <!-- Fusion Test (Adaptive Questioning) -->
            <div class="card hidden" id="fusionTest">
                <h3 class="section-title">🧩 融合测评</h3>
                <div id="fusionQuiz"></div>
                <div style="margin-top:10px">
                    <button class="btn" type="button" onclick="submitFusion()">Submit Fusion Test</button>
                    <span id="fusionResult" class="pill" style="margin-left:10px"></span>
                </div>
            </div>
        </div>

        <!-- Numerology × MBTI Test Content -->
        <div id="numerology-content" class="tab-content">
            <div class="card">
                <h3 class="section-title">🔢 Numerology × MBTI Test</h3>
                <p class="muted">Based on classic works such as "Numerology: A Guide to Self-Discovery Based on Numbers" and "Life Numbers: Revealing Your Blueprint of Life".</p>
                
                <!-- Force show test button -->
                <div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h4 style="margin: 0 0 10px 0; color: #92400e;">🧪 Debug Information</h4>
                    <p style="margin: 0 0 10px 0; color: #92400e;">If you see this area, it means that the numerology content has been loaded successfully!</p>
                    <button class="btn" onclick="forceShowNumerology()" style="background: #f59e0b;">🔍 Force Show All Content</button>
                    <button class="btn" onclick="testNumerologyFunctions()" style="background: #dc2626; margin-left: 10px;">🧪 Test Functions</button>
                </div>
                
                <div class="grid">
                    <div>
                        <label for="nDate">Date of Birth (MM/DD/YYYY)</label>
                        <input type="text" id="nDate" placeholder="MM/DD/YYYY" maxlength="10" />
                        <label for="nName">Name (Chinese)</label>
                        <input type="text" id="nName" placeholder="Please enter your Chinese name" />
                        <div style="margin-top:12px">
                            <button class="btn" type="button" onclick="analyzeNumerology()">Start Numerology Analysis</button>
                        </div>
                    </div>
                    <div>
                        <h4>Basic Life Numbers</h4>
                        <div class="pill">Life Number</div>
                        <div class="kpi mono" id="lifeNumber">—</div>
                        <div class="pill">Destiny Number</div>
                        <div class="kpi mono" id="destinyNumber">—</div>
                        <div class="pill">Soul Number</div>
                        <div class="kpi mono" id="soulNumber">—</div>
                    </div>
                </div>
            </div>

            <!-- Numerology Analysis Result -->
            <div class="card hidden" id="numerologyAnalysis">
                <h3 class="section-title">🔢 Numerology Analysis</h3>
                <div class="grid">
                    <div class="card numerology">
                        <div class="pill">Traits of Life Number</div>
                        <div id="lifeNumberTraits" class="muted"></div>
                    </div>
                    <div class="card numerology">
                        <div class="pill">Guidance of Destiny Number</div>
                        <div id="destinyNumberGuidance" class="muted"></div>
                    </div>
                    <div class="card numerology">
                        <div class="pill">Meaning of Soul Number</div>
                        <div id="soulNumberMeaning" class="muted"></div>
                    </div>
                    <div class="card numerology">
                        <div class="pill">Analysis of Number Combinations</div>
                        <div id="numberCombination" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- Numerology × MBTI Integration Analysis -->
            <div class="card hidden" id="numerologyMBTIAnalysis">
                <h3 class="section-title">🌟 Numerology × MBTI Integration Analysis</h3>
                <div class="grid">
                    <div class="card integration">
                        <div class="pill">Number-MBTI Mapping</div>
                        <div id="numberMBTIMapping" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Strengths of Character</div>
                        <div id="numerologyStrengths" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Development Advice</div>
                        <div id="numerologyAdvice" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Career Adaptability</div>
                        <div id="numerologyCareer" class="muted"></div>
                    </div>
                </div>
            </div>

            <!-- Numerology Test -->
            <div class="card hidden" id="numerologyTest">
                <h3 class="section-title">🧩 融合测评</h3>
                <div id="numerologyQuiz"></div>
                <div style="margin-top:10px">
                    <button class="btn" type="button" onclick="submitNumerologyTest()">Submit Numerology Test</button>
                    <span id="numerologyResult" class="pill" style="margin-left:10px"></span>
                </div>
            </div>
        </div>

        <!-- Triple Integration Test Content -->
        <div id="fusion-content" class="tab-content">
            <div class="card">
                <h3 class="section-title">🌟 Triple Integration Test</h3>
                <p class="muted">Combining the three systems of Bazi, MBTI, and numerology for comprehensive personality analysis</p>
                
                <div class="grid">
                    <div>
                        <h4>Basic Information</h4>
                        <label for="fDate">Date of Birth (MM/DD/YYYY)</label>
                        <input type="text" id="fDate" placeholder="MM/DD/YYYY" maxlength="10" />
                        <label for="fTime">Birth Time</label>
                        <input type="time" id="fTime" value="12:00" />
                        <label for="fName">Name</label>
                        <input type="text" id="fName" placeholder="Please enter your Chinese name" />
                        <div style="margin-top:12px">
                            <button class="btn" type="button" onclick="runTripleAnalysis()">Start Triple Analysis</button>
                        </div>
                    </div>
                    <div>
                        <h4>Analytical System</h4>
                        <div class="pill">Bazi Metaphysics</div>
                        <div class="muted">Traditional Metaphysics Analysis</div>
                        <div class="pill">MBTI Theory</div>
                        <div class="muted">Modern Psychological Analysis</div>
                        <div class="pill">Numerology</div>
                        <div class="muted">Digital Energy Analysis</div>
                    </div>
                </div>
            </div>

            <!-- Triple Analysis Result -->
            <div class="card hidden" id="tripleAnalysisResult">
                <h3 class="section-title">🌟 Triple Integration Analysis Result</h3>
                <div class="card integration" style="margin-bottom:12px">
                    <div class="pill">Comprehensive MBTI Type</div>
                    <div id="tripleMBTIType" class="kpi" style="font-size:22px; margin-top:6px"></div>
                    <div id="tripleConfidence" class="muted" style="margin-top:4px"></div>
                </div>
                <div class="grid">
                    <div class="card integration">
                        <div class="pill">Bazi Traits</div>
                        <div id="tripleBaziTraits" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Digital Energy</div>
                        <div id="tripleNumberEnergy" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">MBTI Tendency</div>
                        <div id="tripleMBTITendency" class="muted"></div>
                    </div>
                    <div class="card integration">
                        <div class="pill">Integration Advice</div>
                        <div id="tripleAdvice" class="muted"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Heavenly Stems and Earthly Branches Five Elements Mapping
        const STEM_TO_WUXING = { '甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水' };
        const BRANCH_TO_WUXING = { '子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水' };
        const STEM_POLARITY = { '甲':'阳','乙':'阴','丙':'阳','丁':'阴','戊':'阳','己':'阴','庚':'阳','辛':'阴','壬':'阳','癸':'阴' };
        const SHENG = { '木':'火', '火':'土', '土':'金', '金':'水', '水':'木' }; // 生
        const KE   = { '木':'土', '土':'水', '水':'火', '火':'金', '金':'木' }; // 克
        const WUXING_EN = { '木':'Wood','火':'Fire','土':'Earth','金':'Metal','水':'Water' };

        // Numerology Mapping
        const NUMBER_MEANINGS = {
            1: { traits: 'Leadership, Independence, Innovation', mbti: 'ENTJ,ENTP,INTJ', element: '火', career: 'Entrepreneur, Leader, Innovator' },
            2: { traits: 'Cooperation, Sensitivity, Harmony', mbti: 'INFJ,INFP,ENFJ', element: '水', career: 'Consultant, Coordinator, Artist' },
            3: { traits: 'Expression, Creativity, Optimism', mbti: 'ENFP,ESFP,ENTP', element: '木', career: 'Creative Worker, Performer, Teacher' },
            4: { traits: 'Stability, Practicality, Organization', mbti: 'ISTJ,ESTJ,ISFJ', element: '土', career: 'Manager, Engineer, Accountant' },
            5: { traits: 'Freedom, Adventure, Adaptability', mbti: 'ESTP,ISTP,ENFP', element: '水', career: 'Explorer, Salesperson, Reporter' },
            6: { traits: 'Responsibility, Care, Balance', mbti: 'ISFJ,ESFJ,INFJ', element: '土', career: 'Nurse, Teacher, Social Worker' },
            7: { traits: 'Analysis, Spirituality, Mystery', mbti: 'INTP,INTJ,INFJ', element: '金', career: 'Scientist, Philosopher, Analyst' },
            8: { traits: 'Authority, Materialism, Achievement', mbti: 'ENTJ,ESTJ,ISTJ', element: '金', career: 'Entrepreneur, Executive, Politician' },
            9: { traits: 'Humanism, Idealism, Wisdom', mbti: 'INFJ,ENFJ,INFP', element: '火', career: 'Humanitarian, Artist, Mentor' }
        };

        // Chinese Name Numeric Mapping
        const CHINESE_NAME_NUMBERS = {
            // Numbers
            '一':1, '二':2, '三':3, '四':4, '五':5, '六':6, '七':7, '八':8, '九':9,
            '壹':1, '贰':2, '叁':3, '肆':4, '伍':5, '陆':6, '柒':7, '捌':8, '玖':9,
            // Heavenly Stems
            '甲':1, '乙':2, '丙':3, '丁':4, '戊':5, '己':6, '庚':7, '辛':8, '壬':9, '癸':10,
            // Earthly Branches
            '子':1, '丑':2, '寅':3, '卯':4, '辰':5, '巳':6, '午':7, '未':8, '申':9, '酉':10, '戌':11, '亥':12,
            // Five Elements
            '木':3, '火':2, '土':5, '金':7, '水':1,
            // Common Characters
            '王':1, '李':2, '张':3, '刘':4, '陈':5, '杨':6, '赵':7, '黄':8, '周':9, '吴':10,
            '徐':1, '孙':2, '胡':3, '朱':4, '高':5, '林':6, '何':7, '郭':8, '马':9, '罗':10,
            '梁':1, '宋':2, '郑':3, '谢':4, '韩':5, '唐':6, '冯':7, '于':8, '董':9, '萧':10,
            '程':1, '曹':2, '袁':3, '邓':4, '许':5, '傅':6, '沈':7, '曾':8, '彭':9, '吕':10,
            '苏':1, '卢':2, '蒋':3, '蔡':4, '贾':5, '丁':6, '魏':7, '薛':8, '叶':9, '阎':10
        };

        // Tab Switching
        function switchTab(tabName, event) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
                console.log('Displaying content:', tabName + '-content');
            } else {
                console.error('Content element not found:', tabName + '-content');
            }
            
            // Activate corresponding tab
            const targetTab = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Activating tab:', targetTab.textContent);
            }
        }

        // Heavenly Stems and Earthly Branches Five Elements Mapping
        function safeGetPillars(year, month, day, hour, minute) {
            try {
                const Solar = window.Solar || (window.Lunar && window.Lunar.Solar);
                if (!Solar) throw new Error('Module not ready');
                
                const tz = parseInt(document.getElementById('tz').value || '8', 10);
                const jsDate = new Date(Date.UTC(year, month - 1, day, hour - tz, minute, 0));
                const y = jsDate.getUTCFullYear();
                const m = jsDate.getUTCMonth() + 1;
                const d = jsDate.getUTCDate();
                const h = jsDate.getUTCHours();
                const mi = jsDate.getUTCMinutes();

                let solar = null;
                if (typeof Solar.fromYmdHms === 'function') {
                    solar = Solar.fromYmdHms(y, m, d, h, mi, 0);
                } else if (typeof Solar.fromDate === 'function') {
                    solar = Solar.fromDate(new Date(Date.UTC(y, m - 1, d, h, mi, 0)));
                } else {
                    throw new Error('Solar constructor not available');
                }
                const lunar = solar.getLunar();
                const ec = lunar.getEightChar();

                const yearP = (ec.getYear && ec.getYear()) || '';
                const monthP = (ec.getMonth && ec.getMonth()) || '';
                const dayP = (ec.getDay && ec.getDay()) || '';
                const timeP = (ec.getTime && ec.getTime()) || '';
                const pillarText = (yearP && monthP && dayP && timeP) ? `${yearP}｜${monthP}｜${dayP}｜${timeP}` : (ec.toString ? ec.toString() : '— —｜— —｜— —｜— —');

                const parts = pillarText.replace(/[\s]/g,'').split('｜');
                const parseGanZhi = (gz) => gz && gz.length >= 2 ? [gz[0], gz.slice(1)] : ['—','—'];
                const [yG, yZ] = parseGanZhi(parts[0] || '');
                const [mG, mZ] = parseGanZhi(parts[1] || '');
                const [dG, dZ] = parseGanZhi(parts[2] || '');
                const [tG, tZ] = parseGanZhi(parts[3] || '');

                return { pillarText, stems: [yG,mG,dG,tG], branches: [yZ,mZ,dZ,tZ] };
            } catch (e) {
                console.warn('Calculation failed, placeholder will be returned:', e);
                return { pillarText: '— —｜— —｜— —｜— —', stems: ['—','—','—','—'], branches: ['—','—','—','—'] };
            }
        }

        let isLoading = false;

        function showStatus(msg){
            const el = document.getElementById('calcStatus');
            if (!el) return;
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideStatus(){
            const el = document.getElementById('calcStatus');
            if (!el) return;
            el.classList.add('hidden');
            el.textContent = '';
        }
        async function waitForLunar(tries = 40, intervalMs = 150){
            for (let i=0;i<tries;i++){
                if ((window.Solar && (window.Solar.fromYmdHms || window.Solar.fromDate)) ||
                    (window.Lunar && window.Lunar.Solar && (window.Lunar.Solar.fromYmdHms || window.Lunar.Solar.fromDate))) {
                    return true;
                }
                await new Promise(r=>setTimeout(r, intervalMs));
            }
            return false;
        }

        const LUNAR_SOURCES = [
            // local first
            './libs/lunar.min.js',
            // jsDelivr common paths
            'https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript/dist/lunar.min.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript/umd/lunar.js',
            'https://cdn.jsdelivr.net/npm/lunar-javascript',
            // unpkg common paths
            'https://unpkg.com/lunar-javascript/lunar.min.js',
            'https://unpkg.com/lunar-javascript/dist/lunar.min.js',
            'https://unpkg.com/lunar-javascript/umd/lunar.js',
            'https://unpkg.com/lunar-javascript'
        ];

        function loadScriptOnce(src, timeoutMs = 6000){
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                const bust = (src.startsWith('./') || src.startsWith('/')) ? (`${src}?v=${Date.now()}`) : src;
                s.src = bust;
                s.async = true;
                s.crossOrigin = 'anonymous';
                let done = false;
                const timer = setTimeout(() => { if (!done){ done = true; s.remove(); reject(new Error('timeout')); } }, timeoutMs);
                s.onload = () => { if (!done){ done = true; clearTimeout(timer); resolve(true); } };
                s.onerror = () => { if (!done){ done = true; clearTimeout(timer); reject(new Error('load error')); } };
                document.head.appendChild(s);
            });
        }

        async function loadLunarFromFallbacks(){
            for (const url of LUNAR_SOURCES){
                try {
                    showStatus(`Trying to load metaphysics library: ${url}`);
                    await loadScriptOnce(url);
                    const ok = await waitForLunar(20, 100);
                    if (ok) { hideStatus(); return true; }
                } catch (e) {
                    // try next
                }
            }
            return false;
        }

        // Internationalization configuration removed
        
        // Language variable removed
        
        // Lunar library loaded automatically when page loads
        window.addEventListener('load', async () => {
            console.log('Page loaded, starting initialization...');
            
            // Language initialization removed
            
            // Loading lunar library
            try {
                const loaded = await loadLunarFromFallbacks();
                if (loaded) {
                    console.log('✅ Lunar library loaded successfully');
                } else {
                    console.error('❌ Failed to load lunar library');
                }
            } catch (error) {
                console.error('Error loading lunar library:', error);
            }
        });
        
        // Language initialization function removed
        
        // Language switching function removed
        
        // Language name retrieval function removed
        
        // Update language button status function removed
        
        // Application language function removed
        
        // Translation retrieval function removed
        
        // Test internationalization system
        function testI18n() {
            console.log('🧪 Starting internationalization system test...');
            
            // Check TRANSLATIONS object
            console.log('TRANSLATIONS object:', TRANSLATIONS);
            console.log('Current language:', currentLanguage);
            console.log('Available languages:', Object.keys(TRANSLATIONS));
            
            // Test translation functionality
            const testKey = 'main.title';
            const translation = getTranslation(testKey);
            console.log(`Test translation key "${testKey}":`, translation);
            
            // Check page elements
            const elements = document.querySelectorAll('[data-i18n]');
            console.log('Number of elements needing translation:', elements.length);
            
            elements.forEach((element, index) => {
                const key = element.getAttribute('data-i18n');
                const translation = getTranslation(key);
                console.log(`Element ${index + 1}: ${key} = ${translation}`);
            });
            
            // Display test results
            alert(`Internationalization test results:\nCurrent language: ${currentLanguage}\nAvailable languages: ${Object.keys(TRANSLATIONS).join(', ')}\nNumber of translated elements: ${elements.length}\nTranslation test: ${translation}`);
        }
        
        // Show toast message
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                .toast-success { background: rgba(40, 167, 69, 0.9) !important; }
                .toast-error { background: rgba(220, 53, 69, 0.9) !important; }
                .toast-info { background: rgba(23, 162, 184, 0.9) !important; }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Numerology analysis
        function analyzeNumerology() {
            console.log('Numerology analysis function called');
            
            const birthDate = document.getElementById('nDate').value;
            const name = document.getElementById('nName').value;

            console.log('Birth date:', birthDate);
            console.log('Name:', name);

            if (!birthDate) {
                showToast('Please enter your birth date', 'error');
                return;
            }

            // Calculate life number
            const lifeNumber = calculateLifeNumber(birthDate);
            const destinyNumber = calculateDestinyNumber(birthDate);
            const soulNumber = calculateSoulNumber(name);

            console.log('Calculation results:', { lifeNumber, destinyNumber, soulNumber });

            // Display basic numbers
            document.getElementById('lifeNumber').textContent = lifeNumber;
            document.getElementById('destinyNumber').textContent = destinyNumber;
            document.getElementById('soulNumber').textContent = soulNumber;

            // Analyze number traits
            analyzeNumberTraits(lifeNumber, destinyNumber, soulNumber);

            // Display analysis results
            document.getElementById('numerologyAnalysis').classList.remove('hidden');
            document.getElementById('numerologyMBTIAnalysis').classList.remove('hidden');

            // Generate numerology test questions
            generateNumerologyQuiz(lifeNumber, destinyNumber, soulNumber);
        }

        // Calculate life number
        function calculateLifeNumber(birthDate) {
            // Convert MM/DD/YYYY to YYYY-MM-DD if needed
            const isoDate = birthDate.includes('/') ? convertToISOFormat(birthDate) : birthDate;
            const dateStr = isoDate.replace(/-/g, '');
            let sum = 0;
            for (let i = 0; i < dateStr.length; i++) {
                sum += parseInt(dateStr[i]);
            }
            while (sum > 9) {
                sum = Math.floor(sum / 10) + (sum % 10);
            }
            return sum;
        }

        // Calculate destiny number
        function calculateDestinyNumber(birthDate) {
            // Convert MM/DD/YYYY to YYYY-MM-DD if needed
            const isoDate = birthDate.includes('/') ? convertToISOFormat(birthDate) : birthDate;
            const dateStr = isoDate.replace(/-/g, '');
            let sum = 0;
            for (let i = 0; i < dateStr.length; i++) {
                sum += parseInt(dateStr[i]);
            }
            return sum;
        }

        // Calculate soul number
        function calculateSoulNumber(name) {
            if (!name) return 0;
            let sum = 0;
            let found = false;
            
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                if (CHINESE_NAME_NUMBERS[char]) {
                    sum += CHINESE_NAME_NUMBERS[char];
                    found = true;
                }
            }
            
            // If no mapping characters are found, use the Unicode code of the character
            if (!found) {
                for (let i = 0; i < name.length; i++) {
                    const charCode = name.charCodeAt(i);
                    sum += (charCode % 9) + 1; // Convert Unicode code to a number between 1-9
                }
            }
            
            // Convert the sum to a single digit
            while (sum > 9) {
                sum = Math.floor(sum / 10) + (sum % 10);
            }
            
            return sum;
        }

        // Analyze number traits
        function analyzeNumberTraits(lifeNumber, destinyNumber, soulNumber) {
            const lifeInfo = NUMBER_MEANINGS[lifeNumber] || {};
            const destinyInfo = NUMBER_MEANINGS[destinyNumber] || {};
            const soulInfo = NUMBER_MEANINGS[soulNumber] || {};

            // Life number traits
            const lifeTraits = lifeInfo.traits || 'Traits not obvious';
            const lifeElement = lifeInfo.element || '';
            const lifeCareer = lifeInfo.career || '';
            
            document.getElementById('lifeNumberTraits').innerHTML = 
                `<strong>${lifeNumber}号人特质：</strong>${lifeTraits}<br>
                 <small>五行属性：${lifeElement} | 适配职业：${lifeCareer}</small>`;
            
            // Destiny number guidance
            const destinyTraits = destinyInfo.traits || 'Guidance not obvious';
            const destinyElement = destinyInfo.element || '';
            
            document.getElementById('destinyNumberGuidance').innerHTML = 
                `<strong>命运指引：</strong>${destinyTraits}<br>
                 <small>五行属性：${destinyElement}</small>`;
            
            // Soul number connotation
            const soulTraits = soulInfo.traits || 'Connotation not obvious';
            const soulElement = soulInfo.element || '';
            
            document.getElementById('soulNumberMeaning').innerHTML = 
                `<strong>灵魂内涵：</strong>${soulTraits}<br>
                 <small>五行属性：${soulElement}</small>`;

            // Analysis of number combinations
            const combination = analyzeNumberCombination(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numberCombination').innerHTML = combination;

            // MBTI mapping analysis
            const mbtiMapping = analyzeNumberMBTIMapping(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numberMBTIMapping').innerHTML = mbtiMapping;

            // Character strengths
            const strengths = analyzeNumerologyStrengths(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numerologyStrengths').innerHTML = strengths;

            // Development advice
            const advice = analyzeNumerologyAdvice(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numerologyAdvice').innerHTML = advice;

            // Career adaptability
            const career = analyzeNumerologyCareer(lifeNumber, destinyNumber, soulNumber);
            document.getElementById('numerologyCareer').innerHTML = career;
        }

        // Analyze number combinations
        function analyzeNumberCombination(life, destiny, soul) {
            let analysis = '';
            let energyLevel = '';
            let compatibility = '';
            
            if (life === destiny && destiny === soul) {
                analysis = 'Three numbers are unified, concentrated energy, and the character traits are very prominent';
                energyLevel = 'Energy concentration: extremely high';
                compatibility = 'Compatibility: extremely strong, but possibly too单一';
            } else if (life === destiny || destiny === soul || life === soul) {
                analysis = 'Two numbers are the same, complementary energy, and the character traits are obvious';
                energyLevel = 'Energy concentration: high';
                compatibility = 'Compatibility: strong, mainly prominent character';
            } else if (Math.abs(life - destiny) <= 2 && Math.abs(destiny - soul) <= 2) {
                analysis = 'Three numbers are close, harmonious energy, and the character traits are balanced';
                energyLevel = 'Energy concentration: medium';
                compatibility = 'Compatibility: good, characteristic coordination';
            } else {
                analysis = 'Three numbers are scattered, diverse energy, and the character traits are rich';
                energyLevel = 'Energy concentration: low';
                compatibility = 'Compatibility: diverse, need integration';
            }

            // Add analysis of mutual generation and suppression between five elements
            const lifeElement = NUMBER_MEANINGS[life]?.element || '';
            const destinyElement = NUMBER_MEANINGS[destiny]?.element || '';
            const soulElement = NUMBER_MEANINGS[soul]?.element || '';
            
            let elementAnalysis = '';
            if (lifeElement && destinyElement && soulElement) {
                elementAnalysis = `<br><small>Five elements combination: ${lifeElement} + ${destinyElement} + ${soulElement}</small>`;
            }

            return `<strong>Combination Characteristics：</strong>${analysis}<br>
                    <small>${energyLevel} | ${compatibility}${elementAnalysis}</small>`;
        }

        // Analyze number-MBTI mapping
        function analyzeNumberMBTIMapping(life, destiny, soul) {
            const lifeMBTI = NUMBER_MEANINGS[life]?.mbti || '';
            const destinyMBTI = NUMBER_MEANINGS[destiny]?.mbti || '';
            const soulMBTI = NUMBER_MEANINGS[soul]?.mbti || '';

            let mapping = '';
            let dominantType = '';
            let compatibility = '';
            
            if (lifeMBTI) mapping += `Life number: ${lifeMBTI}<br>`;
            if (destinyMBTI) mapping += `Destiny number: ${destinyMBTI}<br>`;
            if (soulMBTI) mapping += `Soul number: ${soulMBTI}`;

            // Analyze dominant type
            const allTypes = [lifeMBTI, destinyMBTI, soulMBTI].filter(Boolean);
            if (allTypes.length > 0) {
                const typeCounts = {};
                allTypes.forEach(type => {
                    const types = type.split(',');
                    types.forEach(t => {
                        typeCounts[t] = (typeCounts[t] || 0) + 1;
                    });
                });
                
                const dominantTypes = Object.entries(typeCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 2)
                    .map(([type, count]) => `${type}(${count}次)`);
                
                dominantType = `Dominant type: ${dominantTypes.join('、')}`;
                
                // Compatibility analysis
                if (Object.keys(typeCounts).length <= 2) {
                    compatibility = 'Compatibility: high, type concentration';
                } else if (Object.keys(typeCounts).length <= 4) {
                    compatibility = 'Compatibility: medium, diverse types';
                } else {
                    compatibility = 'Compatibility: low, dispersed types';
                }
            }

            return `${mapping || 'No MBTI mapping information available'}<br>
                    <small><strong>${dominantType}</strong><br>
                    <strong>${compatibility}</strong></small>`;
        }

        // Analyze numerological strengths
        function analyzeNumerologyStrengths(life, destiny, soul) {
            const strengths = [];
            const lifeInfo = NUMBER_MEANINGS[life] || {};
            const destinyInfo = NUMBER_MEANINGS[destiny] || {};
            const soulInfo = NUMBER_MEANINGS[soul] || {};
            
            // Strengths of life number
            if (life <= 3) {
                strengths.push(`Innovative thinking (${life}th trait)`);
                strengths.push('Expression ability, flexibility');
            } else if (life >= 4 && life <= 6) {
                strengths.push(`Organizational ability (${life}th trait)`);
                strengths.push('Responsibility, stability');
            } else if (life >= 7 && life <= 9) {
                strengths.push(`Analytical ability (${life}th trait)`);
                strengths.push('Leadership, professionalism');
            }

            // Strengths of destiny number
            if (destiny <= 3) {
                strengths.push(`Flexibility (${destiny}th trait)`);
                strengths.push('Adaptability, innovation');
            } else if (destiny >= 4 && destiny <= 6) {
                strengths.push(`Stability (${destiny}th trait)`);
                strengths.push('Reliability, organization');
            } else if (destiny >= 7 && destiny <= 9) {
                strengths.push(`Deep thinking (${destiny}th trait)`);
                strengths.push('Professional ability, insight');
            }

            // Strengths of soul number
            if (soul > 0) {
                strengths.push(`Inner traits (${soul}th soul)`);
                strengths.push(soulInfo.traits ? soulInfo.traits.split(',')[0] : 'Unique personality');
            }

            // Strengths of five elements
            const elements = [lifeInfo.element, destinyInfo.element, soulInfo.element].filter(Boolean);
            if (elements.length > 0) {
                const uniqueElements = [...new Set(elements)];
                if (uniqueElements.length === 1) {
                    strengths.push(`${uniqueElements[0]} specialization, concentrated energy`);
                } else {
                    strengths.push(`${uniqueElements.join('+')} combination, diverse energy`);
                }
            }

            return `<strong>Core strengths：</strong>${strengths.join('、')}`;
        }

        // Analyze numerological advice
        function analyzeNumerologyAdvice(life, destiny, soul) {
            let advice = '';
            let focus = '';
            let warning = '';
            
            // Life number advice
            if (life <= 3) {
                advice = 'Utilize creativity, pay attention to detail management';
                focus = 'Key development: innovative thinking, expression ability, flexibility';
                warning = 'Need to pay attention: detail management, execution, stability';
            } else if (life >= 4 && life <= 6) {
                advice = 'Maintain stability, cultivate innovative thinking';
                focus = 'Key development: organizational ability, responsibility, stability';
                warning = 'Need to pay attention: innovative thinking, flexibility, breakthrough';
            } else {
                advice = 'Utilize professional skills, pay attention to teamwork';
                focus = 'Key development: analytical ability, leadership, professionalism';
                warning = 'Need to pay attention: teamwork, communication skills, inclusiveness';
            }

            // Destiny number advice
            let destinyAdvice = '';
            if (destiny <= 3) {
                destinyAdvice = 'Develop adaptability, pay attention to consistency';
            } else if (destiny >= 4 && destiny <= 6) {
                destinyAdvice = 'Utilize stable advantages, pay attention to flexibility';
            } else {
                destinyAdvice = 'Deepen professional skills, pay attention to practicability';
            }

            // Soul number advice
            let soulAdvice = '';
            if (soul > 0) {
                const soulInfo = NUMBER_MEANINGS[soul] || {};
                if (soul <= 3) {
                    soulAdvice = 'Focus on inner growth, cultivate self-awareness';
                } else if (soul >= 4 && soul <= 6) {
                    soulAdvice = 'Balance internal and external needs, cultivate self-regulation';
                } else {
                    soulAdvice = 'Deepen inner wisdom, cultivate self-transcendence';
                }
            }

            return `<strong>Development advice：</strong>${advice}<br>
                    <small><strong>Key development：</strong>${focus}<br>
                    <strong>Need to pay attention：</strong>${warning}<br>
                    <strong>Destiny guidance：</strong>${destinyAdvice}<br>
                    <strong>Soul growth：</strong>${soulAdvice}</small>`;
        }

        // Analyze numerological career
        function analyzeNumerologyCareer(life, destiny, soul) {
            const lifeCareer = NUMBER_MEANINGS[life]?.career || '';
            const destinyCareer = NUMBER_MEANINGS[destiny]?.career || '';
            const soulCareer = NUMBER_MEANINGS[soul]?.career || '';
            
            let careers = [];
            let careerTypes = [];
            let developmentPath = '';
            
            // Collect career advice
            if (lifeCareer) careers.push(lifeCareer);
            if (destinyCareer && destinyCareer !== lifeCareer) careers.push(destinyCareer);
            if (soulCareer && !careers.includes(soulCareer)) careers.push(soulCareer);

            // Analyze career types
            if (life <= 3 || destiny <= 3) {
                careerTypes.push('Innovative and creative');
            }
            if (life >= 4 && life <= 6 || destiny >= 4 && destiny <= 6) {
                careerTypes.push('Management and organization');
            }
            if (life >= 7 || destiny >= 7) {
                careerTypes.push('Professional analysis');
            }

            // Development path advice
            if (life <= 3 && destiny <= 3) {
                developmentPath = 'Suitable for starting from an innovative position and gradually developing management capabilities';
            } else if (life >= 7 && destiny >= 7) {
                developmentPath = 'Suitable for starting from a professional position and gradually developing leadership capabilities';
            } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                developmentPath = 'Suitable for starting from a management position and gradually developing innovative capabilities';
            } else {
                developmentPath = 'Suitable for starting from a comprehensive position and gradually developing professional capabilities';
            }

            return `<strong>Suitable career：</strong>${careers.join('、') || 'Based on interest and ability'}<br>
                    <small><strong>Career type：</strong>${careerTypes.join('、')}<br>
                    <strong>Development path：</strong>${developmentPath}</small>`;
        }

        // Generate numerology test questions
        function generateNumerologyQuiz(life, destiny, soul) {
            const quizContainer = document.getElementById('numerologyQuiz');
            quizContainer.innerHTML = '';

            const questions = [
                {
                    id: 1,
                    question: 'When facing new challenges, you are more inclined to:',
                    options: [
                        { text: 'Develop a detailed plan and execute it step by step', score: { S: 1, J: 1, number: { 4: 0.5, 6: 0.5 } } },
                        { text: 'Flexibly respond and adapt to changes', score: { N: 1, P: 1, number: { 5: 0.5, 3: 0.5 } } }
                    ]
                },
                {
                    id: 2,
                    question: 'In a team, you are more willing to play:',
                    options: [
                        { text: 'Leader, establish direction and strategy', score: { E: 1, J: 1, number: { 1: 0.5, 8: 0.5 } } },
                        { text: 'Supporter, assist others to complete tasks', score: { I: 1, F: 1, number: { 2: 0.5, 6: 0.5 } } }
                    ]
                },
                {
                    id: 3,
                    question: 'When solving problems, you rely more on:',
                    options: [
                        { text: 'Logical analysis and data support', score: { T: 1, S: 1, number: { 7: 0.5, 4: 0.5 } } },
                        { text: 'Intuition and creative inspiration', score: { F: 1, N: 1, number: { 3: 0.5, 9: 0.5 } } }
                    ]
                },
                {
                    id: 4,
                    question: 'Regarding rules and traditions, your attitude is:',
                    options: [
                        { text: 'Respect and follow, maintain order', score: { S: 1, J: 1, number: { 4: 0.5, 6: 0.5 } } },
                        { text: 'Flexibly apply, break when necessary', score: { N: 1, P: 1, number: { 5: 0.5, 1: 0.5 } } }
                    ]
                },
                {
                    id: 5,
                    question: 'In social situations, you are more:',
                    options: [
                        { text: 'Actively communicate and expand your network', score: { E: 1, number: { 1: 0.5, 3: 0.5 } } },
                        { text: 'Observe and deeply communicate', score: { I: 1, number: { 2: 0.5, 7: 0.5 } } }
                    ]
                },
                {
                    id: 6,
                    question: 'When dealing with conflicts, you are more inclined to:',
                    options: [
                        { text: 'Face it directly and seek solutions', score: { T: 1, E: 0.5, number: { 1: 0.5, 8: 0.5 } } },
                        { text: 'Calm the atmosphere and maintain harmonious relationships', score: { F: 1, I: 0.5, number: { 2: 0.5, 6: 0.5 } } }
                    ]
                },
                {
                    id: 7,
                    question: 'When learning new knowledge, you prefer:',
                    options: [
                        { text: 'Systematic learning and establish a knowledge framework', score: { S: 1, J: 1, number: { 4: 0.5, 7: 0.5 } } },
                        { text: 'Jump learning and seek creative connections', score: { N: 1, P: 1, number: { 3: 0.5, 5: 0.5 } } }
                    ]
                },
                {
                    id: 8,
                    question: 'When facing pressure, you:',
                    options: [
                        { text: 'Develop a plan and gradually resolve it', score: { J: 1, S: 0.5, number: { 4: 0.5, 6: 0.5 } } },
                        { text: 'Seek support and ask for help', score: { F: 1, E: 0.5, number: { 2: 0.5, 9: 0.5 } } }
                    ]
                }
            ];

            // Store questions in a global variable for use in the submission function
            window._numerologyQuestions = questions;

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'q';
                questionDiv.innerHTML = `<div style="font-weight:700">${index + 1}. ${q.question}</div>`;
                
                q.options.forEach((option, optIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'opt';
                    optionDiv.innerHTML = `<label><input type="radio" name="nq${q.id}" value="${optIndex}"> ${option.text}</label>`;
                    questionDiv.appendChild(optionDiv);
                });
                
                quizContainer.appendChild(questionDiv);
            });

            document.getElementById('numerologyTest').classList.remove('hidden');
        }

        // Submit numerology test
        function submitNumerologyTest() {
            const questions = document.querySelectorAll('#numerologyQuiz .q');
            let scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            let numberScores = {};

            questions.forEach((q, index) => {
                const selected = q.querySelector('input:checked');
                if (selected) {
                    const optionIndex = parseInt(selected.value);
                    const question = window._numerologyQuestions ? window._numerologyQuestions[index] : null;
                    if (question && question.options[optionIndex]) {
                        const option = question.options[optionIndex];
                        Object.entries(option.score).forEach(([key, value]) => {
                            if (key === 'number') {
                                Object.entries(value).forEach(([num, score]) => {
                                    numberScores[num] = (numberScores[num] || 0) + score;
                                });
                            } else {
                                scores[key] = (scores[key] || 0) + value;
                            }
                        });
                    }
                }
            });

            const mbtiType = determineMBTIType(scores);
            const result = `Numerology MBTI type: ${mbtiType}`;
            
            // Display detailed results
            document.getElementById('numerologyResult').textContent = result;
            
            // Display numerology energy analysis
            const numberAnalysis = analyzeNumberEnergy(numberScores);
            const resultDiv = document.getElementById('numerologyResult');
            resultDiv.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Numerology MBTI type: ${mbtiType}</strong></div>
                <div style="font-size: 12px; color: #6b7280;">${numberAnalysis}</div>
            `;
        }

        // Analyze numerology energy
        function analyzeNumberEnergy(numberScores) {
            if (Object.keys(numberScores).length === 0) return 'Please complete the test questions';
            
            const topNumbers = Object.entries(numberScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([num, score]) => `${num}号能量(${score.toFixed(1)})`);
            
            return `Numerology energy: ${topNumbers.join('、')}`;
        }

        // Determine MBTI type
        function determineMBTIType(scores) {
            const E = scores.E || 0;
            const I = scores.I || 0;
            const S = scores.S || 0;
            const N = scores.N || 0;
            const T = scores.T || 0;
            const F = scores.F || 0;
            const J = scores.J || 0;
            const P = scores.P || 0;

            const first = E > I ? 'E' : 'I';
            const second = S > N ? 'S' : 'N';
            const third = T > F ? 'T' : 'F';
            const fourth = J > P ? 'J' : 'P';

            return first + second + third + fourth;
        }

        // Triple integration analysis
        function runTripleAnalysis() {
            const birthDate = document.getElementById('fDate').value;
            const birthTime = document.getElementById('fTime').value;
            const name = document.getElementById('fName').value;

            if (!birthDate) {
                showToast('Please enter your birth date', 'error');
                return;
            }

            // Calculate Bazi
            const baziResult = calculateBazi(birthDate, birthTime);
            
            // Calculate numerology
            const lifeNumber = calculateLifeNumber(birthDate);
            const destinyNumber = calculateDestinyNumber(birthDate);
            const soulNumber = calculateSoulNumber(name);

            // Comprehensive analysis
            const tripleResult = analyzeTripleIntegration(baziResult, lifeNumber, destinyNumber, soulNumber);
            
            // Display results
            displayTripleResult(tripleResult);
        }

        // Calculate Bazi (simplified version)
        function calculateBazi(birthDate, birthTime) {
            // Here, we simplify the processing, and in reality, we should call the complete Bazi calculation
            const date = new Date(birthDate + 'T' + birthTime);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();

            // Simplified calculation of Heavenly Stems and Earthly Branches (in reality, we should use a professional Bazi calculation library)
            const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const branches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            const yearStem = stems[year % 10];
            const monthStem = stems[month % 10];
            const dayStem = stems[day % 10];
            const hourStem = stems[hour % 10];

            return {
                year, month, day, hour,
                yearStem,
                monthStem,
                dayStem,
                hourStem,
                yearBranch: branches[year % 12],
                monthBranch: branches[month % 12],
                dayBranch: branches[day % 12],
                hourBranch: branches[hour % 12]
            };
        }

        // Triple integration analysis
        function analyzeTripleIntegration(bazi, life, destiny, soul) {
            // Based on the comprehensive analysis of Bazi and numerology
            let mbtiType = 'INTJ'; // Default type
            let confidence = 'medium';
            let baziTraits = 'Traditional metaphysics characteristics';
            let numberEnergy = 'Digital energy characteristics';
            let mbtiTendency = 'MBTI tendency characteristics';
            let advice = 'Comprehensive development advice';

            // Fusion logic between numerology and MBTI
            if (life <= 3 && destiny <= 3) {
                mbtiType = 'ENFP';
                confidence = 'high';
                numberEnergy = `Life number ${life}: innovative thinking + Destiny number ${destiny}: flexible adaptation`;
                mbtiTendency = 'Outgoing intuitive emotional perception type, rich in creativity and adaptability';
                advice = 'Utilize innovative thinking, cultivate execution, pay attention to detail management';
            } else if (life >= 7 && destiny >= 7) {
                mbtiType = 'INTJ';
                confidence = 'high';
                numberEnergy = `Life number ${life}: analytical ability + Destiny number ${destiny}: deep thinking`;
                mbtiTendency = 'Introverted intuitive thinking judgment type, good at strategic planning and system thinking';
                advice = 'Utilize analytical advantages, cultivate communication skills, pay attention to teamwork';
            } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                mbtiType = 'ISTJ';
                confidence = 'high';
                numberEnergy = `Life number ${life}: organizational ability + Destiny number ${destiny}: stability`;
                mbtiTendency = 'Introverted feeling thinking judgment type, paying attention to order and reliability';
                advice = 'Utilize organizational advantages, cultivate innovative thinking, pay attention to flexibility';
            } else if (life <= 3 && destiny >= 7) {
                mbtiType = 'ENTP';
                confidence = 'medium';
                numberEnergy = `Life number ${life}: innovative thinking + Destiny number ${destiny}: deep thinking`;
                mbtiTendency = 'Outgoing intuitive thinking perception type, rich in creativity and analytical ability';
                advice = 'Balance innovation and analysis, cultivate focus, pay attention to execution';
            } else if (life >= 7 && destiny <= 3) {
                mbtiType = 'INFJ';
                confidence = 'medium';
                numberEnergy = `Life number ${life}: analytical ability + Destiny number ${destiny}: innovative thinking`;
                mbtiTendency = 'Introverted intuitive emotional judgment type, possessing insight and idealism';
                advice = 'Utilize insight advantages, cultivate proactive action, pay attention to practical implementation';
            } else {
                // Analysis of other combinations
                mbtiType = 'ISFP'; // Default type
                confidence = 'medium';
                numberEnergy = `Life number ${life}: ${NUMBER_MEANINGS[life]?.traits || 'traits'} + Destiny number ${destiny}: ${NUMBER_MEANINGS[destiny]?.traits || 'traits'}`;
                mbtiTendency = 'Balanced type, possessing diverse traits, need to analyze based on specific circumstances';
                advice = 'Utilize main advantages, balance development, pay attention to integrating diverse traits';
            }

            // Add analysis of soul number
            if (soul > 0) {
                const soulInfo = NUMBER_MEANINGS[soul] || {};
                numberEnergy += `<br>Soul number ${soul}: ${soulInfo.traits || 'inner traits'}`;
                if (soul <= 3) {
                    advice += '<br>Focus on inner growth, cultivate self-awareness';
                } else if (soul >= 7) {
                    advice += '<br>Deepen inner wisdom, cultivate self-transcendence';
                }
            }

            // Analysis of Bazi traits
            const yearElement = STEM_TO_WUXING[bazi.yearStem] || '';
            const monthElement = STEM_TO_WUXING[bazi.monthStem] || '';
            const dayElement = STEM_TO_WUXING[bazi.dayStem] || '';
            const hourElement = STEM_TO_WUXING[bazi.hourStem] || '';
            
            if (yearElement) {
                const elementTraits = {
                    '木': 'Wood nature is benevolent, possessing growth, upward, and进取的特质',
                    '火': 'Fire nature is ceremonial, possessing光明,温暖,热情的特质',
                    '土': 'Earth nature is trustworthy, possessing inclusiveness, stability, and practicality',
                    '金': 'Metal nature is idealistic, possessing decisiveness, decisiveness, and principle',
                    '水': 'Water nature is intelligent, possessing wisdom, flexibility, and inclusiveness'
                };
                
                baziTraits = `Year stem ${bazi.yearStem}(${yearElement}): ${elementTraits[yearElement]}`;
                
                // Add analysis of lunar month
                if (monthElement) {
                    baziTraits += `<br>Month stem ${bazi.monthStem}(${monthElement}): Lunar month in season, affecting the strength of the day master`;
                }
                
                // Add analysis of day master
                if (dayElement) {
                    baziTraits += `<br>Day stem ${bazi.dayStem}(${dayElement}): Day master, core of character`;
                }
                
                // Add analysis of hour stem
                if (hourElement) {
                    baziTraits += `<br>Hour stem ${bazi.hourStem}(${hourElement}): Hour stem, late development`;
                }
            }

            // Improve MBTI tendency analysis
            if (mbtiTendency === 'MBTI tendency characteristics') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    mbtiTendency = 'Outgoing intuitive emotional perception type, rich in creativity and adaptability, suitable for innovative and social work';
                } else if (life >= 7 && destiny >= 7) {
                    mbtiTendency = 'Introverted intuitive thinking judgment type, good at strategic planning and system thinking, suitable for analysis and leadership work';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    mbtiTendency = 'Introverted feeling thinking judgment type, paying attention to order and reliability, suitable for management and execution work';
                } else {
                    mbtiTendency = 'Balanced type, possessing diverse traits, need to analyze based on specific circumstances, suitable for comprehensive and coordinated work';
                }
            }

            // Improve comprehensive advice analysis
            if (advice === 'Comprehensive development advice') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    advice = 'Utilize innovative thinking, cultivate execution, pay attention to detail management, balance creative and practical implementation';
                } else if (life >= 7 && destiny >= 7) {
                    advice = 'Utilize analytical advantages, cultivate communication skills, pay attention to teamwork, balance professional and collaborative work';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    advice = 'Utilize organizational advantages, cultivate innovative thinking, pay attention to flexibility, balance stability and innovation';
                } else {
                    advice = 'Utilize main advantages, balance development, pay attention to integrating diverse traits, find a development path suitable for yourself';
                }
            }

            // Improve comprehensive advice
            if (advice === 'Comprehensive development advice') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    advice = 'Utilize innovative thinking, cultivate execution, pay attention to detail management, balance creative and practical implementation';
                } else if (life >= 7 && destiny >= 7) {
                    advice = 'Utilize analytical advantages, cultivate communication skills, pay attention to teamwork, balance professional and collaborative work';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    advice = 'Utilize organizational advantages, cultivate innovative thinking, pay attention to flexibility, balance stability and innovation';
                } else {
                    advice = 'Utilize main advantages, balance development, pay attention to integrating diverse traits, find a development path suitable for yourself';
                }
            }

            // Improve confidence analysis
            if (confidence === 'medium') {
                if (life === destiny || destiny === soul || life === soul) {
                    confidence = 'high';
                } else if (Math.abs(life - destiny) <= 1 && Math.abs(destiny - soul) <= 1) {
                    confidence = 'high';
                } else if (Math.abs(life - destiny) <= 3 && Math.abs(destiny - soul) <= 3) {
                    confidence = 'medium';
                } else {
                    confidence = 'low';
                }
            }

            // Improve Bazi traits analysis
            if (baziTraits === 'Traditional metaphysics characteristics') {
                const yearElement = STEM_TO_WUXING[bazi.yearStem] || '';
                const monthElement = STEM_TO_WUXING[bazi.monthStem] || '';
                const dayElement = STEM_TO_WUXING[bazi.dayStem] || '';
                const hourElement = STEM_TO_WUXING[bazi.hourStem] || '';
                
                if (yearElement) {
                    const elementTraits = {
                        '木': 'Wood nature is benevolent, possessing growth, upward, and进取的特质',
                        '火': 'Fire nature is ceremonial, possessing光明,温暖,热情的特质',
                        '土': 'Earth nature is trustworthy, possessing inclusiveness, stability, and practicality',
                        '金': 'Metal nature is idealistic, possessing decisiveness, decisiveness, and principle',
                        '水': 'Water nature is intelligent, possessing wisdom, flexibility, and inclusiveness'
                    };
                    
                    baziTraits = `Year stem ${bazi.yearStem}(${yearElement}): ${elementTraits[yearElement]}`;
                    
                    // Add analysis of lunar month
                    if (monthElement) {
                        baziTraits += `<br>Month stem ${bazi.monthStem}(${monthElement}): Lunar month in season, affecting the strength of the day master`;
                    }
                    
                    // Add analysis of day master
                    if (dayElement) {
                        baziTraits += `<br>Day stem ${bazi.dayStem}(${dayElement}): Day master, core of character`;
                    }
                    
                    // Add analysis of hour stem
                    if (hourElement) {
                        baziTraits += `<br>Hour stem ${bazi.hourStem}(${hourElement}): Hour stem, late development`;
                    }
                }
            }

            // Improve numerology energy analysis
            if (numberEnergy === 'Digital energy characteristics') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                const soulInfo = NUMBER_MEANINGS[soul] || {};
                
                numberEnergy = `Life number ${life}: ${lifeInfo.traits || 'traits'} + Destiny number ${destiny}: ${destinyInfo.traits || 'traits'}`;
                
                if (soul > 0) {
                    numberEnergy += `<br>Soul number ${soul}: ${soulInfo.traits || 'inner traits'}`;
                }
                
                // Add analysis of five elements
                const elements = [lifeInfo.element, destinyInfo.element, soulInfo.element].filter(Boolean);
                if (elements.length > 0) {
                    const uniqueElements = [...new Set(elements)];
                    if (uniqueElements.length === 1) {
                        numberEnergy += `<br>Five elements specialization: ${uniqueElements[0]} element, concentrated energy`;
                    } else {
                        numberEnergy += `<br>Five elements combination: ${uniqueElements.join('+')}, diverse energy`;
                    }
                }
            }

            // Improve MBTI tendency analysis
            if (mbtiTendency === 'MBTI tendency characteristics') {
                const lifeInfo = NUMBER_MEANINGS[life] || {};
                const destinyInfo = NUMBER_MEANINGS[destiny] || {};
                
                if (life <= 3 && destiny <= 3) {
                    mbtiTendency = 'Outgoing intuitive emotional perception type, rich in creativity and adaptability, suitable for innovative and social work';
                } else if (life >= 7 && destiny >= 7) {
                    mbtiTendency = 'Introverted intuitive thinking judgment type, good at strategic planning and system thinking, suitable for analysis and leadership work';
                } else if (life >= 4 && life <= 6 && destiny >= 4 && destiny <= 6) {
                    mbtiTendency = 'Introverted feeling thinking judgment type, paying attention to order and reliability, suitable for management and execution work';
                } else {
                    mbtiTendency = 'Balanced type, possessing diverse traits, need to analyze based on specific circumstances, suitable for comprehensive and coordinated work';
                }
            }

            return {
                mbtiType,
                confidence,
                baziTraits,
                numberEnergy,
                mbtiTendency,
                advice
            };
        }

        // Display triple integration results
        function displayTripleResult(result) {
            document.getElementById('tripleMBTIType').textContent = result.mbtiType;
            document.getElementById('tripleConfidence').textContent = `Confidence: ${result.confidence}`;
            document.getElementById('tripleBaziTraits').innerHTML = result.baziTraits;
            document.getElementById('tripleNumberEnergy').innerHTML = result.numberEnergy;
            document.getElementById('tripleMBTITendency').innerHTML = result.mbtiTendency;
            document.getElementById('tripleAdvice').innerHTML = result.advice;

            document.getElementById('tripleAnalysisResult').classList.remove('hidden');
        }

        // ——— Fusion Question Bank and Scoring ———
        const FUSION_QUESTIONS = [
            { id:1, d:'EI', when:{ any:[{ dayElementIn:['木','火'] }, { tenGodsTopIn:['比劫','食伤'] }] }, t:'New project Kickoff, you are more likely to:', a:{ text:'Take the initiative to establish the framework and synchronize the rhythm', mbti:{E:1.2}, bias:{ element:{火:+0.3,木:+0.2}, strength:{'偏旺':-0.1,'偏弱':+0.1} } }, b:{ text:'First listen to information and then give key opinions', mbti:{I:1.2}, bias:{ element:{水:+0.3,金:+0.2} } } },
            { id:2, d:'EI', when:{ any:[{ dayElementIn:['金','水'] }, { tenGodsTopIn:['官杀','印'] }] }, t:'In large social situations, you are more:', a:{ text:'Naturelly connect people and quickly establish connections', mbti:{E:1.0}, bias:{ element:{火:+0.2,木:+0.2} } }, b:{ text:'Stop at the point and keep energy in deep conversation', mbti:{I:1.0}, bias:{ element:{金:+0.2,水:+0.2} } } },
            { id:3, d:'SN', when:{ any:[{ dayElementIn:['土','金'] }, { monthBranchIn:['丑','辰','未','戌'] }] }, t:'When making plans, you will prioritize:', a:{ text:'Research cases and constraints, first feasible then optimized', mbti:{S:1.2}, bias:{ element:{土:+0.3,金:+0.2} } }, b:{ text:'Set up assumptions and blueprints, first direction then refined', mbti:{N:1.2}, bias:{ element:{木:+0.2,火:+0.2} } } },
            { id:4, d:'SN', when:{ any:[{ dayElementIn:['木','火'] }, { tenGodsTopIn:['食伤'] }] }, t:'When encountering ambiguous questions, you are more:', a:{ text:'Grab obvious facts and gradually converge', mbti:{S:1.0} }, b:{ text:'Use analogy and vision to quickly locate the essence', mbti:{N:1.0}, bias:{ element:{木:+0.2,火:+0.2} } } },
            { id:5, d:'TF', when:{ any:[{ tenGodsTopIn:['官杀','印'] }, { dayElementIn:['金','水'] }] }, t:'The first principle in decision-making:', a:{ text:'Consistency and standard priority', mbti:{T:1.2}, bias:{ element:{金:+0.3,水:+0.2} } }, b:{ text:'Relationship and experience priority', mbti:{F:1.2}, bias:{ element:{火:+0.2,木:+0.2} } } },
            { id:6, d:'TF', when:{ any:[{ tenGodsTopIn:['食伤','财'] }, { dayElementIn:['火','木'] }] }, t:'When giving feedback to colleagues, you will:', a:{ text:'First clarify standards and improvement paths', mbti:{T:1.0} }, b:{ text:'First empathize, then give suggestions', mbti:{F:1.0}, bias:{ element:{火:+0.2,木:+0.2} } } },
            { id:7, d:'JP', when:{ any:[{ dayElementIn:['土'] }, { strengthIn:['偏旺'] }] }, t:'When advancing complex tasks, you are more:', a:{ text:'Divide into stages, control rhythm and risk', mbti:{J:1.2}, bias:{ element:{土:+0.3} } }, b:{ text:'Multiple plans in parallel, dynamic trial and error', mbti:{P:1.0}, bias:{ strength:{'偏旺':-0.1,'偏弱':+0.1} } } },
            { id:8, d:'JP', when:{ any:[{ dayElementIn:['木','水'] }, { monthBranchIn:['亥','子','丑'] }] }, t:'When facing uncertain market windows:', a:{ text:'Synchronize plans and rely on further movement', mbti:{J:1.0} }, b:{ text:'First take small steps to test for opportunities', mbti:{P:1.2}, bias:{ element:{木:+0.2,水:+0.2} } } },
            { id:9, d:'TF', cross:['EI'], t:'When conflicts escalate on site, you will:', a:{ text:'Step in to establish rules and boundaries', mbti:{T:1.0,E:0.4}, bias:{ tenGods:{'官杀':+0.2} } }, b:{ text:'Calm things down privately and first stabilize people', mbti:{F:1.0,I:0.4}, bias:{ element:{水:+0.2} } } },
            { id:10, d:'SN', cross:['JP'], t:'When exploring products from 0 to 1:', a:{ text:'Make MVP verification of key facts', mbti:{S:1.0,J:0.4}, bias:{ element:{土:+0.2} } }, b:{ text:'First run vision Demo to collect feedback', mbti:{N:1.0,P:0.4}, bias:{ element:{木:+0.2,火:+0.2} } } },
            { id:11, d:'JP', when:{ any:[{ monthBranchIn:['寅','卯','辰'] }, { dayElementIn:['木'] }] }, t:'When resources are limited in spring:', a:{ text:'Set goals to grab the growth window', mbti:{J:1.0}, bias:{ element:{木:+0.2} } }, b:{ text:'Keep elasticity and signal clarity', mbti:{P:1.0}, bias:{ strength:{'偏弱':+0.1} } } },
            { id:12, d:'TF', when:{ any:[{ monthBranchIn:['巳','午','未'] }, { dayElementIn:['火'] }] }, t:'When under high pressure cycles, you are more:', a:{ text:'Depend on processes and standards to withstand pressure', mbti:{T:1.0}, bias:{ element:{金:+0.2} } }, b:{ text:'Depend on morale and relationships to hold up', mbti:{F:1.0}, bias:{ element:{火:+0.2} } } },
            { id:13, d:'SN', t:'The value you are more willing to take on is:', a:{ text:'Upholding orthodoxy and reviewing (stable/deposit)', mbti:{S:1.0,J:0.2}, bias:{ element:{土:+0.2,金:+0.1} } }, b:{ text:'Breaking the situation and changing (expanding/connecting)', mbti:{N:1.0,P:0.2}, bias:{ element:{木:+0.2,火:+0.1} } } },
            { id:14, d:'EI', t:'In the team, you are more like:', a:{ text:'Engine: pull the rhythm and cooperate', mbti:{E:1.0}, bias:{ element:{火:+0.2} } }, b:{ text:'Stabilizer: ensure quality and risk', mbti:{I:1.0}, bias:{ element:{土:+0.2,金:+0.1} } } },
            { id:15, d:'TF', when:{ any:[{ tenGodsTopIn:['印'] }, { tenGodsTopIn:['财'] }] }, t:'When acquiring knowledge/resources, you are more:', a:{ text:'Anchor the knowledge system (印)', mbti:{T:0.6,N:0.4}, bias:{ tenGods:{'印':+0.3} } }, b:{ text:'Anchor the income and landing (财)', mbti:{S:0.6,J:0.4}, bias:{ tenGods:{'财':+0.3} } } },
            { id:16, d:'JP', when:{ any:[{ tenGodsTopIn:['比劫'] }, { tenGodsTopIn:['官杀'] }] }, t:'When promoting, you are more:', a:{ text:'Pull together with partners to contribute (比劫)', mbti:{E:0.4,P:0.6}, bias:{ tenGods:{'比劫':+0.3} } }, b:{ text:'Set up responsibilities and hold back on promoting (官杀)', mbti:{J:0.8}, bias:{ tenGods:{'官杀':+0.3} } } }
        ];

        function matches(ctx, when){
            if (!when) return true;
            const ok = (cond)=>{
                if (cond.dayElementIn && !cond.dayElementIn.includes(ctx.dayElement)) return false;
                if (cond.strengthIn && !cond.strengthIn.includes(ctx.strength)) return false;
                if (cond.monthBranchIn && !cond.monthBranchIn.includes(ctx.monthBranch)) return false;
                if (cond.tenGodsTopIn && !cond.tenGodsTopIn.includes(ctx.tenGodsTop)) return false;
                return true;
            };
            if (when.any) return when.any.some(ok);
            return ok(when);
        }

        function pickFusionQuestions(all, ctx, max = 12){
            const pool = all.filter(q => matches(ctx, q.when));
            const byD = { EI:[], SN:[], TF:[], JP:[] };
            pool.forEach(q => byD[q.d].push(q));
            const seq = [];
            const order = ['EI','SN','TF','JP'];
            let i = 0;
            while (seq.length < Math.min(max, pool.length) && i < 1000){
                const d = order[seq.length % 4];
                const arr = byD[d];
                if (arr && arr.length) seq.push(arr.shift());
                i++;
            }
            return seq;
        }

        function scoreOption(base, opt, ctx){
            const s = { ...base };
            Object.entries(opt.mbti || {}).forEach(([k,v])=>{ s[k] = (s[k]||0) + v; });
            const b = opt.bias || {};
            if (b.element && b.element[ctx.dayElement]) s.BIAS = (s.BIAS||0) + b.element[ctx.dayElement];
            if (b.strength && b.strength[ctx.strength]) s.BIAS = (s.BIAS||0) + b.strength[ctx.strength];
            if (b.tenGods && b.tenGods[ctx.tenGodsTop]) s.BIAS = (s.BIAS||0) + b.tenGods[ctx.tenGodsTop];
            return s;
        }

        function decideType(scores){
            const p = (a,b)=> (scores[a]||0) >= (scores[b]||0) ? a : b;
            return p('E','I') + p('S','N') + p('T','F') + p('J','P');
        }

        let fusionQuestions = [];

        function renderFusionQuiz(ctx){
            const root = document.getElementById('fusionQuiz');
            root.innerHTML = '';
            fusionQuestions = pickFusionQuestions(FUSION_QUESTIONS, ctx, 12);
            fusionQuestions.forEach((q, i)=>{
                const div = document.createElement('div');
                div.className = 'q';
                div.innerHTML = `<div style="font-weight:700">${i+1}. ${q.t}</div>`;
                ['a','b'].forEach((k,j)=>{
                    const optDiv = document.createElement('div');
                    optDiv.className = 'opt';
                    optDiv.innerHTML = `<label><input type="radio" name="fq${q.id}" value="${k}"> ${q[k].text}</label>`;
                    div.appendChild(optDiv);
                });
                root.appendChild(div);
            });
            document.getElementById('fusionTest').classList.remove('hidden');
        }

        function submitFusion(){
            if (!fusionQuestions.length){ showStatus('No fusion questions to submit'); return; }
            const ctx = window._lastFusionCtx;
            let scores = { E:0,I:0,S:0,N:0,T:0,F:0,J:0,P:0 };
            for (const q of fusionQuestions){
                const sel = document.querySelector(`input[name="fq${q.id}"]:checked`);
                if (!sel){ continue; }
                const opt = q[sel.value];
                scores = scoreOption(scores, opt, ctx);
            }
            const type = decideType(scores);
            document.getElementById('fusionResult').textContent = `Fusion type: ${type}`;
            const inlineType = document.getElementById('fusionInlineType');
            const inlineBias = document.getElementById('fusionInlineBias');
            if (inlineType) inlineType.textContent = type;
            if (inlineBias) inlineBias.textContent = `Bazi-based synergy bias(Bazi): ${(scores.BIAS||0).toFixed(2)} · dayElement=${ctx.dayElement} · strength=${ctx.strength} · 十神=${ctx.tenGodsTop}`;

            const detailEl = document.getElementById('fusionDetail');
            if (detailEl){
                detailEl.innerHTML = buildFusionDetail(type, ctx);
            }
        }

        const TYPE_SUMMARY = {
            INTJ: { desc:'Strategic type·Inward and long-term planning, strong system, good at foresight.', careers:['Strategy/Consulting','Data/Algorithm','Product Architecture','Research/Risk Control'], figures:['Musk (Style Comparison)'] },
            INTP: { desc:'Analytical type·Both curiosity and logic, leaning towards research and system construction.', careers:['Scientific Research/Engineering','Backend/System','Knowledge Management'], figures:['Turing (Comparison)'] },
            ENTJ: { desc:'Leadership type·Decisive and organizational power, good at breaking down goals and advancing.', careers:['Management/Operations','BD/Strategy','Large Project Coordination'], figures:['Jobs (Comparison)'] },
            ENTP: { desc:'Innovative type·Ideas and trial and error, leaning towards innovation and cross-border connection.', careers:['Innovation/Entrepreneurship','Growth/Market','New Product Exploration'], figures:['Da Vinci (Comparison)'] },
            INFJ: { desc:'Insightful type·Value and vision, good at human-centered and long-term thinking.', careers:['Brand/Public Relations','Education/Public Welfare','Product Experience'], figures:['Gandhi (Comparison)'] },
            INFP: { desc:'Idealistic type·Expression and empathy, leaning towards content and humanistic value.', careers:['Content/Design','Copywriting/Planning','User Research'], figures:['Murakami (Comparison)'] },
            ENFJ: { desc:'Facilitative type·Communication and influence, good at team stimulation and cultivation.', careers:['Organizational Development','Sales/Training','Community Operations'], figures:['Oprah (Comparison)'] },
            ENFP: { desc:'Inspiring type·Warmth and creativity, leaning towards innovative experience and connection.', careers:['Creative/Brand','Product Exploration','Community/New Media'], figures:['Robin Williams (Comparison)'] },
            ISTJ: { desc:'Executive type·Order and reliability, good at process and standardization.', careers:['Project Management','Quality/Legal Affairs','Accounting/Compliance'], figures:['Buffett (Comparison)'] },
            ISFJ: { desc:'Protective type·Attention and responsibility, good at service and security.', careers:['Operations Support','HR/Administration','Medical/Nursing'], figures:['Diana (Comparison)'] },
            ESTJ: { desc:'Coordinating type·Organization and efficiency, good at execution and implementation.', careers:['Operations/Supply Chain','Team Management','Government/Military Police'], figures:['Liu Bang (Comparison)'] },
            ESFJ: { desc:'Collaborative type·Interpersonal and order, good at coordination and service.', careers:['Customer Success','Event/Public Relations','Education/Social Work'], figures:['Helen Keller (Comparison)'] },
            ISTP: { desc:'Artisan type·Hands-on and optimization, leaning towards engineering and practical operation.', careers:['Engineering/Maintenance','Safety/Emergency','Game/Hardware'], figures:['"Iron Man" Tony Stark (Comparison)'] },
            ISFP: { desc:'Aesthetic type·Experience and expression, leaning towards art and experience.', careers:['UI/UX','Photography/Music','Product Experience'], figures:['Van Gogh (Comparison)'] },
            ESTP: { desc:'Enterprising type·Action and game, leaning towards market and practical combat.', careers:['Sales/Trading','Sports/Events','Crisis Management'], figures:['Kobe (Comparison)'] },
            ESFP: { desc:'Expressive type·Warmth and interactivity, leaning towards performance and delivery experience.', careers:['Actors/Hosts','Live Streaming/E-commerce','Customer Service/Events'], figures:['Lady Gaga (Comparison)'] }
        };

        const ELEMENT_TUNING = {
            木: { tilt:'+ 创变/生长', add:['产品探索','品牌创意','教育/社区'] },
            火: { tilt:'+ 表达/影响', add:['市场/增长','公关/演讲','活动运营'] },
            土: { tilt:'+ 稳定/治理', add:['PMO/流程','财会/法务','合规/政务'] },
            金: { tilt:'+ 标准/决断', add:['风控/审计','交易/谈判','管理/统筹'] },
            水: { tilt:'+ 洞察/连接', add:['用户研究','数据/策略','知识管理'] }
        };

        const STRENGTH_TUNING = {
            '偏旺': { tilt:'+ 进攻/输出', add:['前台增长','销售拓展','策略推进'], strategy:'Focus on output and influence, pay attention to convergence and synergy, avoid excessive consumption of team credit' },
            '偏弱': { tilt:'+ 防守/积累', add:['后台支持','研究沉淀','流程治理'], strategy:'First establish roots and capabilities, seek resources and help from influential people, gradually expand the radius of influence' },
            '平':   { tilt:'+ 平衡/调和', add:['跨部门协同','PMO/项目','产品协调'], strategy:'Taking advantage of the trend, balancing progress, maintaining rhythm and healthy boundaries' }
        };

        function buildFusionDetail(type, ctx){
            const base = TYPE_SUMMARY[type] || { desc:'混合型', careers:[], figures:[] };
            const tuneEl = ELEMENT_TUNING[ctx.dayElement] || { tilt:'', add:[] };
            const tuneSt = STRENGTH_TUNING[ctx.strength] || { tilt:'', add:[], strategy:'' };
            const jobs = Array.from(new Set([...(base.careers||[]), ...tuneEl.add, ...tuneSt.add]));
            return `
                <div><strong>${type}</strong> · ${base.desc} ${tuneEl.tilt ? `（日主${ctx.dayElement} ${tuneEl.tilt}` : ''}${tuneSt.tilt ? `，${tuneSt.tilt}` : ''}${tuneEl.tilt || tuneSt.tilt ? '）' : ''}</div>
                <div style=\"margin-top:6px\"><strong>适配职业：</strong>${jobs.join('、') || '依兴趣与能力定向'}</div>
                <div style=\"margin-top:6px\"><strong>发展策略：</strong>${tuneSt.strategy || '根据大势灵活取用，维持节奏与边界'}</div>
                <div style=\"margin-top:6px\"><strong>代表人物风格：</strong>${(base.figures||[]).join('、') || '—'}（类比，非认证）</div>
            `;
        }

        function analyzeDayMasterStrength(dayStem, stems, monthBranch) {
            const dm = { element: STEM_TO_WUXING[dayStem], polarity: STEM_POLARITY[dayStem] };
            let score = 0;
            
            stems.forEach(s => {
                const si = { element: STEM_TO_WUXING[s], polarity: STEM_POLARITY[s] };
                if (!si.element) return;
                if (si.element === dm.element) score += 1;
                else if (SHENG[si.element] === dm.element) score += 0.6;
                else if (SHENG[dm.element] === si.element) score -= 0.4;
                else if (KE[dm.element] === si.element) score -= 0.5;
                else if (KE[si.element] === dm.element) score -= 0.7;
            });

            if (monthBranch) {
                const me = dm.element;
                const be = BRANCH_TO_WUXING[monthBranch];
                if (be) {
                    if (be === me) score += 1.0;
                    else if (SHENG[be] === me) score += 0.5;
                    else if (KE[be] === me) score -= 0.6;
                    else if (SHENG[me] === be) score -= 0.2;
                }
            }

            let verdict = '平';
            if (score >= 2) verdict = '偏旺';
            else if (score <= 0.5) verdict = '偏弱';
            
            return { score: Number(score.toFixed(2)), verdict };
        }

        function analyzeTenGods(dayStem, stems) {
            const labels = ['年干', '月干', '日干', '时干'];
            let result = '';
            
            stems.forEach((s, idx) => {
                if (idx === 2) {
                    result += `${labels[idx]}：${s}（日主）<br>`;
                } else {
                    const god = getTenGod(dayStem, s);
                    result += `${labels[idx]}：${s} → ${god}<br>`;
                }
            });
            
            return result;
        }

        function getTenGod(dayStem, otherStem) {
            const d = { element: STEM_TO_WUXING[dayStem], polarity: STEM_POLARITY[dayStem] };
            const o = { element: STEM_TO_WUXING[otherStem], polarity: STEM_POLARITY[otherStem] };
            
            if (!d.element || !o.element) return '—';
            if (d.element === o.element) return (d.polarity === o.polarity) ? '比肩' : '劫财';
            if (SHENG[o.element] === d.element) return (d.polarity !== o.polarity) ? '正印' : '偏印';
            if (SHENG[d.element] === o.element) return (d.polarity !== o.polarity) ? '食神' : '伤官';
            if (KE[d.element] === o.element) return (d.polarity !== o.polarity) ? '正财' : '偏财';
            if (KE[o.element] === d.element) return (d.polarity !== o.polarity) ? '正官' : '七杀';
            return '—';
        }

        function analyzeRegulation(dayElement, monthBranch, wuxing) {
            const monthElement = BRANCH_TO_WUXING[monthBranch];
            if (!monthElement || !dayElement) return '无法分析';
            
            if (monthElement === dayElement) {
                return '月令当令，日主得令，气势较强';
            } else if (SHENG[monthElement] === dayElement) {
                return '月令生身，日主得生，根基稳固';
            } else if (KE[monthElement] === dayElement) {
                return '月令克身，日主受克，需要调候';
            } else if (SHENG[dayElement] === monthElement) {
                return '日主生月令，泄气较多，需要补益';
            } else {
                return '月令与日主关系中性，整体平衡';
            }
        }

        function analyzePattern(dayStem, stems, wuxing) {
            const dayElement = STEM_TO_WUXING[dayStem];
            const fireCount = wuxing['火'] || 0;
            const waterCount = wuxing['水'] || 0;
            const earthCount = wuxing['土'] || 0;
            const woodCount = wuxing['木'] || 0;
            const metalCount = wuxing['金'] || 0;

            if (fireCount > 3) return '火旺格：热情主动，富有创造力，但需注意情绪控制';
            if (waterCount > 3) return '水旺格：智慧深沉，善于思考，但需注意行动力';
            if (earthCount > 3) return '土旺格：稳重务实，重视秩序，但需注意灵活性';
            if (woodCount > 3) return '木旺格：生机勃勃，富有理想，但需注意稳定性';
            if (metalCount > 3) return '金旺格：刚毅果断，重视原则，但需注意包容性';
            
            return '中和格：五行相对均衡，性格特征不明显，适应性较强';
        }

        function analyzeIntegration(bazi, wuxing) {
            const dayStem = bazi.stems[2];
            const dayElement = STEM_TO_WUXING[dayStem];
            const strength = analyzeDayMasterStrength(dayStem, bazi.stems, bazi.branches[1]);

            // 性格根基
            const foundation = getPersonalityFoundation(dayElement, strength.verdict);
            document.getElementById('personalityFoundation').innerHTML = foundation;

            // 发展路径
            const path = getDevelopmentPath(dayElement, strength.verdict, wuxing);
            document.getElementById('developmentPath').innerHTML = path;

            // 潜在挑战
            const challenges = getPotentialChallenges(dayElement, strength.verdict, wuxing);
            document.getElementById('potentialChallenges').innerHTML = challenges;

            // 人生建议
            const advice = getLifeAdvice(dayElement, strength.verdict, wuxing);
            document.getElementById('lifeAdvice').innerHTML = advice;
        }

        function getPersonalityFoundation(dayElement, strength) {
            const foundations = {
                '木': '木性主仁，具有生长、向上、进取的特质',
                '火': '火性主礼，具有光明、温暖、热情的特质',
                '土': '土性主信，具有包容、稳定、务实的特质',
                '金': '金性主义，具有刚毅、果断、原则的特质',
                '水': '水性主智，具有智慧、灵活、包容的特质'
            };
            
            const base = foundations[dayElement] || '五行特征不明显';
            return `${base}。日主${strength}，${strength === '偏旺' ? '性格特征突出，优势明显' : strength === '偏弱' ? '性格温和，需要培养' : '性格平衡，适应性较强'}。`;
        }

        function getDevelopmentPath(dayElement, strength, wuxing) {
            if (strength === '偏旺') {
                return '发挥优势：利用日主旺相的优势，在擅长的领域深耕发展。注意适度收敛，避免过于强势。';
            } else if (strength === '偏弱') {
                return '补益发展：通过学习和实践增强日主力量，培养核心能力。寻找贵人相助，建立支持系统。';
            } else {
                return '平衡发展：保持五行平衡，全面发展各项能力。根据大运流年调整发展重点。';
            }
        }

        function getPotentialChallenges(dayElement, strength, wuxing) {
            const challenges = {
                '木': '木旺易折，需注意情绪控制和人际关系处理',
                '火': '火旺易燥，需注意耐心和细节管理',
                '土': '土旺易滞，需注意创新思维和灵活性',
                '金': '金旺易刚，需注意包容性和人际关系',
                '水': '水旺易流，需注意稳定性和执行力'
            };
            
            const base = challenges[dayElement] || '无明显挑战';
            return `${base}。${strength === '偏旺' ? '日主过旺时，这些挑战会更加明显' : strength === '偏弱' ? '日主偏弱时，需要克服这些挑战来增强自身' : '日主平衡时，这些挑战相对温和'}。`;
        }

        function getLifeAdvice(dayElement, strength, wuxing) {
            const advice = {
                '木': '培养耐心，学会倾听，在团队中发挥领导作用',
                '火': '保持热情，注意细节，在创新中展现才华',
                '土': '保持稳定，培养创新，在务实中追求卓越',
                '金': '坚持原则，学会包容，在刚毅中展现智慧',
                '水': '保持智慧，增强行动，在灵活中追求稳定'
            };
            
            const base = advice[dayElement] || '保持平衡发展';
            return `${base}。${strength === '偏旺' ? '发挥优势的同时，注意自我调节和他人感受' : strength === '偏弱' ? '在补益自身的同时，寻找适合自己的发展道路' : '在平衡发展中，寻找突破和创新的机会'}。`;
        }

        // Share/Return canceled: If you need to restore, you can re-enable the function here

        // Date input formatting for MM/DD/YYYY format
        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2);
            }
            if (value.length >= 5) {
                value = value.slice(0, 5) + '/' + value.slice(5, 9);
            }
            input.value = value;
        }

        // Convert various date inputs to YYYY-MM-DD for internal processing
        function convertToISOFormat(dateString) {
            if (!dateString) return '';
            let s = String(dateString).trim();
            // Chinese numerals utils (1-31)
            const CN_DIGIT = { '零':0,'〇':0,'一':1,'二':2,'两':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9,'正':1 };
            function cnNumToInt(token){
                if (!token) return NaN;
                if (token.startsWith('初')) {
                    const d = CN_DIGIT[token.slice(1)] || (token === '初十' ? 10 : undefined);
                    return typeof d === 'number' ? d : NaN;
                }
                if (token.startsWith('廿')) {
                    const tail = token.slice(1);
                    const val = CN_DIGIT[tail] || 0;
                    return 20 + val;
                }
                if (token.startsWith('卅')) {
                    const tail = token.slice(1);
                    const val = CN_DIGIT[tail] || 0;
                    return 30 + val;
                }
                if (token === '十') return 10;
                const tenIdx = token.indexOf('十');
                if (tenIdx >= 0) {
                    const left = token.slice(0, tenIdx);
                    const right = token.slice(tenIdx + 1);
                    const tens = left ? (CN_DIGIT[left] || 0) : 1;
                    const ones = right ? (CN_DIGIT[right] || 0) : 0;
                    return tens * 10 + ones;
                }
                if (token.length === 1 && token in CN_DIGIT) return CN_DIGIT[token];
                return NaN;
            }
            // Normalize commas and ordinal suffixes (1st, 2nd, 3rd, 4th)
            s = s.replace(/,/g, ' ').replace(/\b(\d{1,2})(st|nd|rd|th)\b/gi, '$1');
            // Replace English month names with numeric
            const MONTHS_EN = {
                january:'01', jan:'01',
                february:'02', feb:'02',
                march:'03', mar:'03',
                april:'04', apr:'04',
                may:'05',
                june:'06', jun:'06',
                july:'07', jul:'07',
                august:'08', aug:'08',
                september:'09', sept:'09', sep:'09',
                october:'10', oct:'10',
                november:'11', nov:'11',
                december:'12', dec:'12'
            };
            Object.keys(MONTHS_EN).forEach(k => {
                const re = new RegExp(`\\b${k}\\.?\\b`, 'gi');
                s = s.replace(re, MONTHS_EN[k]);
            });
            // Replace Chinese month words 一月..十二月
            const MONTHS_ZH = { '一月':'01','二月':'02','三月':'03','四月':'04','五月':'05','六月':'06','七月':'07','八月':'08','九月':'09','十月':'10','十一月':'11','十二月':'12' };
            Object.keys(MONTHS_ZH).forEach(k => { s = s.replace(new RegExp(k, 'g'), MONTHS_ZH[k]); });
            // YYYY-MM-DD or YYYY/MM/DD
            if (/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/.test(s)) {
                const [y, m, d] = s.replaceAll('/', '-').split('-');
                return `${y.padStart(4, '0')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            }
            // MM/DD/YYYY (or M/D/YYYY)
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
                const [mm, dd, yy] = s.split('/');
                return `${yy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`;
            }
            // YYYYMMDD
            if (/^\d{8}$/.test(s)) {
                const y = s.slice(0, 4);
                const m = s.slice(4, 6);
                const d = s.slice(6, 8);
                return `${y}-${m}-${d}`;
            }
            // Chinese numerals pattern: 2020年十月初三 / 2020年一月三十日
            const zhMatch = s.match(/(\d{4})年([正一二三四五六七八九十]{1,3})月([初廿卅一二三四五六七八九十]{1,3})日?/);
            if (zhMatch) {
                const y = zhMatch[1];
                const mVal = cnNumToInt(zhMatch[2]);
                const dVal = cnNumToInt(zhMatch[3]);
                if (!isNaN(mVal) && !isNaN(dVal)) {
                    return `${y}-${String(mVal).padStart(2,'0')}-${String(dVal).padStart(2,'0')}`;
                }
            }
            // Normalize common separators: dots, Chinese 年月日, spaces, fullwidth
            const normalized = s
                .replace(/年/g, '-')
                .replace(/月/g, '-')
                .replace(/日/g, '')
                .replace(/[．。··]/g, '-')
                .replace(/[，、]/g, '-')
                .replace(/[\s]+/g, '-')
                .replace(/—/g, '-')
                .replace(/、/g, '-')
                .replace(/\\/g, '-')
                .replace(/\uFF0F/g, '/')
                .replace(/-{2,}/g, '-');
            // Try to extract numeric groups and infer order
            const nums = normalized.match(/\d{1,4}/g) || [];
            if (nums.length >= 3) {
                let y = '', m = '', d = '';
                if (nums[0].length === 4) {
                    // YYYY M D
                    [y, m, d] = [nums[0], nums[1], nums[2]];
                } else if (nums[2] && nums[2].length === 4) {
                    // M D YYYY
                    [y, m, d] = [nums[2], nums[0], nums[1]];
                } else if (parseInt(nums[0],10) > 1900 && parseInt(nums[0],10) <= 2100) {
                    [y, m, d] = [nums[0], nums[1], nums[2]];
                } else {
                    return s;
                }
                return `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            }
            return s;
        }

        // Detect if input likely refers to lunar date keywords
        function hasLunarKeywords(input){
            if (!input) return false;
            return /(农历|陰曆|阴历|闰|閏)/.test(String(input));
        }

        // Try convert Chinese lunar textual input to ISO (YYYY-MM-DD)
        async function tryConvertLunarToSolarISO(input){
            const s = String(input).trim();
            // Match variants like: 农历2020年闰四月初一 / 阴历2020年四月初一 / 2020年闰四月初一
            // Capture: year, leap flag, month (Chinese numeric or Arabic), day (Chinese numeric tokens)
            const zh = s.match(/(\d{4})年\s*(闰|閏)?\s*([正一二三四五六七八九十\d]{1,3})月\s*([初廿卅一二三四五六七八九十\d]{1,3})日?/);
            if (!zh) return '';
            const year = parseInt(zh[1], 10);
            const isLeap = !!zh[2];
            const mToken = zh[3];
            const dToken = zh[4];
            const month = /^\d+$/.test(mToken) ? parseInt(mToken,10) : cnNumToInt(mToken);
            const day = /^\d+$/.test(dToken) ? parseInt(dToken,10) : cnNumToInt(dToken);
            if (!month || !day) return '';

            // Ensure lunar library is available
            try {
                if (!(window.Lunar && (window.Lunar.fromYmd || (window.Lunar.Lunar && window.Lunar.Lunar.fromYmd)) )){
                    const ok = await loadLunarFromFallbacks();
                    if (!ok) return '';
                }
                const L = (window.Lunar && window.Lunar.Lunar) ? window.Lunar.Lunar : window.Lunar;
                const lunar = (typeof L.fromYmdHms === 'function') ? L.fromYmdHms(year, month, day, 12, 0, 0, isLeap) : (typeof L.fromYmd === 'function' ? L.fromYmd(year, month, day, isLeap) : null);
                if (!lunar || !lunar.getSolar) return '';
                const solar = lunar.getSolar();
                if (!solar) return '';
                if (typeof solar.toYmd === 'function') {
                    return solar.toYmd();
                }
                const y = solar.getYear ? solar.getYear() : year;
                const m = solar.getMonth ? solar.getMonth() : month;
                const d = solar.getDay ? solar.getDay() : day;
                return `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            } catch (e) {
                console.warn('Lunar->Solar conversion failed:', e);
                return '';
            }
        }

        // Validate and normalize possibly lunar input into ISO (async)
        async function validateAndNormalizeDateAsync(input){
            if (!input) return '';
            // If lunar keywords detected, try conversion first
            if (hasLunarKeywords(input)){
                const isoFromLunar = await tryConvertLunarToSolarISO(input);
                if (isoFromLunar && /^\d{4}-\d{2}-\d{2}$/.test(isoFromLunar)) return isoFromLunar;
            }
            const iso = convertToISOFormat(input);
            if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
            const ok = validateDateFormat(iso);
            return ok ? iso : '';
        }

        // Validate supported date formats and actual calendar date
        function validateDateFormat(dateString) {
            if (!dateString) return false;
            const iso = convertToISOFormat(dateString);
            if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) return false;
            const [yStr, mStr, dStr] = iso.split('-');
            const y = parseInt(yStr, 10);
            const m = parseInt(mStr, 10);
            const d = parseInt(dStr, 10);
            if (y < 1900 || y > 2100) return false;
            if (m < 1 || m > 12) return false;
            if (d < 1 || d > 31) return false;
            const dt = new Date(`${yStr}-${mStr}-${dStr}T00:00:00Z`);
            const valid = dt.getUTCFullYear() === y && (dt.getUTCMonth() + 1) === m && dt.getUTCDate() === d;
            return valid;
        }

        // (Deleted) Metaphysics knowledge questions and related logic, unified use of fusion test

        // Initialization after page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, starting initialization...');
            
            // Add date input event listeners and validation across formats
            const dateInputs = ['bDate', 'nDate', 'fDate'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        // Keep permissive typing; only auto-format if typing slashes
                        if (this.value.includes('/')) {
                            formatDateInput(this);
                        }
                    });
                    input.addEventListener('blur', async function() {
                        if (!this.value) return;
                        const before = this.value;
                        const iso = await validateAndNormalizeDateAsync(before);
                        if (!iso) {
                            showToast('Invalid date. 支持：YYYY-MM-DD, YYYY/MM/DD, MM/DD/YYYY, YYYYMMDD, YYYY.M.D, YYYY年M月D日, 农历/阴历(含闰月)', 'error');
                            this.focus();
                            return;
                        }
                        const wasLunar = hasLunarKeywords(before);
                        this.dataset.iso = iso;
                        if (wasLunar) {
                            showToast(`已转换为阳历：${iso}`, 'success');
                        }
                    });
                }
            });
            
            // Check tab elements
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('Number of tabs:', tabs.length);
            console.log('Number of tab contents:', tabContents.length);
            
            // Check numerology-related elements
            const numerologyContent = document.getElementById('numerology-content');
            const numerologyBtn = document.querySelector('button[onclick="analyzeNumerology()"]');
            
            console.log('Numerology content element:', numerologyContent);
            console.log('Numerology button:', numerologyBtn);
            
            // Check if functions are available
            console.log('analyzeNumerology function:', typeof analyzeNumerology);
            console.log('switchTab function:', typeof switchTab);
            
            console.log('Initialization completed!');
        });

        // Populate and sync dropdown date selectors with #bDate
        (function initBirthDateDropdowns(){
            function isLeapYear(y){ return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0); }
            function daysInMonth(y,m){ return [31, (isLeapYear(y)?29:28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][m-1]; }
            function pad(n){ return String(n).padStart(2,'0'); }

            const ySel = document.getElementById('bYear');
            const mSel = document.getElementById('bMonth');
            const dSel = document.getElementById('bDay');
            const input = document.getElementById('bDate');
            if (!ySel || !mSel || !dSel || !input) return;

            const now = new Date();
            const thisYear = now.getFullYear();
            const minYear = 1900;
            const maxYear = thisYear + 1;

            // year options
            ySel.innerHTML = '<option value="">Year</option>';
            for (let y = maxYear; y >= minYear; y--) {
                const opt = document.createElement('option');
                opt.value = String(y);
                opt.textContent = String(y);
                ySel.appendChild(opt);
            }
            // month options
            mSel.innerHTML = '<option value="">Month</option>';
            for (let m = 1; m <= 12; m++) {
                const opt = document.createElement('option');
                opt.value = String(m);
                opt.textContent = pad(m);
                mSel.appendChild(opt);
            }
            // day options (dynamic)
            function fillDays(y, m){
                dSel.innerHTML = '<option value="">Day</option>';
                if (!y || !m) return;
                const num = daysInMonth(Number(y), Number(m));
                for (let d = 1; d <= num; d++){
                    const opt = document.createElement('option');
                    opt.value = String(d);
                    opt.textContent = pad(d);
                    dSel.appendChild(opt);
                }
            }

            function updateInputFromSelects(){
                const y = ySel.value;
                const m = mSel.value;
                const d = dSel.value;
                if (y && m && d){
                    const iso = `${y}-${pad(m)}-${pad(d)}`;
                    input.value = iso; // visible for clarity
                    input.dataset.iso = iso; // keep existing flow working
                }
            }

            ySel.addEventListener('change', ()=>{ fillDays(ySel.value, mSel.value); updateInputFromSelects(); });
            mSel.addEventListener('change', ()=>{ fillDays(ySel.value, mSel.value); updateInputFromSelects(); });
            dSel.addEventListener('change', updateInputFromSelects);

            // If input already has a valid ISO (e.g., via sample), preselect
            const pre = input.dataset.iso || input.value;
            if (pre && /^\d{4}-\d{2}-\d{2}$/.test(pre)){
                const [yy, mm, dd] = pre.split('-');
                ySel.value = yy;
                mSel.value = String(Number(mm));
                fillDays(yy, Number(mm));
                dSel.value = String(Number(dd));
            }
        })();

        // Handle click on feature cards
        function showFeatureInfo(featureType) {
            console.log('Click on feature card:', featureType);
            
            if (featureType === 'numerology') {
                // Switch to numerology tab
                switchTab('numerology');
                
                // Update status display
                const statusElement = document.querySelector('.feature-status.coming-soon');
                if (statusElement) {
                    statusElement.textContent = '功能已就绪';
                    statusElement.classList.remove('coming-soon');
                    statusElement.classList.add('ready');
                }
                
                console.log('Numerology function activated!');
            }
        }

        // Directly test numerology function
        function testNumerologyDirectly() {
            console.log('🧪 Directly test numerology function');
            
            // Directly switch to numerology tab
            switchTab('numerology');
            
            // Simulate input data
            const testDate = '01/01/1990';
            const testName = 'Zhang San';
            
            // Set test data
            if (document.getElementById('nDate')) {
                document.getElementById('nDate').value = testDate;
            }
            if (document.getElementById('nName')) {
                document.getElementById('nName').value = testName;
            }
            
            console.log('Test data set:', { testDate, testName });
            console.log('Please check if the numerology tab displays content');
        }

        // Debug tab switching
        function debugTabSwitching() {
            console.log('🐛 Starting debug tab switching');
            
            // Check all tab elements
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('Number of tabs:', tabs.length);
            console.log('Number of tab contents:', tabContents.length);
            
            // Check each tab
            tabs.forEach((tab, index) => {
                console.log(`Tab ${index}:`, tab.textContent, 'active:', tab.classList.contains('active'));
            });
            
            // Check each tab content
            tabContents.forEach((content, index) => {
                console.log(`Tab content ${index}:`, content.id, 'active:', content.classList.contains('active'), 'display:', window.getComputedStyle(content).display);
            });
            
            // Try manual switching
            console.log('Trying to manually switch to numerology tab...');
            switchTab('numerology');
            
            // Check the status after switching
            setTimeout(() => {
                const numerologyContent = document.getElementById('numerology-content');
                if (numerologyContent) {
                    console.log('Status of numerology content element:', {
                        id: numerologyContent.id,
                        classes: numerologyContent.className,
                        display: window.getComputedStyle(numerologyContent).display,
                        visible: numerologyContent.offsetParent !== null
                    });
                } else {
                    console.error('Numerology content element not found!');
                }
            }, 100);
        }

        // Force show numerology content
        function forceShowNumerology() {
            console.log('🔍 Force show numerology content');
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show numerology content
            const numerologyContent = document.getElementById('numerology-content');
            if (numerologyContent) {
                numerologyContent.style.display = 'block';
                numerologyContent.classList.add('active');
                console.log('✅ Numerology content has been forced to show');
                
                // Update tab status
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const numerologyTab = document.querySelector('.tab[onclick*="numerology"]');
                if (numerologyTab) {
                    numerologyTab.classList.add('active');
                }
            } else {
                console.error('❌ Numerology content element not found');
            }
        }

        // Analyze personality characteristics (Bazi + MBTI fusion analysis)
        async function analyzePersonality() {
            console.log('🧠 Starting personality analysis...');
            
            // Check if lunar library is loaded
            if (!window.Solar && !(window.Lunar && window.Lunar.Solar)) {
                console.log('lunar library not loaded, trying to load...');
                try {
                    const loaded = await loadLunarFromFallbacks();
                    if (!loaded) {
                        alert('Metaphysics library loading failed, please refresh the page and try again');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to load lunar library:', error);
                    alert('Metaphysics library loading failed, please refresh the page and try again');
                    return;
                }
            }
            
            // Get input data
            const birthDate = document.getElementById('bDate').value;
            const birthTime = document.getElementById('bTime').value;
            
            if (!birthDate || !birthTime) {
                alert('Please fill in complete birth information (date and time)');
                return;
            }
            
            // Validate date format
            if (!validateDateFormat(birthDate)) {
                alert('Please enter a valid date in MM/DD/YYYY format (e.g., 12/25/1990)');
                return;
            }
            
            try {
                console.log('Parsing birth time:', { birthDate, birthTime });
                
                // Convert MM/DD/YYYY to YYYY-MM-DD for internal processing
                const isoDate = convertToISOFormat(birthDate);
                console.log('Converted to ISO format:', isoDate);
                
                // Parse birth time
                const [year, month, day] = isoDate.split('-').map(Number);
                const [hour, minute] = birthTime.split(':').map(Number);
                
                console.log('Parsed time:', { year, month, day, hour, minute });
                
                // Calculate Bazi
                const pillars = safeGetPillars(year, month, day, hour, minute);
                console.log('Calculated Bazi:', pillars);
                
                if (pillars && pillars.pillarText) {
                    const pillarText = pillars.pillarText;
                    document.getElementById('pillars').textContent = pillarText;
                    document.getElementById('stemsBranches').textContent = `Year Pillar: ${pillarText.split('｜')[0]} | Month Pillar: ${pillarText.split('｜')[1]} | Day Pillar: ${pillarText.split('｜')[2]} | Hour Pillar: ${pillarText.split('｜')[3]}`;
                    
                    // Analyze five elements
                    analyzeWuxing(pillarText);
                    
                    // Display analysis result area
                    document.getElementById('mbtiAnalysis').classList.remove('hidden');
                    document.getElementById('baziAnalysis').classList.remove('hidden');
                    document.getElementById('integrationAnalysis').classList.remove('hidden');
                    
                    // Perform MBTI analysis
                    performMBTIAnalysis(pillarText);
                    
                    // Perform Bazi analysis
                    performBaziAnalysis(pillarText);
                    
                    // Perform fusion analysis
                    performIntegrationAnalysis(pillarText);
                    
                    console.log('✅ Personality analysis completed');
                    alert('✅ Analysis completed successfully! Check the results below.');
                } else {
                    throw new Error('Bazi calculation failed');
                }
                
            } catch (error) {
                console.error('Personality analysis failed:', error);
                alert('Analysis failed, please check if the input information is correct');
            }
        }
        // Ensure global exposure for inline onclick
        window.analyzePersonality = analyzePersonality;
        
        // Analyze five elements
        function analyzeWuxing(pillars) {
            const wuxingCount = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
            const elements = pillars.split('｜').join('').split('');
            
            elements.forEach(char => {
                if (STEM_TO_WUXING[char]) {
                    wuxingCount[STEM_TO_WUXING[char]]++;
                }
                                 if (BRANCH_TO_WUXING[char]) {
                     wuxingCount[BRANCH_TO_WUXING[char]]++;
                 }
             });
             
             const wuxingDiv = document.getElementById('wuxing');
             wuxingDiv.innerHTML = '';
             
             Object.entries(wuxingCount).forEach(([element, count]) => {
                 const elementDiv = document.createElement('div');
                 elementDiv.className = 'pill';
                 elementDiv.style.background = getElementColor(element);
                 elementDiv.textContent = `${WUXING_EN[element] || element}: ${count}`;
                 wuxingDiv.appendChild(elementDiv);
             });
         }
         
         // Get five elements colors
         function getElementColor(element) {
             const colors = {
                 '木': '#4ade80',
                 '火': '#f87171',
                 '土': '#fbbf24',
                 '金': '#fbbf24',
                 '水': '#60a5fa'
             };
             return colors[element] || '#6b7280';
         }
         
         // Perform MBTI analysis
         function performMBTIAnalysis(pillars) {
             // Infer MBTI tendencies based on Bazi characteristics
             const analysis = {
                 'EI': 'Analyze extroversion/introversion tendencies based on day master strength and five elements configuration',
                 'SN': 'Analyze abstract/concrete characteristics based on heavenly stems and earthly branches',
                 'TF': 'Analyze rational/emotional tendencies based on five elements generation and suppression relationships',
                 'JP': 'Analyze judging/perceiving preferences based on hour stem and pattern characteristics'
             };
             
             document.getElementById('eiAnalysis').textContent = analysis.EI;
             document.getElementById('snAnalysis').textContent = analysis.SN;
             document.getElementById('tfAnalysis').textContent = analysis.TF;
             document.getElementById('jpAnalysis').textContent = analysis.JP;
         }
         
         // Perform Bazi analysis
         function performBaziAnalysis(pillars) {
             const analysis = {
                 'dayMasterStrength': 'Day master is ' + pillars.split('｜')[2].charAt(0) + ', five elements attribute is ' + STEM_TO_WUXING[pillars.split('｜')[2].charAt(0)],
                 'tenGods': 'Analyze ten gods configuration and interpersonal relationships based on day master',
                 'regulation': 'Five elements regulation advice: ' + getRegulationAdvice(pillars),
                 'pattern': 'Pattern characteristics: ' + getPatternAnalysis(pillars)
             };
             
             document.getElementById('dayMasterStrength').textContent = analysis.dayMasterStrength;
             document.getElementById('tenGods').textContent = analysis.tenGods;
             document.getElementById('regulation').textContent = analysis.regulation;
             document.getElementById('pattern').textContent = analysis.pattern;
         }
         
         // Perform integration analysis
         function performIntegrationAnalysis(pillars) {
             // Generate fusion MBTI type
             const fusionType = generateFusionMBTI(pillars);
             document.getElementById('fusionInlineType').textContent = fusionType;
             document.getElementById('fusionInlineBias').textContent = 'MBTI inference based on Bazi characteristics';
             
             // Fusion analysis results
             const integration = {
                 'personalityFoundation': 'Bazi foundation: ' + getFoundationAnalysis(pillars),
                 'developmentPath': 'Development path: ' + getDevelopmentPath(pillars),
                 'potentialChallenges': 'Potential challenges: ' + getChallengesAnalysis(pillars),
                 'lifeAdvice': 'Life advice: ' + getLifeAdvice(pillars)
             };
             
             document.getElementById('personalityFoundation').textContent = integration.personalityFoundation;
             document.getElementById('fusionInlineBias').textContent = integration.personalityFoundation;
             document.getElementById('developmentPath').textContent = integration.developmentPath;
             document.getElementById('potentialChallenges').textContent = integration.potentialChallenges;
             document.getElementById('lifeAdvice').textContent = integration.lifeAdvice;
             
             // Detailed explanation
             document.getElementById('fusionDetail').textContent = getFusionDetail(fusionType, pillars);
         }
         
         // Generate fusion MBTI type
         function generateFusionMBTI(pillars) {
             // Generate MBTI type based on Bazi characteristics
             const elements = pillars.split('｜').join('').split('');
             let ei = 'I', sn = 'N', tf = 'F', jp = 'P';
             
             // Simple inference logic (can be optimized as needed)
             const dayStem = pillars.split('｜')[2].charAt(0);
             const dayElement = STEM_TO_WUXING[dayStem];
             
             if (dayElement === '火' || dayElement === '木') {
                 ei = 'E'; // Fire and wood are extroverted
             }
             if (dayElement === '金' || dayElement === '水') {
                 sn = 'S'; // Metal and water are concrete
             }
             if (dayElement === '土') {
                 tf = 'T'; // Earth is rational
             }
             
             return ei + sn + tf + jp;
         }
         
         // Get regulation advice
         function getRegulationAdvice(pillars) {
             const dayElement = STEM_TO_WUXING[pillars.split('｜')[2].charAt(0)];
             const advice = {
                 '木': 'Suitable for fire and earth, avoid metal and water',
                 '火': 'Suitable for earth and metal, avoid water and wood',
                 '土': 'Suitable for metal and water, avoid wood and fire',
                 '金': 'Suitable for water and wood, avoid fire and earth',
                 '水': 'Suitable for wood and fire, avoid earth and metal'
             };
             return advice[dayElement] || 'Further analysis needed';
         }
         
         // Get pattern analysis
         function getPatternAnalysis(pillars) {
             const elements = pillars.split('｜').join('').split('');
             const wuxingCount = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
             
             elements.forEach(char => {
                 if (STEM_TO_WUXING[char]) wuxingCount[STEM_TO_WUXING[char]]++;
                 if (BRANCH_TO_WUXING[char]) wuxingCount[BRANCH_TO_WUXING[char]]++;
             });
             
             const maxElement = Object.entries(wuxingCount).reduce((a, b) => wuxingCount[a[0]] > wuxingCount[b[0]] ? a : b)[0];
             return `${maxElement} prosperous pattern, mainly ${getElementTrait(maxElement)}`;
         }
         
         // Get five elements traits
         function getElementTrait(element) {
             const traits = {
                 '木': 'Benevolence, progress, vitality',
                 '火': 'Courtesy, passion, brightness',
                 '土': 'Trustworthiness, stability, inclusiveness',
                 '金': 'Righteousness, decisiveness, perseverance',
                 '水': 'Wisdom, flexibility, adaptability'
             };
             return traits[element] || 'Unknown traits';
         }
         
         // Get foundation analysis
         function getFoundationAnalysis(pillars) {
             const dayElement = STEM_TO_WUXING[pillars.split('｜')[2].charAt(0)];
             return `Day master ${dayElement}, foundation ${getElementTrait(dayElement)}, personality foundation is stable`;
         }
         
         // Get development path
         function getDevelopmentPath(pillars) {
             const dayElement = STEM_TO_WUXING[pillars.split('｜')[2].charAt(0)];
             const path = {
                 '木': 'Suitable for education, culture, environmental protection and other fields',
                 '火': 'Suitable for media, sales, performing arts and other fields',
                 '土': 'Suitable for management, construction, agriculture and other fields',
                 '金': 'Suitable for finance, law, technology and other fields',
                 '水': 'Suitable for scientific research, consulting, transportation and other fields'
             };
             return path[dayElement] || 'Need to analyze in combination with other factors';
         }
         
         // Get challenges analysis
         function getChallengesAnalysis(pillars) {
             const dayElement = STEM_TO_WUXING[pillars.split('｜')[2].charAt(0)];
             const challenges = {
                 '木': 'Need to pay attention to emotional management, avoid being too idealistic',
                 '火': 'Need to control impulsiveness, cultivate patience and focus',
                 '土': 'Need to avoid being too conservative, cultivate innovative thinking',
                 '金': 'Need to pay attention to interpersonal relationships, avoid being too rigid',
                 '水': 'Need to avoid being too flexible, cultivate persistence'
             };
             return challenges[dayElement] || 'Further analysis needed';
         }
         
         // Get life advice
         function getLifeAdvice(pillars) {
             const dayElement = STEM_TO_WUXING[pillars.split('｜')[2].charAt(0)];
             const advice = {
                 '木': 'Cultivate leadership, utilize creativity, pay attention to teamwork',
                 '火': 'Maintain passion, cultivate focus, pay attention to time management',
                 '土': 'Utilize stability, cultivate inclusiveness, pay attention to innovative thinking',
                 '金': 'Maintain principles, cultivate flexibility, pay attention to interpersonal relationships',
                 '水': 'Utilize wisdom, cultivate persistence, pay attention to clear goals'
             };
             return advice[dayElement] || 'Suggest combining with personal actual situation';
         }
         
         // Get fusion details
         function getFusionDetail(fusionType, pillars) {
             return `Based on your Bazi characteristics, the inferred MBTI type is ${fusionType}. This type combines the wisdom of traditional metaphysics with the insights of modern psychology to provide you with a more comprehensive personality analysis. We recommend using this result as a reference and combining it with your actual situation for self-awareness and development planning.`;
         }
         
         // Test analyzePersonality function
         function testAnalyzePersonality() {
             console.log('🧪 Test analyzePersonality function');
             
             // Check if function exists
             if (typeof analyzePersonality === 'function') {
                 console.log('✅ analyzePersonality function exists');
             } else {
                 console.error('❌ analyzePersonality function does not exist');
                 return;
             }
             
             // Check input elements
             const bDate = document.getElementById('bDate');
             const bTime = document.getElementById('bTime');
             
             if (bDate) {
                 console.log('✅ Birth date input box exists:', bDate.value);
             } else {
                 console.error('❌ Birth date input box does not exist');
             }
             
             if (bTime) {
                 console.log('✅ Birth time input box exists:', bTime.value);
             } else {
                 console.error('❌ Birth time input box does not exist');
             }
             
             // Check lunar library
             if (window.Solar || (window.Lunar && window.Lunar.Solar)) {
                 console.log('✅ Lunar library loaded');
             } else {
                 console.log('⚠️ Lunar library not loaded');
             }
             
             // Check other related functions
             const functions = ['safeGetPillars', 'analyzeWuxing', 'performMBTIAnalysis', 'performBaziAnalysis', 'performIntegrationAnalysis'];
             functions.forEach(funcName => {
                 if (typeof window[funcName] === 'function') {
                     console.log(`✅ ${funcName} function exists`);
                 } else {
                     console.error(`❌ ${funcName} function does not exist`);
                 }
             });
             
             // Check result elements
             const resultElements = ['pillars', 'stemsBranches', 'wuxing', 'mbtiAnalysis', 'baziAnalysis', 'integrationAnalysis'];
             resultElements.forEach(elementId => {
                 const element = document.getElementById(elementId);
                 if (element) {
                     console.log(`✅ ${elementId} element exists`);
                 } else {
                     console.error(`❌ ${elementId} element does not exist`);
                 }
             });
         }
         
                 // Test numerology functions
        function testNumerologyFunctions() {
            console.log('🧪 Test numerology functions');
            
            // Test if basic functions exist
            const functions = [
                'analyzePersonality',
                'analyzeNumerology',
                'calculateLifeNumber', 
                'calculateDestinyNumber',
                'calculateSoulNumber',
                'analyzeNumberTraits'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.log(`✅ ${funcName} function exists`);
                } else {
                    console.error(`❌ ${funcName} function does not exist`);
                }
            });
            
            // Test data objects
            if (typeof NUMBER_MEANINGS !== 'undefined') {
                console.log('✅ NUMBER_MEANINGS object exists, containing', Object.keys(NUMBER_MEANINGS).length, 'numbers');
            } else {
                console.error('❌ NUMBER_MEANINGS object does not exist');
            }
            
            if (typeof CHINESE_NAME_NUMBERS !== 'undefined') {
                console.log('✅ CHINESE_NAME_NUMBERS object exists, containing', Object.keys(CHINESE_NAME_NUMBERS).length, 'characters');
            } else {
                console.error('❌ CHINESE_NAME_NUMBERS object does not exist');
            }
            
            // Test input elements
            const nDate = document.getElementById('nDate');
            const nName = document.getElementById('nDate');
            
            if (nDate) {
                console.log('✅ Birth date input box exists');
            } else {
                console.error('❌ Birth date input box does not exist');
            }
            
            if (nName) {
                console.log('✅ Name input box exists');
            } else {
                console.error('❌ Name input box does not exist');
            }
        }

        // Test analyzePersonality function specifically
        function testAnalyzePersonality() {
            console.log('🧪 Testing analyzePersonality function...');
            
            // Check if function exists
            if (typeof analyzePersonality === 'function') {
                console.log('✅ analyzePersonality function exists');
            } else {
                console.error('❌ analyzePersonality function does not exist');
                return;
            }
            
            // Check input elements
            const bDate = document.getElementById('bDate');
            const bTime = document.getElementById('bTime');
            
            if (bDate) {
                console.log('✅ Birth date input exists:', bDate.value);
            } else {
                console.error('❌ Birth date input not found');
            }
            
            if (bTime) {
                console.log('✅ Birth time input exists:', bTime.value);
            } else {
                console.error('❌ Birth time input not found');
            }
            
            // Check result elements
            const resultElements = ['pillars', 'stemsBranches', 'wuxing', 'mbtiAnalysis', 'baziAnalysis', 'integrationAnalysis'];
            resultElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`✅ ${elementId} element exists`);
                } else {
                    console.error(`❌ ${elementId} element not found`);
                }
            });
            
            // Check lunar library
            if (window.Solar || (window.Lunar && window.Lunar.Solar)) {
                console.log('✅ Lunar library loaded');
            } else {
                console.log('⚠️ Lunar library not loaded');
            }
            
            console.log('🧪 Test completed. Check console for results.');
        }

        // Sample setters for quick testing
        function setSampleDate(type){
            const el = document.getElementById('bDate');
            if (!el) return;
            if (type === 'gregorian') {
                el.value = '2020-01-01';
            } else if (type === 'lunar') {
                el.value = '农历2020年十月初三';
            } else if (type === 'leap') {
                el.value = '农历2020年闰四月初一';
            }
            el.dispatchEvent(new Event('blur'));
        }
    </script>
</body>
</html>