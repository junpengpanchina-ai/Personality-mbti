<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广告测试 - 无拦截器版本</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .ad-container { margin: 20px 0; padding: 20px; border: 2px dashed #ccc; text-align: center; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 广告测试页面</h1>
        <p>这个页面用于测试广告功能，绕过广告拦截器。</p>
        
        <div class="status" id="status">
            <strong>状态：</strong> 准备测试...
        </div>
        
        <div class="ad-container" id="adContainer">
            <h3>广告位测试</h3>
            <p>点击下方按钮测试广告加载：</p>
            <button class="btn" onclick="testAdSense()">测试 AdSense 广告</button>
            <button class="btn" onclick="testFallback()">测试 Fallback 广告</button>
            <button class="btn" onclick="clearAds()">清除广告</button>
        </div>
        
        <div id="adDisplay"></div>
        
        <div class="status" id="log">
            <strong>日志：</strong>
            <div id="logContent"></div>
        </div>
    </div>

    <!-- 加载广告脚本 -->
    <script src="ad-config.js"></script>
    <script src="ads-manager.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = `<strong>状态：</strong> ${message}`;
        }
        
        function testAdSense() {
            log('开始测试 AdSense 广告...');
            updateStatus('测试 AdSense 广告中...', 'warning');
            
            if (!window.adManager) {
                log('错误：adManager 未初始化', 'error');
                updateStatus('adManager 未初始化', 'error');
                return;
            }
            
            // 设置同意状态
            localStorage.setItem('adsConsent', 'accepted');
            
            window.adManager.createVideoAd()
                .then(() => {
                    log('AdSense 广告创建成功', 'success');
                    updateStatus('AdSense 广告创建成功', 'success');
                })
                .catch(error => {
                    log(`AdSense 广告创建失败: ${error.message}`, 'error');
                    updateStatus('AdSense 广告创建失败，显示 Fallback', 'warning');
                    testFallback();
                });
        }
        
        function testFallback() {
            log('显示 Fallback 广告...');
            updateStatus('显示 Fallback 广告中...', 'warning');
            
            const adDisplay = document.getElementById('adDisplay');
            adDisplay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white;">
                    <div style="text-align: center; padding: 20px;">
                        <h2>🎯 品牌广告</h2>
                        <p>这是一个 30 秒的品牌广告</p>
                        <div id="countdown" style="font-size: 48px; font-weight: bold; color: #10b981; margin: 20px 0;">30</div>
                        <p>感谢您的耐心等待</p>
                    </div>
                </div>
            `;
            
            let count = 30;
            const countdown = document.getElementById('countdown');
            const timer = setInterval(() => {
                count--;
                countdown.textContent = count;
                if (count <= 0) {
                    clearInterval(timer);
                    adDisplay.innerHTML = '';
                    log('Fallback 广告播放完成', 'success');
                    updateStatus('Fallback 广告播放完成', 'success');
                }
            }, 1000);
        }
        
        function clearAds() {
            document.getElementById('adDisplay').innerHTML = '';
            log('广告已清除');
            updateStatus('广告已清除', 'info');
        }
        
        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            log('页面加载完成');
            
            // 等待 adManager 初始化
            const checkAdManager = () => {
                if (window.adManager) {
                    log('adManager 初始化成功');
                    updateStatus('adManager 初始化成功，可以开始测试', 'success');
                } else {
                    setTimeout(checkAdManager, 100);
                }
            };
            checkAdManager();
            
            // 检查 AdSense 脚本状态
            setTimeout(() => {
                if (typeof adsbygoogle !== 'undefined') {
                    log('AdSense 脚本加载成功');
                } else {
                    log('AdSense 脚本未加载（可能被拦截）', 'warning');
                }
            }, 2000);
        });
    </script>
</body>
</html>
