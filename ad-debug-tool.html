<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广告诊断工具 - Personality MBTI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .ad-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            text-align: center;
            background: #f8f9fa;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .config-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 广告诊断工具</h1>
        <p>这个工具用于诊断广告显示问题，帮助找出为什么广告没有显示。</p>
        
        <div class="test-section">
            <h3>📋 系统检查</h3>
            <button onclick="checkSystemStatus()">检查系统状态</button>
            <button onclick="checkAdConfig()">检查广告配置</button>
            <button onclick="checkConsentStatus()">检查同意状态</button>
            <button onclick="checkAdSenseScript()">检查 AdSense 脚本</button>
        </div>
        
        <div class="test-section">
            <h3>🧪 广告测试</h3>
            <button onclick="testVideoAd()">测试视频广告</button>
            <button onclick="testFallbackAd()">测试回退广告</button>
            <button onclick="testConsentBanner()">测试同意横幅</button>
            <button onclick="clearAllAds()">清除所有广告</button>
        </div>
        
        <div class="test-section">
            <h3>📊 配置信息</h3>
            <div id="configInfo" class="config-display">点击"检查广告配置"查看详细信息</div>
        </div>
        
        <div class="test-section">
            <h3>📱 广告显示区域</h3>
            <div id="adDisplayArea" class="ad-container">
                <p>广告将在这里显示</p>
            </div>
        </div>
        
        <div id="log"></div>
    </div>

    <!-- 广告脚本 -->
    <script src="ad-config.js"></script>
    <script src="ads-manager.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : 
                                 type === 'success' ? '#28a745' : 
                                 type === 'warning' ? '#ffc107' : '#6c757d';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function checkSystemStatus() {
            clearLog();
            log('🔍 开始系统状态检查...', 'info');
            
            // 检查基本对象
            log(`window.AD_CONFIG: ${typeof window.AD_CONFIG}`, 
                window.AD_CONFIG ? 'success' : 'error');
            log(`window.adManager: ${typeof window.adManager}`, 
                window.adManager ? 'success' : 'error');
            log(`window.adsbygoogle: ${typeof window.adsbygoogle}`, 
                window.adsbygoogle ? 'success' : 'error');
            
            // 检查广告拦截器
            if (window.adsbygoogle) {
                log('✅ AdSense 脚本已加载', 'success');
            } else {
                log('❌ AdSense 脚本未加载 - 可能被广告拦截器阻止', 'error');
            }
            
            // 检查配置
            if (window.AD_CONFIG) {
                log(`✅ 广告配置已加载 - 启用状态: ${window.AD_CONFIG.googleAdsense.enabled}`, 'success');
                log(`✅ 发布商ID: ${window.AD_CONFIG.googleAdsense.publisherId}`, 'success');
            } else {
                log('❌ 广告配置未加载', 'error');
            }
        }
        
        async function checkAdConfig() {
            log('🔍 检查广告配置...', 'info');
            
            if (!window.AD_CONFIG) {
                log('❌ AD_CONFIG 未定义', 'error');
                return;
            }
            
            const config = window.AD_CONFIG;
            const configInfo = document.getElementById('configInfo');
            
            let configText = `广告配置信息:\n`;
            configText += `启用状态: ${config.googleAdsense.enabled}\n`;
            configText += `发布商ID: ${config.googleAdsense.publisherId}\n`;
            configText += `广告策略:\n`;
            configText += `  - 允许跳过: ${config.adStrategy.allowSkip}\n`;
            configText += `  - 视频时长: ${config.adStrategy.videoAdDuration}秒\n`;
            configText += `  - 最小间隔: ${config.adStrategy.minInterval}秒\n`;
            configText += `广告位配置:\n`;
            
            Object.entries(config.googleAdsense.adSlots).forEach(([key, slot]) => {
                configText += `  - ${key}: ${slot.slotId} (${slot.format})\n`;
            });
            
            configInfo.textContent = configText;
            log('✅ 广告配置检查完成', 'success');
        }
        
        async function checkConsentStatus() {
            log('🔍 检查用户同意状态...', 'info');
            
            const consent = localStorage.getItem('adsConsent');
            log(`同意状态: ${consent || '未设置'}`, consent === 'accepted' ? 'success' : 'warning');
            
            if (consent !== 'accepted') {
                log('⚠️ 用户未同意广告，需要显示同意横幅', 'warning');
            } else {
                log('✅ 用户已同意广告', 'success');
            }
        }
        
        async function checkAdSenseScript() {
            log('🔍 检查 AdSense 脚本加载...', 'info');
            
            // 检查脚本是否在 DOM 中
            const scripts = document.querySelectorAll('script[src*="adsbygoogle"]');
            log(`找到 ${scripts.length} 个 AdSense 脚本标签`, scripts.length > 0 ? 'success' : 'error');
            
            scripts.forEach((script, index) => {
                log(`脚本 ${index + 1}: ${script.src}`, 'info');
            });
            
            // 检查 adsbygoogle 对象
            if (window.adsbygoogle) {
                log('✅ adsbygoogle 对象可用', 'success');
                log(`adsbygoogle.push 方法: ${typeof window.adsbygoogle.push}`, 'info');
            } else {
                log('❌ adsbygoogle 对象不可用', 'error');
            }
        }
        
        async function testVideoAd() {
            log('🧪 测试视频广告...', 'info');
            
            if (!window.adManager) {
                log('❌ adManager 未初始化', 'error');
                return;
            }
            
            try {
                log('开始创建视频广告...', 'info');
                await window.adManager.createVideoAd();
                log('✅ 视频广告创建成功', 'success');
            } catch (error) {
                log(`❌ 视频广告创建失败: ${error.message}`, 'error');
            }
        }
        
        async function testFallbackAd() {
            log('🧪 测试回退广告...', 'info');
            
            if (!window.adManager) {
                log('❌ adManager 未初始化', 'error');
                return;
            }
            
            try {
                log('开始创建回退广告...', 'info');
                window.adManager.showFallbackInterstitial(() => {
                    log('✅ 回退广告显示成功', 'success');
                });
            } catch (error) {
                log(`❌ 回退广告创建失败: ${error.message}`, 'error');
            }
        }
        
        async function testConsentBanner() {
            log('🧪 测试同意横幅...', 'info');
            
            if (!window.adManager) {
                log('❌ adManager 未初始化', 'error');
                return;
            }
            
            try {
                log('开始创建同意横幅...', 'info');
                window.adManager.setupConsent();
                log('✅ 同意横幅创建成功', 'success');
            } catch (error) {
                log(`❌ 同意横幅创建失败: ${error.message}`, 'error');
            }
        }
        
        function clearAllAds() {
            log('🗑️ 清除所有广告...', 'info');
            
            // 清除所有广告覆盖层
            const overlays = document.querySelectorAll('[id*="ad"], [id*="overlay"]');
            overlays.forEach(overlay => {
                if (overlay.id !== 'adDisplayArea') {
                    overlay.remove();
                    log(`已清除: ${overlay.id}`, 'info');
                }
            });
            
            // 清除同意横幅
            const consentBanner = document.getElementById('consent-banner');
            if (consentBanner) {
                consentBanner.remove();
                log('已清除同意横幅', 'info');
            }
            
            log('✅ 所有广告已清除', 'success');
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('页面加载完成，开始自动检查...', 'info');
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });
    </script>
</body>
</html>
